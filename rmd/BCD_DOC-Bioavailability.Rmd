---
title: "BCD and DOC Bioavailability"
author: "Nicholas Baetge"
date: "5/26/2020"
output: github_document
---

# Intro

This document shows plots and tables of the merged field-experiment NAAMES DOC data.

```{r Packages, message = F, warning = F}
library(tidyverse) 
library(patchwork)
library(zoo)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
library(blandr)
```


```{r Aesthetics, include = FALSE}
custom_theme <- function() {
  theme_test(base_size = 16) %+replace%
    theme(legend.position = "top",
          #legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}


custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "A" = "#E41A1C", "B" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A" ) 

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )

levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn", "Late Autumn", "Control", "Parallel","A", "B")
```

# Import Data

```{r Import processed data}

export <- readRDS("~/GITHUB/naames_bioav_ms/Input/master/processed_export_for_bioavMS.6.7.20.rds") %>% 
  select(Season, Cruise, degree_bin, Station, int_delta_DOC_100, NCP_mol_100, doc_ncp_100) %>% 
  distinct()

export_bioav <- readRDS("~/GITHUB/naames_bioav_ms/Output/processed_DOC_bioavailability.rds") 

doc_og <- read_rds("~/GITHUB/naames_bioav_ms/Input/master/DOC_Input") %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  drop_na(doc) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, Bottle, stationary.harvest)) %>% 
  select(Season, Cruise, Station, Bottle, stationary.harvest, Hours, doc) %>% 
  mutate(Days = Hours/24) %>% 
  filter(Station == 4) %>% 
  group_by(Season, Cruise, Station, Days, stationary.harvest) %>% 
  summarise_at(vars(doc), list(mean = mean, sd = sd)) %>%
  ungroup() %>% 
  mutate(increase = 56.2 - 53.4,
         per_increase = increase / 53.4 * 100)

bge <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_bge.rds") %>% 
  mutate(doc_star = ifelse(Cruise != "AT34" & Hours < stationary.harvest, round(interp_ptoc - i.poc,1), round(interp_ptoc - s.poc,1)),
         combined_doc = ifelse(Cruise == "AT34", interp_doc, doc_star),
          sd_combined_doc = ifelse(Cruise == "AT34", sd_doc, sd_ptoc)) %>% 
  group_by(Cruise, Station, Treatment, Bottle) %>% 
  mutate(remin.end = last(Days),
         stationary.harvest = stationary.harvest/24) %>%
  ungroup() %>% 
  group_by(Cruise, Station, Treatment, Hours) %>% 
  mutate(trt_combined_doc = ifelse(!is.na(sd_combined_doc), round(mean(combined_doc, na.rm = T), 1), NA),
         sd_trt_combined_doc = ifelse(!is.na(sd_combined_doc), round(sd(combined_doc, na.rm = T), 1), NA)) %>% 
  ungroup() %>% 
  group_by(Season, Station, Treatment) %>% 
  mutate(norm_doc =  round(trt_combined_doc - first(trt_combined_doc), 1),
         sd_norm_doc = ifelse(Hours != 0,  sd_trt_combined_doc, NA),
         norm_cells = station_cells - first(station_cells),
         sd_norm_cells = ifelse(Hours != 0, sd_station_cells, NA)) %>% 
  ungroup() %>% 
  select(Season:stationary.harvest, remin.end, Hours:sd_station_cells, norm_cells, sd_norm_cells, everything()) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, degree_bin) %>% distinct()) %>% 
  mutate(degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>% 
  select(Season:Station, degree_bin, everything())

bge_summary <- read_rds("~/GITHUB/naames_bioav_ms/Output/bge_summary.rds") %>% 
  left_join(., read_rds("~/GITHUB/naames_bioav_ms/Output/bge_cruise_means.rds") %>% select(Season, Cruise, bge_mean) %>% rename(cruise_bge = bge_mean)) %>% 
  left_join(., read_rds("~/GITHUB/naames_bioav_ms/Output/bge_station_means.rds") %>% select(Season, Cruise, Station, bge_mean) %>% rename(station_bge = bge_mean)) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, degree_bin) %>% distinct()) %>% 
  mutate(degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>% 
  select(Season:Station, degree_bin, everything())

bcd <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_BCD.rds") 

lat44 <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_lat44_remins.rds") %>% 
  drop_na(sd_combined_doc) %>% 
  mutate(station_line = ifelse(Cruise == "AT39" & Station == 4, "ab", "a"))

```

Units for imported data frames are currently: 

- BP, µmol C m^-3^ d^-1^
- BCD, µmol C m^-3^ d^-1^ 
- BA, cells m^-3^
- NPP, µmol C m^-3^ d^-1^
- ∆DOC and NCP (from export MS, integrated to Ez), mol C m^-2^

NPP, NCP and BCD are converted to: mmol C m^-3^ d^-1^



# Bottle v. Vial Incubation Comparisons

We will run the Bland-Altman method (aka Tukey mean-difference) for assessing agreement between two methods (in this case, vial and bottle measurements/doc star and filtered doc).  The Bland-Altman plot is a scatter plot in which the difference between the paired measurements (A-B) is plotted against their mean value [(A+B)/2]. The graph provides two main pieces of information, namely the average of all the differences, which is also provided by the t test and which is often called the bias, and the 95% limits of agreement. 

We'll also do a lmodel2 regression.

### DOC filtered v . DOC*

```{r doc star stats}

vessel_comparisons <- bge %>% 
  select(Season, Cruise, Station, Bottle, Hours, Days,  cells, p_cells, ptoc,  toc, doc, pdoc, doc_star) 

doc_doc.star <- vessel_comparisons %>% 
  drop_na(doc) %>% 
  drop_na(doc_star)

doc_doc.star.reg <- lmodel2(doc_star ~ doc, data = doc_doc.star, nperm = 99) #filtered DOC (from bottles) v DOC star

doc_doc.star.blandr <- blandr.statistics(doc_doc.star$doc, doc_doc.star$doc_star, sig.level = 0.95)

doc_doc.star.blandr$bias
```
```{r}
doc_doc.star.blandr$upperLOA
```
```{r}
doc_doc.star.blandr$lowerLOA
```

```{r doc star blandr plot, echo = FALSE, warning = FALSE, message = FALSE}
doc_doc.star.blandr.plot <- vessel_comparisons %>% 
  drop_na(doc_star) %>% 
  mutate(diff = doc - doc_star,
         mean = (doc + doc_star) / 2) %>% 
  ggplot(., aes(x = mean, y = diff)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = doc_doc.star.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = doc_doc.star.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = doc_doc.star.blandr$lowerLOA, size = 1, linetype = 3) +
   geom_point(aes(fill = factor(Season, levels = levels)), color = "black",  shape = 21, size = 4, alpha = 0.7) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(italic(paste("Difference: DOC - DOC*, µmol C L"^-1))), x = expression(italic(paste("Mean: (DOC + DOC*) / 2, µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(fill = F)
```


```{r doc star lmodel2 plot, echo = FALSE, warning = FALSE, message = FALSE}

doc_doc.star.reg.plot <- vessel_comparisons %>% 
  drop_na(doc_star) %>% 
  ggplot(aes(x = doc, y = doc_star)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = doc_doc.star.reg$regression.results[3,2],
              slope = doc_doc.star.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(y = expression(italic(paste("DOC*, µmol C L"^-1))), x = expression(italic(paste("DOC, µmol C L"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
   annotate( geom = "text", label = expression(atop("y = 0.90x + 4.35", paste("r"^2,"= 0.83, ", italic("p "), "<< 0.01"))), x = 78, y = 51, size = 3) +
  xlim(50, 80) +
  ylim(50, 80)


```

```{r combine doc star plots, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
doc_doc.star.reg.plot + doc_doc.star.blandr.plot +
  plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))
```

### PDOC  v DOC bottle

```{r filtered doc stats}
vessel_doc <- vessel_comparisons %>% 
  drop_na(pdoc)

vessel_doc.reg <- lmodel2(pdoc ~ doc, data = vessel_comparisons, nperm = 99) #vial v bottle DOC (both filtered)


vessel_doc.blandr <- blandr.statistics(vessel_comparisons$doc, vessel_comparisons$pdoc, sig.level = 0.95)

vessel_doc.blandr$bias

```

```{r}
vessel_doc.blandr$upperLOA
```

```{r}
vessel_doc.blandr$lowerLOA
```

```{r filtered doc blandr plot}
vl_btl_doc_blandr <- vessel_doc %>% 
  mutate(diff = doc - pdoc,
         mean = (doc + pdoc) / 2) %>% 
  ggplot(., aes(x = mean, y = diff, group = Bottle)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = vessel_doc.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = vessel_doc.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = vessel_doc.blandr$lowerLOA, size = 1, linetype = 3) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(y = expression(italic(paste("Difference: Bottle DOC - Vial DOC, µmol C L"^-1))), x = expression(italic(paste("Mean: (Bottle DOC + Vial DOC) / 2, µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(fill = F)
```

```{r filtered doc lmodel2 plot}
vl_btl_doc <- vessel_doc %>% 
  ggplot(aes(x = doc, y = pdoc, group = Bottle)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = vessel_doc.reg$regression.results[3,2],
              slope = vessel_doc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Bottle DOC, µmol C L"^-1))), y = expression(italic(paste("Vial DOC, µmol C L"^-1))), fill = "Early Spring Station") +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
   annotate( geom = "text", label = expression(atop("y = 1.02x - 1.44", paste("r"^2,"= 0.96, ", italic("p "), "<< 0.01"))), x = 80, y = 51, size = 3) +
  xlim(50, 85) +
  ylim(50, 85) +
  guides(fill = F)
```

### Bottle v. Vial Cell Abundance

```{r vessel cell regression}
vessel_cells.reg <- lmodel2(p_cells ~ cells, data = vessel_comparisons, nperm = 99) #vial v bottle DOC (both filtered)

vessel_cells.blandr <- blandr.statistics(vessel_comparisons$cells, vessel_comparisons$p_cells, sig.level = 0.95)

vessel_cells.blandr$bias
```
```{r}
vessel_cells.blandr$upperLOA
```
```{r}
vessel_cells.blandr$lowerLOA
```

```{r filtered cell blandr plot}
vl_btl_cell_blandr <- vessel_comparisons %>% 
  drop_na(p_cells) %>% 
  mutate(diff = cells - p_cells,
         mean = (cells + p_cells) / 2) %>% 
  ggplot(., aes(x = mean, y = diff, group = Bottle)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = vessel_cells.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = vessel_cells.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = vessel_cells.blandr$lowerLOA, size = 1, linetype = 3) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(y = expression(italic(paste("Difference: Bottle Cells - Vial Cells, L"^-1))), x = expression(italic(paste("Mean: (Bottle Cells + Vial Cells) / 2, L"^-1)))) +
  theme_classic2(base_size = 16) 
```


```{r vessel cell plot}
vl_btl_cell <- vessel_comparisons %>% 
  drop_na(p_cells) %>% 
  ggplot(aes(x = cells, y = p_cells)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = vessel_cells.reg$regression.results[3,2],
              slope = vessel_cells.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
 geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Bottle Cells L"^-1))), y = expression(italic(paste("Vial Cells L"^-1))), fill = "NAAMES 4 Station") +
  guides(fill = F) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  annotate( geom = "text", label = expression(atop("y = 1.07x - 8.72 * 10"^7, paste("r"^2,"= 0.96, ", italic("p "), "<< 0.01"))), x = 2.6E9, y = 5.0E8, size = 3) +
  #theme(plot.caption = element_text(face = "italic")) +
  ylim(4.5*10^8, 3.0*10^9) +
  xlim(4.5*10^8, 3.0*10^9)

```


```{r combine regression plots, fig.height=12, fig.width=16, message=FALSE, warning=FALSE}
vl_btl_cell + vl_btl_cell_blandr + vl_btl_doc + vl_btl_doc_blandr +
  plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))
```

# N2 Post-Cruise contamination

```{r}
unique(doc_og$increase)
```

```{r}
unique(doc_og$per_increase)
```


```{r N2 remin plot, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8}

doc_og %>% 
  ggplot(aes(x = Days, y = mean)) + 
  geom_vline(aes(xintercept = 26), linetype = 2) +
  geom_label(aes(x = 26, y = 52, label = "Cruise End"), size = 3) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_label(aes(x = 7, y = 52, label = "Large Volume Collection"), size = 3) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("Days")), y = expression(italic(paste("DOC, µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, fill = F) 

  
```


# Curves

## Cells

```{r incubation delta cells, message=FALSE, warning=FALSE}
ba_curves <- bge %>% 
  filter(Treatment == "Control") %>% 
  drop_na(norm_cells) %>% 
  # filter(!Cruise == "AT34" | !Station == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_cells, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_cells - sd_norm_cells, ymax = norm_cells + sd_norm_cells, color = factor(Season, levels = levels)), width = 0.3, alpha = 0.4) +
  geom_line(aes(color = factor(Season, levels = levels), linetype = Station), alpha = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), shape = 21, alpha = 0.5) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("Days")), y = expression(italic(paste("∆ Cells, L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F, fill = F)
```
## DOC

```{r incubation delta cells, message=FALSE, warning=FALSE}
doc_curves <-  bge %>% 
  filter(Treatment == "Control") %>% 
  drop_na(sd_combined_doc) %>% 
  # filter(!Cruise == "AT34" | !Station == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_doc - sd_norm_doc, ymax = norm_doc + sd_norm_doc, color = factor(Season, levels = levels)), width = 0.3, alpha = 0.4) +
  geom_line(aes(color = factor(Season, levels = levels), linetype = Station), alpha = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), shape = 21, alpha = 0.5) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("Days")), y = expression(italic(paste("∆ DOC, µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F)
```


```{r fig.height=6, fig.width=13, message=FALSE, warning=FALSE}
ba_curves | doc_curves + 
  plot_layout(guides = "collect", tag_level = "new") &
  theme(plot.tag = element_text(size = 14)) 
```

# BGE

```{r message=FALSE, warning=FALSE}
my_comparisons <- list( c("Early Spring", "Late Spring"), c("Early Spring", "Early Autumn"), c("Early Spring", "Late Autumn"), c("Late Spring", "Early Autumn"), c("Late Spring", "Late Autumn"), c("Early Autumn", "Late Autumn"))

bge <- bge_summary %>% 
  drop_na(bge) %>% 
  ggboxplot(., x = "Season", y = "bge", 
            order = c("Early Spring", "Late Spring", "Early Autumn", "Late Autumn"),
            xlab = F,
            ylab = expression(italic("BGE")),
            add = "jitter",
            add.params = list(shape = 21, fill = "Station"), 
            outlier.shape = NA,
            width = 0.5,
            ggtheme = theme_classic2(base_size = 16)) + 
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.signif",
                     step.increase = 0.12,
                     tip.length = 0.01) + 
  stat_compare_means(label.y = 0.1)  + 
  rremove("legend")
  
```

```{r message=FALSE, warning=FALSE}
resp <- bge_summary %>% 
  drop_na(cell_resp) %>% 
  ggboxplot(., x = "Season", y = "cell_resp", 
            order = c("Early Spring", "Late Spring", "Early Autumn", "Late Autumn"),
            xlab = F,
            ylab = expression(italic("Cell Specific Respiration, fmol C L"^-1)),
            add = "jitter",
            add.params = list(shape = 21, fill = "Station"), 
            outlier.shape = NA,
            width = 0.5,
            ggtheme = theme_classic2(base_size = 16)) + 
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.signif",
                     step.increase = 0.12,
                     tip.length = 0.01) + 
  stat_compare_means(label.y = 0.1) 
  

```

```{r fig.height=6, fig.width=13, message=FALSE, warning=FALSE}
bge | resp + 
  plot_layout(guides = "collect", tag_level = "new") &
  theme(plot.tag = element_text(size = 14)) 
```



# Experiments at 44˚N

```{r Remin plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 16, fig.width = 8}

doc44a <- lat44 %>% 
  ggplot(aes(x = Days, y = norm.doc, group = interaction(Cruise, Station, Bottle))) + 
  geom_errorbar(aes(ymin = norm.doc - sd_combined_doc, ymax = norm.doc + sd_combined_doc, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("")), y = expression(italic(paste("DOC"[SA],", µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F) 
  
doc44b <- lat44 %>% 
  group_by(Cruise, Station, Hours) %>% 
  mutate(ave_del.bioav.doc = mean(del.bioav.doc),
         sd_del.bioav.doc = sd(del.bioav.doc)) %>% 
  ungroup() %>% 
  select(Season, Cruise, Station, Days, ave_del.bioav.doc, sd_del.bioav.doc, station_line) %>% distinct() %>% 
  ggplot(aes(x = Days, y = ave_del.bioav.doc , group = interaction(Cruise, Station))) + 
  geom_errorbar(aes(ymin = ave_del.bioav.doc - sd_del.bioav.doc, ymax = ave_del.bioav.doc + sd_del.bioav.doc, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("")), y = expression(italic(paste("Bioavailable DOC"[SA],", µmol C L"^-1)))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F, fill = F)

doc44c <- lat44 %>% 
  group_by(Cruise, Station, Hours) %>% 
  mutate(ave_per.pers.doc = mean(per.pers.doc),
         sd_per.pers.doc = sd(per.pers.doc)) %>% 
  ungroup() %>% 
  select(Season, Cruise, Station, Days, ave_per.pers.doc, sd_per.pers.doc, station_line) %>% distinct() %>% 
  ggplot(aes(x = Days, y = ave_per.pers.doc, group = interaction(Cruise, Station))) + 
  geom_errorbar(aes(ymin = ave_per.pers.doc - sd_per.pers.doc, ymax = ave_per.pers.doc + sd_per.pers.doc, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression(italic("Days")), y = expression(italic(paste("% DOC"[SA]," Remaining")))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F, fill = F)


doc44a / doc44b / doc44c + 
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
  
```

# Bioavailability Tables

```{r Bioavailability tables}

bioav.table.data <- export_bioav %>% 
  select(Cruise:Station, degree_bin, end.remin, stationary.harvest, initial.doc:longterm.ddoc) %>% 
  distinct() %>% 
  group_by(Season, Cruise, Station, degree_bin)

bioav.table <- bioav.table.data %>% 
  summarise_at(vars(initial.doc:longterm.ddoc), list(mean = mean, sd = sd), na.rm = T) %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  select(Season:degree_bin, contains(c("accm.doc", "shortterm.bioav.doc", "shortterm.ddoc", "longterm.del.doc",  "longterm.bioav.doc", "longterm.ddoc",  "persis") ))

bioav.table.summary <- bioav.table %>% 
  ungroup() %>% 
  group_by(Season) %>% 
  summarise_at(vars(contains("mean")), list(season.ave = mean, sd.season = sd), na.rm = T) %>% 
  arrange(factor(Season, levels = levels))

```

# Box plots: NPP, BP, BA, µ


```{r Rate & abundance boxplots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 12, fig.width = 12}
my_comparisons <- list( c("Early Spring", "Late Spring"), c("Early Spring", "Early Autumn"), c("Early Spring", "Late Autumn"), c("Late Spring", "Early Autumn"), c("Late Spring", "Late Autumn"), c("Early Autumn", "Late Autumn")) 

#npp
npp.boxplot <- bcd %>% 
  select(Season,  int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  ggboxplot(., x = "Season", y = "int.NPP", 
            order = c("Early Spring", "Late Spring", "Early Autumn", "Late Autumn"),
            xlab = F, 
            ylab = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))),
            add = "jitter",
            outlier.shape = NA,
            width = 0.5,
            ggtheme = theme_classic2(base_size = 16)) + 
  rremove("x.text") +
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.signif",
                     step.increase = 0.11,
                     tip.length = 0.01) +
  stat_compare_means(label.y = 0)

#bp
bp.boxplot <- bcd %>% 
  select(Season,  int.bp) %>% 
  mutate_at(vars(contains("bp")), funs(./10^3)) %>% 
  distinct() %>% 
  ggboxplot(., x = "Season", y = "int.bp", 
            order = c("Early Spring", "Late Spring", "Early Autumn", "Late Autumn"),
            xlab = F,
            ylab = expression(italic(paste("BP, mmol C m"^-3, "d"^-1))),
            add = "jitter",
            outlier.shape = NA,
            width = 0.5,
            ggtheme = theme_classic2(base_size = 16)) + 
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.signif",
                     step.increase = 0.12,
                     tip.length = 0.01) + 
  stat_compare_means(label.y = 0) 

#ba
ba.boxplot <- bcd %>% 
  select(Season,  int.ba) %>% 
  distinct() %>% 
  ggboxplot(., x = "Season", y = "int.ba", 
            order = c("Early Spring", "Late Spring", "Early Autumn", "Late Autumn"),
            xlab = F, 
            ylab = expression(italic(paste("BA, cells m"^-3))),
            add = "jitter",
            outlier.shape = NA,
            width = 0.5,
            ggtheme = theme_classic2(base_size = 16)) +
  rremove("x.text") +
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.signif",
                     step.increase = 0.12,
                     tip.length = 0.01) + 
  stat_compare_means(label.y = 0) 

```


```{r patchwork rate & abundance plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 12, fig.align = "center"}

patchwork <- npp.boxplot / bp.boxplot | ba.boxplot 
patchwork +  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))

```

# Bar plots: BCD and BCD:NPP

Convert BCD and NPP to mmol C m^-3^ d^-1^  

```{r Summarize BCD and NPP data}
bcd.data <- bcd %>% 
  select(Season, Cruise:degree_bin, int.bcd, int.bp, int.NPP, bp.npp, bcd.npp) %>% 
  distinct() %>% 
  mutate_at(vars(int.bcd, int.bp, int.NPP), funs(./10^3)) %>% 
  mutate_at(vars(bp.npp, bcd.npp), funs(./10^2)) %>% 
  mutate(degree_bin = as.character(degree_bin)) 

bcd.summary <- bcd.data %>% 
  group_by(Season, Cruise, degree_bin) %>% 
  summarise_at(vars(int.bcd, int.bp, int.NPP, bp.npp, bcd.npp), list(mean = mean, sd = sd)) %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  select(Season:degree_bin, contains(c("int.NPP", "int.bp", "bp.npp", "int.bcd", "bcd.npp")))
  
bcd.cruise.summary <- bcd.data %>% 
  group_by(Season, Cruise) %>% 
  summarise_at(vars(int.bcd, int.bp, int.NPP, bp.npp, bcd.npp), list(cruise_mean = mean, cruise_sd = sd, cruise_max = max, cruise_min = min)) %>% 
  arrange(factor(Season, levels = levels)) %>% 
  select(Season, contains(c("int.NPP", "int.bp", "bp.npp", "int.bcd", "bcd.npp")))

bcd.overall.summary <- bcd.data %>% 
  summarise_at(vars(int.bcd, int.bp, int.NPP, bp.npp, bcd.npp), list(overall_mean = mean, overall_sd = sd, max = max, min = min))

bcd.npp.summary <- bcd.summary %>% 
  select(Season, Cruise, degree_bin, int.NPP_mean, int.bcd_mean) %>% 
  rename(NPP = int.NPP_mean,
         BCD = int.bcd_mean) %>% 
  pivot_longer(c(NPP, BCD), names_to = "rate", values_to = "ave") %>% 
  left_join(., bcd.summary %>% 
  select(Season, Cruise, degree_bin, int.NPP_sd, int.bcd_sd) %>% 
    rename(NPP = int.NPP_sd,
         BCD = int.bcd_sd) %>% 
  pivot_longer(c(NPP, BCD), names_to = "rate", values_to = "sd"))

bcd.npp_summary_table <- left_join(bcd.summary, bcd.cruise.summary)

export_bar <- export %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
  group_by(Season, Cruise, degree_bin) %>% 
  summarise_at(vars(int_delta_DOC_100, doc_ncp_100, NCP_mol_100), list(mean = mean, sd = sd)) %>% 
  arrange(factor(Season, levels = levels), degree_bin)

  
```

```{r Field DOC table}
field.doc_table <- export_bioav %>% 
  select(Cruise, Season, accm.doc) %>% 
  drop_na(accm.doc) %>% 
  group_by(Cruise, Season) %>% 
  summarise_at(vars(accm.doc), list(mean = mean, sd = sd))

field.doc_table
```


```{r BCD and NPP bar plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 12}


bcd.bar <- bcd.summary %>% 
  ggplot(aes(x = degree_bin, y = int.bcd_mean, group = interaction(Season, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
   geom_errorbar(aes(ymin = int.bcd_mean - int.bcd_sd, ymax = int.bcd_mean + int.bcd_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 

bcd.npp.bar <- bcd.npp.summary  %>% 
  ggplot(aes(x = degree_bin, fill = factor(rate, levels = c("NPP", "BCD")), y =  ave, group = interaction(Season, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  theme(legend.position = "right",
        legend.title = element_blank()) 

ratio.bar <- bcd.summary %>% 
  ggplot(aes(x = degree_bin, y = bcd.npp_mean, group = interaction(Season, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1,  fill = "#999999") +
  geom_errorbar(aes(ymin = bcd.npp_mean - bcd.npp_sd, ymax = bcd.npp_mean + bcd.npp_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("BCD:NPP"))), colour = expression(italic(""))) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank())


doc_sa.bar <-  export_bar %>% 
  ggplot(aes(x = degree_bin, y = int_delta_DOC_100_mean, group = interaction(Season, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#999999") +
   geom_errorbar(aes(ymin = int_delta_DOC_100_mean - int_delta_DOC_100_sd, ymax = int_delta_DOC_100_mean + int_delta_DOC_100_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("DOC"[SA],", mol C m"^-3))), colour = expression(italic(""))) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 

  
doc_sa.bar / bcd.bar / bcd.npp.bar / ratio.bar  +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
```



# Regressions: Property-Property 

## BCD v NPP

```{r Model 2 regression, echo = FALSE}
reg1 <- lmodel2(int.bcd ~ int.NPP, data = bcd.data, nperm = 99)
```

## BCD:NPP v NPP

### exponential model using lm function

```{r Exponential model}
reg2 <- lm(log(bcd.npp) ~ int.NPP, data = bcd.data)

reg2.df <- data.frame(x = bcd.data$int.NPP, y = exp(fitted(reg2)))
```


### manual exponential model 

y = alpha * (e^beta * x) + theta

```{r Parameterize model, echo = FALSE}

# Select an approximate $\theta$, since theta must be lower than min(y), and greater than zero
theta.0 <- min(bcd.data$bcd.npp) * 0.5  

# Estimate the rest parameters using a linear model
model.0 <- lm(log(bcd.npp - theta.0) ~ int.NPP, data = bcd.data)  
alpha.0 <- exp(coef(model.0)[1])
beta.0 <- coef(model.0)[2]

# Starting parameters
start <- list(alpha = alpha.0, beta = beta.0, theta = theta.0)
start
```

```{r Nonlinear model}
model <- nls(bcd.npp ~ alpha * exp(beta * int.NPP) + theta , data = bcd.data, start = start)

model.df <- data.frame(x = bcd.data$int.NPP, y = predict(model, list(x = bcd.data$int.NPP)) )

summary(model)
```


## Plots

```{r BCD and NPP regression plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 8}
reg1.plot <- bcd.data %>% 
  ggplot(aes(x = int.NPP, y = int.bcd)) + 
  geom_abline(intercept = reg1$regression.results[3,2],
              slope = reg1$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
   geom_abline(intercept = reg1$confidence.intervals[3,2],
              slope = reg1$confidence.intervals[3,4],colour = "grey", linetype = 3, size = 1) +
  geom_abline(intercept = reg1$confidence.intervals[3,3],
              slope = reg1$confidence.intervals[3,5],colour = "grey", linetype = 3, size = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste(""))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.23x + 0.01", paste("r"^2," = 0.70, ", italic("p "), "<< 0.01"))), x = 3.1, y = 0.08, size = 4) 
  

reg2.plot <- bcd.data %>% 
  ggplot(aes(x = int.NPP, y = bcd.npp)) + 
  # geom_abline(intercept = reg2$regression.results[3,2],
  #             slope = reg2$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_line(data = model.df, aes(x,y), size = 1, linetype = 2 ) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("BCD:NPP")))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, fill = F) +
  annotate( geom = "text", label = expression(paste("y = 0.28", "e"^{-0.33 * "x"}, " + 0.04")), x = 3, y = 0.11, size = 4) +
  annotate( geom = "text", label = expression(paste("rse = 0.1; dof = 31")), x = 3, y = 0.08, size = 4) 


(reg1.plot) / (reg2.plot) + plot_annotation(tag_levels = "a")

```





---
title: "BCD and DOC Bioavailability"
author: "Nicholas Baetge"
date: "5/26/2020"
output: github_document
---

# Intro

This document shows plots and tables of the merged field-experiment NAAMES DOC data.

```{r Packages, message = F, warning = F}
library(tidyverse) 
library(patchwork)
library(zoo)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
library(blandr)


```


```{r Aesthetics, include = FALSE}
custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "Early Winter" = "#FF7F00" ,"A" = "#E41A1C", "B" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A", "BP" = "#E41A1C") 

matlab.colors <- c("#A50026", "#D73027", "#F46D43", "#FDAE61",  "#ABD9E9", "#74ADD1", "#4575B4", "#313695")

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23, "Early Winter" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )

levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn", "Late Autumn", "Early Winter", "Control", "Parallel","A", "B")
```

# Import Data

```{r Import processed data}

export <- readRDS("~/GITHUB/naames_bioav_ms/Input/master/processed_export_for_bioavMS.6.7.20.rds") %>% 
  select(Season, Cruise, degree_bin, Station, Max_MLD, int_delta_DOC_100, NCP_mol_100, doc_ncp_100) %>% 
  distinct() %>% 
  mutate(Season = ifelse(Season == "Late Autumn", "Early Winter", Season))

export_bioav <- readRDS("~/GITHUB/naames_bioav_ms/Output/processed_DOC_bioavailability.rds") 

doc_og <- read_rds("~/GITHUB/naames_bioav_ms/Input/master/DOC_Input") %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  drop_na(doc) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, Bottle, stationary.harvest)) %>% 
  select(Season, Cruise, Station, Bottle, stationary.harvest, Hours, doc) %>% 
  mutate(Days = Hours/24) %>% 
  filter(Station == 4) %>% 
  group_by(Season, Cruise, Station, Days, stationary.harvest) %>% 
  summarise_at(vars(doc), list(mean = mean, sd = sd)) %>%
  ungroup() %>% 
  mutate(increase = 56.2 - 53.4,
         per_increase = increase / 53.4 * 100) 

bge <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_bge.rds") %>% 
  mutate(doc_star = ifelse(Cruise != "AT34" & Hours < stationary.harvest, round(interp_ptoc - i.poc,1), round(interp_ptoc - s.poc,1)),
         combined_doc = ifelse(Cruise == "AT34", interp_doc, doc_star),
          sd_combined_doc = ifelse(Cruise == "AT34", sd_doc, sd_ptoc)) %>% 
  group_by(Cruise, Station, Treatment, Bottle) %>% 
  mutate(remin.end = last(Days),
         stationary.harvest = stationary.harvest/24) %>%
  ungroup() %>% 
  group_by(Cruise, Station, Treatment, Hours) %>% 
  mutate(trt_combined_doc = ifelse(!is.na(sd_combined_doc), round(mean(combined_doc, na.rm = T), 1), NA),
         sd_trt_combined_doc = ifelse(!is.na(sd_combined_doc), round(sd(combined_doc, na.rm = T), 1), NA),
         
         trt_doc_toc = ifelse(Cruise == "AT34", round(mean(interp_doc, na.rm = T), 1), round(mean(interp_ptoc, na.rm = T))),
         sd_trt_doc_toc = ifelse(Cruise == "AT34", round(sd(interp_doc, na.rm = T), 1), round(sd(interp_ptoc, na.rm = T)))
         ) %>% 
  ungroup() %>% 
  group_by(Season, Station, Treatment) %>% 
  mutate(norm_doc =  round(trt_combined_doc - first(trt_combined_doc), 1),
         sd_norm_doc = ifelse(Hours != 0,  sd_trt_combined_doc, NA),
         norm_doc_toc =  round(trt_doc_toc - first(trt_doc_toc), 1),
         sd_norm_doc_toc = ifelse(Hours != 0,  sd_trt_doc_toc, NA),
         
         norm_cells = station_cells - first(station_cells),
         sd_norm_cells = ifelse(Hours != 0, sd_station_cells, NA)) %>% 
  ungroup() %>% 
  select(Season:stationary.harvest, remin.end, Hours:sd_station_cells, norm_cells, sd_norm_cells, everything()) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, degree_bin) %>% distinct()) %>% 
  mutate(degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>% 
  select(Season:Station, degree_bin, everything()) %>% 
  mutate(Season = ifelse(Season == "Late Autumn", "Early Winter", Season))

bge_summary <- read_rds("~/GITHUB/naames_bioav_ms/Output/bge_summary.rds") %>% 
  left_join(., read_rds("~/GITHUB/naames_bioav_ms/Output/bge_cruise_means.rds") %>% select(Season, Cruise, bge_mean) %>% rename(cruise_bge = bge_mean)) %>% 
  left_join(., read_rds("~/GITHUB/naames_bioav_ms/Output/bge_station_means.rds") %>% select(Season, Cruise, Station, bge_mean) %>% rename(station_bge = bge_mean)) %>% 
  left_join(., export_bioav %>% select(Season, Cruise, Station, degree_bin) %>% distinct()) %>% 
  mutate(degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>% 
  select(Season:Station, degree_bin, everything()) %>% 
  mutate(Season = ifelse(Season == "Late Autumn", "Early Winter", Season)) 

bcd <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_BCD_4_2021.rds") %>% 
  mutate(Season = ifelse(Season == "Late Autumn", "Early Winter", Season))

lat44 <- read_rds("~/GITHUB/naames_bioav_ms/Output/processed_lat44_remins.rds") %>% 
  drop_na(sd_combined_doc) %>% 
  mutate(station_line = ifelse(Cruise == "AT39" & Station == 4, "ab", "a")) %>% 
  mutate(Season = ifelse(Season == "Late Autumn", "Early Winter", Season))

```

Units for imported data frames are currently: 

- BP, µmol C m^-3^ d^-1^
- BCD, µmol C m^-3^ d^-1^ 
- BA, cells m^-3^
- NPP, µmol C m^-3^ d^-1^
- ∆DOC and NCP (from export MS, integrated to Ez), mol C m^-2^

NPP, NCP and BCD are converted to: mmol C m^-3^ d^-1^



# Bottle v. Vial Incubation Comparisons

We will run the Bland-Altman method (aka Tukey mean-difference) for assessing agreement between two methods (in this case, vial and bottle measurements/doc star and filtered doc).  The Bland-Altman plot is a scatter plot in which the difference between the paired measurements (A-B) is plotted against their mean value [(A+B)/2]. The graph provides two main pieces of information, namely the average of all the differences, which is also provided by the t test and which is often called the bias, and the 95% limits of agreement. 

We'll also do a lmodel2 regression.

### DOC filtered v . DOC*

```{r doc star stats}

vessel_comparisons <- bge %>% 
  select(Season, Cruise, Station, degree_bin, Bottle, Hours, Days,  cells, p_cells, ptoc,  toc, doc, pdoc, doc_star) 

doc_doc.star <- vessel_comparisons %>% 
  drop_na(doc) %>% 
  drop_na(doc_star)

doc_doc.star.reg <- lmodel2(doc_star ~ doc, data = doc_doc.star, nperm = 99) #filtered DOC (from bottles) v DOC star

doc_doc.star.blandr <- blandr.statistics(doc_doc.star$doc, doc_doc.star$doc_star, sig.level = 0.95)

doc_doc.star.blandr$bias
```
```{r}
doc_doc.star.blandr$upperLOA
```
```{r}
doc_doc.star.blandr$lowerLOA
```

```{r doc star blandr plot, echo = FALSE, warning = FALSE, message = FALSE}
doc_doc.star.blandr.plot <- vessel_comparisons %>% 
  drop_na(doc_star) %>% 
  mutate(diff = doc - doc_star,
         mean = (doc + doc_star) / 2) %>% 
  ggplot(., aes(x = mean, y = diff)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = doc_doc.star.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = doc_doc.star.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = doc_doc.star.blandr$lowerLOA, size = 1, linetype = 3) +
   geom_point(aes(fill = factor(Season, levels = levels)), color = "black",  shape = 21, size = 4, alpha = 0.7) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Difference: DOC - DOC*, µmol C L"^-1)), x = expression(paste("Mean: (DOC + DOC*) / 2, µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) 
```


```{r doc star lmodel2 plot, echo = FALSE, warning = FALSE, message = FALSE}

doc_doc.star.reg.plot <- vessel_comparisons %>% 
  drop_na(doc_star) %>% 
  ggplot(aes(x = doc, y = doc_star)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = doc_doc.star.reg$regression.results[3,2],
              slope = doc_doc.star.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(y = expression(paste("DOC*, µmol C L"^-1)), x = expression(paste("DOC, µmol C L"^-1))) +
  scale_fill_manual(values = custom.colors) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(fill = F) +
   annotate( geom = "text", label = expression(atop("y = 0.90x + 4.35", paste("r"^2,"= 0.83, ", italic("p "), "<< 0.01"))), x = 78, y = 51, size = 3) +
  xlim(50, 80) +
  ylim(50, 80)


```

```{r combine doc star plots, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
doc_doc.star.reg.plot + doc_doc.star.blandr.plot +
  plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))
```

### PDOC  v DOC bottle

```{r filtered doc stats}
vessel_doc <- vessel_comparisons %>% 
  drop_na(pdoc)

vessel_doc.reg <- lmodel2(pdoc ~ doc, data = vessel_comparisons, nperm = 99) #vial v bottle DOC (both filtered)


vessel_doc.blandr <- blandr.statistics(vessel_comparisons$doc, vessel_comparisons$pdoc, sig.level = 0.95)

vessel_doc.blandr$bias

```

```{r}
vessel_doc.blandr$upperLOA
```

```{r}
vessel_doc.blandr$lowerLOA
```

```{r filtered doc blandr plot}
vl_btl_doc_blandr <- vessel_doc %>% 
  mutate(diff = doc - pdoc,
         mean = (doc + pdoc) / 2) %>% 
  ggplot(., aes(x = mean, y = diff, group = Bottle)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = vessel_doc.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = vessel_doc.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = vessel_doc.blandr$lowerLOA, size = 1, linetype = 3) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  scale_fill_brewer(palette = "Dark2") +
  labs(y = expression(paste("Difference: Bottle DOC - Vial DOC, µmol C L"^-1)), x = expression(paste("Mean: (Bottle DOC + Vial DOC) / 2, µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(fill = F)
```

```{r filtered doc lmodel2 plot}
vl_btl_doc <- vessel_doc %>% 
  ggplot(aes(x = doc, y = pdoc, group = Bottle)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = vessel_doc.reg$regression.results[3,2],
              slope = vessel_doc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = expression(paste("Bottle DOC, µmol C L"^-1)), y = expression(paste("Vial DOC, µmol C L"^-1)), fill = "Early Spring Station") +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
   annotate( geom = "text", label = expression(atop("y = 1.02x - 1.44", paste("r"^2,"= 0.96, ", italic("p "), "<< 0.01"))), x = 80, y = 51, size = 3) +
  xlim(50, 85) +
  ylim(50, 85) +
  guides(fill = F)
```

### Bottle v. Vial Cell Abundance

```{r vessel cell regression}
vessel_cells.reg <- lmodel2(p_cells ~ cells, data = vessel_comparisons, nperm = 99) #vial v bottle DOC (both filtered)

vessel_cells.blandr <- blandr.statistics(vessel_comparisons$cells, vessel_comparisons$p_cells, sig.level = 0.95)

vessel_cells.blandr$bias
```
```{r}
vessel_cells.blandr$upperLOA
```
```{r}
vessel_cells.blandr$lowerLOA
```

```{r filtered cell blandr plot}
vl_btl_cell_blandr <- vessel_comparisons %>% 
  drop_na(p_cells) %>% 
  mutate(diff = cells - p_cells,
         mean = (cells + p_cells) / 2) %>% 
  ggplot(., aes(x = mean, y = diff, group = Bottle)) +
  geom_hline(yintercept = 0, size = 1, linetype = 1) +
    geom_hline(yintercept = vessel_cells.blandr$bias, size = 1, linetype = 2) +
  geom_hline(yintercept = vessel_cells.blandr$upperLOA, size = 1, linetype = 3) +
  geom_hline(yintercept = vessel_cells.blandr$lowerLOA, size = 1, linetype = 3) +
  geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  scale_fill_brewer(palette = "Dark2") +
  labs(y = expression(paste("Difference: Bottle Cells - Vial Cells, L"^-1)), x = expression(paste("Mean: (Bottle Cells + Vial Cells) / 2, L"^-1))) +
  theme_classic2(base_size = 16) 
```


```{r vessel cell plot}
vl_btl_cell <- vessel_comparisons %>% 
  drop_na(p_cells) %>% 
  ggplot(aes(x = cells, y = p_cells)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = vessel_cells.reg$regression.results[3,2],
              slope = vessel_cells.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
 geom_point(aes(fill = Station), color = "black", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("Bottle Cells L"^-1)), y = expression(paste("Vial Cells L"^-1)), fill = "NAAMES 4 Station") +
  guides(fill = F) +
  theme_classic2(base_size = 16) +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.title = element_blank()) +
  annotate( geom = "text", label = expression(atop("y = 1.07x - 8.72 * 10"^7, paste("r"^2,"= 0.96, ", italic("p "), "<< 0.01"))), x = 2.6E9, y = 5.0E8, size = 3) +
  #theme(plot.caption = element_text(face = "")) +
  ylim(4.5*10^8, 3.0*10^9) +
  xlim(4.5*10^8, 3.0*10^9)

```


```{r combine regression plots, fig.height=12, fig.width=16, message=FALSE, warning=FALSE}
vl_btl_cell + vl_btl_cell_blandr + vl_btl_doc + vl_btl_doc_blandr +
  plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))
```

# N2 Post-Cruise contamination

```{r}
unique(doc_og$increase)
```

```{r}
unique(doc_og$per_increase)
```


```{r N2 remin plot, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8}

doc_og %>% 
  ggplot(aes(x = Days, y = mean)) + 
  geom_vline(aes(xintercept = 26), linetype = 2) +
  geom_label(aes(x = 26, y = 52, label = "Cruise End"), size = 3) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_label(aes(x = 7, y = 52, label = "Large Volume Collection"), size = 3) +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, color = factor(Season, levels = levels)), width = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression("Days"), y = expression(paste("DOC, µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, fill = F) 

  
```

## Map

```{r}
library(akima)
library(mapdata)
library(maps)
library(rerddap)
```
## Chl climatology

[tutorial](https://rmendels.github.io/pices2017.nb.html)
[tutorial2](https://rpubs.com/eqmh/sat-data-plotter-mapper)

```{r}
chlaInfo <- info("erdMH1chla8day")
CHLA <- griddap(chlaInfo, latitude = c(35., 65.), longitude = c(-60, -30), time = c('2016-05-01','2016-05-31'), fields = 'chlorophyll')

library(readxl)

stations <- read_xlsx("~/GITHUB/naames_bioav_ms/Input/stations.xlsx") %>% 
  select(Cruise, Station, Latitude, Longitude) %>% 
  mutate(Season = ifelse(Cruise == "AT32", "Early Winter", NA),
         Season = ifelse(Cruise == "AT34", "Late Spring", Season),
         Season = ifelse(Cruise == "AT38", "Early Autumn", Season),
         Season = ifelse(Cruise == "AT39", "Early Spring", Season))

```

```{r message=FALSE, warning=FALSE}
mycolor <- colors$salinity
w <- map_data("worldHires", ylim = c(35., 65.), xlim = c(-60, -30))

map <- ggplot() + 
  geom_polygon(data = w, aes(x = long, y = lat, group = group), fill = "grey80") +
  geom_raster(data = CHLA$data, aes(x = lon, y = lat, fill = log(chlorophyll)), interpolate = FALSE, alpha = 0.4) +
  scale_fill_gradientn(colours = mycolor, na.value = NA) +
  theme_bw() + 
  labs(x = "Latitude, ˚N", y = "Longitude, ˚W", fill = expression(paste("log(Chl ", italic("a"), ")")), color = "") +
  coord_fixed(1.3, xlim = c(-60, -30),  ylim = c(35., 65.)) +
  geom_point(data = stations, aes(x = Longitude, y = Latitude, color = factor(Season, levels = levels)), shape = 21, fill = "white", size = 2, alpha = 0.6, stroke = 2) +
  scale_color_manual(values = custom.colors) 
 
```

```{r fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
figure1 <- map 

ggsave("f1.jpg", figure1, device = "jpg",  width = 8, height = 8, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```

# Curves

## Cells

```{r incubation delta cells, message=FALSE, warning=FALSE}
ba_curves <- bge %>% 
  filter(Treatment == "Control") %>% 
  drop_na(norm_cells) %>% 
  select(Season, Station, degree_bin, Days, norm_cells, sd_norm_cells) %>% 
  distinct() %>% 
  # filter(!Cruise == "AT34" | !Station == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_cells, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_cells - sd_norm_cells, ymax = norm_cells + sd_norm_cells, color = factor(degree_bin)), width = 0.3, alpha = 0.5) +
  geom_line(aes(color = factor(degree_bin)), alpha = 0.7) +
  geom_point(aes(fill = factor(degree_bin)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 labs(x = expression(""), y = expression(paste("Bacterial Abundance, Cells L"^-1)), fill = "Latitude, ˚N") +
  theme_classic2(base_size = 16) +
  guides(color = F, linetype = F) + facet_grid(~factor(Season, levels = levels))
```


```{r incubation delta cells log, message=FALSE, warning=FALSE}
ba_curves2 <- bge %>% 
  filter(Treatment == "Control") %>% 
  drop_na(norm_cells) %>% 
  select(Season, Station, degree_bin, Days, norm_cells, sd_norm_cells) %>% 
  distinct() %>% 
  # filter(!Cruise == "AT34" | !Station == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_cells, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_cells - sd_norm_cells, ymax = norm_cells + sd_norm_cells, color = factor(degree_bin)), width = 0.3, alpha = 0.5) +
  geom_line(aes(color = factor(degree_bin)), alpha = 0.7) +
  geom_point(aes(fill = factor(degree_bin)), size = 3, shape = 21, alpha = 0.7) +
  scale_y_log10() +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 labs(x = expression(""), y = expression(paste("Bacterial Abundance, Log"[10]," Cells L"^-1)), fill = "Latitude, ˚N") +
  theme_classic2(base_size = 16) +
  guides(color = F, linetype = F) + facet_grid(~factor(Season, levels = levels))
```



## DOC

```{r incubation delta doc, message=FALSE, warning=FALSE}
doc_curves <-  bge %>% 
  filter(Treatment == "Control") %>% 
  drop_na(sd_combined_doc) %>% 
  select(Season, Station, degree_bin, Days, norm_doc_toc, sd_norm_doc_toc) %>% 
  distinct() %>% 
  # filter(!Cruise == "AT34" | !S,tation == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_doc_toc, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_doc_toc - sd_norm_doc_toc, ymax = norm_doc_toc + sd_norm_doc_toc, color = factor(degree_bin)), width = 1, alpha = 0.5) +
  geom_line(aes(color = factor(degree_bin)), alpha = 0.7) +
  geom_point(aes(fill = factor(degree_bin)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 # labs(x = expression("Days"), y = expression(paste("DOC"^"(*)",", µmol C L"^-1)), fill = "") +
  labs(x = expression("Days"), y = expression(paste("DOC or TOC, µmol C L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_blank()) +
  guides(color = F, fill = F) +
  facet_grid(~factor(Season, levels = levels))
```


```{r incubation delta doc2, message=FALSE, warning=FALSE}
doc_curves2 <-  bge %>% 
  filter(Treatment == "Control", Days <= 20) %>% 
  drop_na(sd_combined_doc) %>% 
  select(Season, Station, degree_bin, Days, norm_doc_toc, sd_norm_doc_toc) %>% 
  distinct() %>% 
  # filter(!Cruise == "AT34" | !S,tation == 3) %>% #did not calc bge or cell resp due to data coming from post stationary
  ggplot(aes(x = Days, y = norm_doc_toc, group = interaction(Season, Station))) +
  geom_errorbar(aes(ymin = norm_doc_toc - sd_norm_doc_toc, ymax = norm_doc_toc + sd_norm_doc_toc, color = factor(degree_bin)), width = 0.5, alpha = 0.3) +
  geom_line(aes(color = factor(degree_bin)), alpha = 0.7) +
  geom_point(aes(fill = factor(degree_bin)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 labs(x = expression("Days"), y = expression(paste("DOC, µmol C L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_blank()) +
  guides(color = F, fill = F) +
  facet_grid(~factor(Season, levels = levels))
```

```{r fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
ba_curves2 / doc_curves + 
   plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))
```


```{r fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
figure2 <- ba_curves / doc_curves + 
   plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14))

ggsave("f2.jpg", figure2, device = "jpg",  width = 16, height = 8, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```

```{r fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
# figure1a <-  ba_curves / doc_curves2 + 
#    plot_annotation(tag_levels = "a") &
#   plot_layout(guides = "collect") +
#   theme(plot.tag = element_text(size = 14))
```


# Delta Stats

stats for ∆POC and ∆DOC

```{r}
delta_stats <- bge_summary %>% 
  select(Cruise, degree_bin,  del.poc, del.doc, del.doc.star) %>% 
  mutate(del.doc = ifelse(is.na(del.doc), del.doc.star, del.doc)) %>% 
  select(-del.doc.star)

longterm_delta_stats <- export_bioav %>% 
  select(Cruise, degree_bin, longterm.del.doc) %>% 
  drop_na(longterm.del.doc) %>% 
  mutate(season = ifelse(Cruise == "AT38", "Autumn", "Spring"))

```

```{r}
# delta_stats %>% 
  # kruskal_test(del.poc ~ Cruise)

compare_means(del.poc ~ Cruise, delta_stats, method = "kruskal.test")

```

```{r}
# delta_stats %>%
#   kruskal_test(del.doc ~ Cruise)

compare_means(del.doc ~ Cruise, delta_stats, method = "kruskal.test")
```


```{r}
delta_stats %>%
  group_by(Cruise) %>% 
  kruskal_test(del.doc ~ degree_bin)

```


```{r}
compare_means(longterm.del.doc ~ Cruise, longterm_delta_stats, method = "kruskal.test")
```

```{r}
compare_means(longterm.del.doc ~ Cruise, longterm_delta_stats)
```
```{r}
longterm_delta_stats %>% 
  group_by(Cruise) %>% 
  kruskal_test(longterm.del.doc ~ degree_bin)
  
```

```{r}
longterm_delta_stats %>% 
  group_by(season) %>% 
  summarize_at(vars(longterm.del.doc), list(mean = mean, sd = sd), na.rm = T)  %>% 
  mutate(foldchange = first(mean)/last(mean))
```
```{r}
longterm_delta_stats %>% 
  summarize_at(vars(longterm.del.doc), list(mean = mean, sd = sd), na.rm = T) %>% 
  mutate(cv = sd/mean)
```


# BGE

```{r fig.height=4, fig.width=7, message=FALSE}
bge_box <- bge_summary %>% 
  drop_na(bge) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = bge)) +
  geom_boxplot(width = 0.3) +
  geom_point(aes(fill = factor(degree_bin)), shape = 21, size = 3, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  theme_classic2(base_size = 16) +
  # scale_fill_brewer(palette = "Dark2") +
  labs(x = "", y = "BGE", fill = "Latitude, ˚N") + 
  stat_compare_means()  
  
  bge_box
```


```{r include = FALSE}
ggsave("f4.jpg", bge_box, device = "jpg",  width = 7, height = 4, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```

```{r}

compare_means(bge ~ degree_bin, bge_summary, method = "kruskal.test")
```

```{r fig.height=12, fig.width=13, message=FALSE, warning=FALSE}
ba_curves2 / doc_curves2 + bge_box +
   plot_annotation(tag_levels = "a") &
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 20))
```


# Experiments at 44˚N

```{r Remin plots, echo=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE}

doc44a <- lat44 %>% 
  ggplot(aes(x = Days, y = norm.doc, group = interaction(Cruise, Station, Bottle))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_errorbar(aes(ymin = norm.doc - sd_combined_doc, ymax = norm.doc + sd_combined_doc, color = factor(Season, levels = levels)), width = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  # scale_color_viridis_d(option = "viridis") +
  # scale_fill_viridis_d(option = "viridis") +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression("Days"), y = expression(paste("DOC"["SA"],", µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F) +
  annotate("text", x = 50, y = -3, label = expression(bold("Annual DOC Minimum \nduring Deep Mixing")), size = 5)

doc44a_i <- lat44 %>% 
  filter(Days == 0) %>% 
  ggplot(aes(x = Days, y = norm.doc, group = interaction(Cruise, Station, Bottle))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_errorbar(aes(ymin = norm.doc - sd_combined_doc, ymax = norm.doc + sd_combined_doc, color = factor(Season, levels = levels)), width = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  # scale_color_viridis_d(option = "viridis") +
  # scale_fill_viridis_d(option = "viridis") +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
 labs(x = expression("Days"), y = expression(paste("DOC"["SA"],", µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  xlim(0, 106) +
  guides(color = F, linetype = F) +
  annotate("text", x = 50, y = -3, label = expression(bold("Annual DOC Minimum \nduring Deep Mixing")), size = 5)
  
doc44b <- lat44 %>% 
  group_by(Cruise, Station, Hours) %>% 
  mutate(ave_del.bioav.doc = mean(del.bioav.doc),
         sd_del.bioav.doc = sd(del.bioav.doc)) %>% 
  ungroup() %>% 
  select(Season, Cruise, Station, Days, ave_del.bioav.doc, sd_del.bioav.doc, station_line) %>% distinct() %>% 
  ggplot(aes(x = Days, y = ave_del.bioav.doc , group = interaction(Cruise, Station))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_errorbar(aes(ymin = ave_del.bioav.doc - sd_del.bioav.doc, ymax = ave_del.bioav.doc + sd_del.bioav.doc, color = factor(Season, levels = levels)), width = 1) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = station_line), size = 0.75, alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  # scale_color_viridis_d(option = "viridis") +
  # scale_fill_viridis_d(option = "viridis") +
 labs(x = expression("Days"), y = expression(paste("∆DOC, µmol C L"^-1))) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F, linetype = F, fill = F) +
  annotate("text", x = 50, y = -1.5, label = expression(bold(paste("Annual DOC Minimum \nduring Deep Mixing & Persistent ∆DOC"))), size = 5)



doc44a +
  theme(plot.tag = element_text(size = 14))
  
```


```{r include = FALSE}
figure5 <- doc44a + theme(plot.tag = element_text(size = 14))

ggsave("f5.jpg", figure5, device = "jpg",  width = 10, height = 7, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```

```{r Remin plots initial, echo=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE}
doc44a_i
```

```{r Remin plots2, echo=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE}
doc44a
```

# Bioavailability & BGE Tables

```{r Bioavailability tables}

bge.table.data <- bge_summary %>% 
  group_by(Cruise, Season, Station, degree_bin) %>% 
  summarize_at(vars(del.cells:station_bge), list(mean = mean, sd = sd), na.rm = T)  %>% 
  arrange(factor(Season, levels = levels), degree_bin)

bge.table.data2 <- bge_summary %>% 
  group_by(Cruise, Season) %>% 
  summarize_at(vars(del.cells:station_bge), list(mean = mean, sd = sd), na.rm = T)  %>% 
  arrange(factor(Season, levels = levels))

bioav.table.data <- export_bioav %>% 
  select(Cruise:Station, degree_bin, end.remin, stationary.harvest, redis_DOC_vol, initial.doc:longterm.ddoc) %>% 
  mutate(shortterm.del.doc = ifelse(shortterm.del.doc < 2, NA, shortterm.del.doc),
         shortterm.bioav.doc = ifelse(is.na(shortterm.del.doc), NA, shortterm.bioav.doc),
         shortterm.ddoc = ifelse(is.na(shortterm.del.doc), NA, shortterm.ddoc),
         
         longterm.del.doc = ifelse(end.remin < 10, NA, longterm.del.doc),
          longterm.bioav.doc = ifelse(is.na( longterm.del.doc), NA,  longterm.bioav.doc),
          longterm.ddoc = ifelse(is.na( longterm.del.doc), NA,longterm.ddoc),
         
         
         persis.doc = ifelse(persis.doc < 2, NA, persis.doc),
         
         percent_persis.doc = ifelse(is.na(persis.doc), NA, percent_persis.doc)) %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  ungroup() 

station_bioav <- bioav.table.data %>% 
 group_by(Cruise, Season, Station, degree_bin) %>% 
  summarize_at(vars(redis_DOC_vol:longterm.ddoc), list(mean = mean, sd = sd), na.rm = T)  %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  ungroup()

cruise_bioav <- bioav.table.data %>% 
 group_by(Cruise, Season) %>% 
  summarize_at(vars(redis_DOC_vol:longterm.ddoc), list(mean = mean, sd = sd), na.rm = T)  %>% 
  arrange(factor(Season, levels = levels)) %>% 
  ungroup() 

time <- export_bioav %>% 
  select(Season, Cruise, degree_bin, Station, Bottle, stationary.harvest, end.remin) %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  ungroup()


 #N2S3 bge not calc omitted because poc change and cell change from data well beyond stationary (in death phase)
boc_doc <- bge %>% 
  filter(Treatment == "Control") %>% 
  select(Cruise, Season, Station, degree_bin, Bottle, stationary.harvest, remin.end, Days, bge,  doc.star_i, doc.star_s,  i.poc, s.poc, combined_doc, sd_ptoc, sd_doc, doc  ) %>% 
  filter(Days == 0 | Days == stationary.harvest) %>%
  drop_na(stationary.harvest) %>% 
  mutate(doc_i = ifelse(Cruise == "AT34" & Days == 0, combined_doc, NA),
         doc_s = ifelse(Cruise == "AT34" & Days == stationary.harvest, combined_doc, NA)) %>% 
  group_by(Cruise, Station, Bottle) %>% 
  fill(doc_i:doc_s, .direction = "downup") %>% 
  ungroup() %>% 
  mutate(doc_i = ifelse(!Cruise == "AT34", doc.star_i, doc_i),
         doc_s = ifelse(!Cruise == "AT34", doc.star_s, doc_s )) %>% 
  #select(-combined_doc) %>% 
  mutate(phase = ifelse(Days == 0, "t0", "stationary")) %>% 
  group_by(Cruise, Station, phase) %>% 
  mutate(i.boc = mean(i.poc),
         sd_i.boc = sd(i.poc),
         
         s.boc = mean(s.poc),
         sd_s.boc = sd(s.poc),
         
         i.doc = mean(doc_i),
         sd_i.doc = sd(doc_i),
         
          s.doc = mean(doc_s),
         sd_s.doc = sd(doc_s),
         ) %>%
    ungroup() %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  ungroup() %>% 
  select(Cruise:Bottle, i.boc:sd_s.doc, everything())
  # mutate(s.boc = ifelse(Cruise == "AT34" & Station == 3, NA, s.boc))#N2S3 omitted because poc change and cell change from data well beyond stationary (in death phase)
#n3s3, doc star is resolveable, but measured doc was not so bge was not calculated for this station
#n4s4 ∆doc reflects single experiment. same with n2s4


boc_doc2 <- bge %>% 
  filter(Treatment == "Control") %>% 
  select(Cruise, Season, Station, degree_bin, Bottle, Days, interp_ptoc, sd_ptoc, interp_doc, sd_doc  ) %>% 
  group_by(Cruise, Station, Bottle) %>% 
  mutate(last_ptoc = last(na.omit(interp_ptoc)),
         last_doc = last(na.omit(interp_doc))) %>% 
   mutate(longterm.del.doc = ifelse(Cruise != "AT34", first(interp_ptoc) - last(na.omit(interp_ptoc)), first(interp_doc) - last(na.omit(interp_doc))),
         longterm.del.doc = ifelse(longterm.del.doc < 2, NA, longterm.del.doc)) %>% 
  mutate(last = ifelse(Cruise == "AT34", last_doc, last_ptoc)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(mean = mean(last),
         sd = sd(last)) %>% 
  arrange(factor(Season, levels = levels), degree_bin) 

```

# Box plots: NPP, BP, BA


```{r Rate & abundance boxplots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 12, fig.width = 12}
my_comparisons <- list( c("Early Spring", "Late Spring"), c("Early Spring", "Early Autumn"), c("Early Spring", "Early Winter"), c("Late Spring", "Early Autumn"), c("Late Spring", "Early Winter"), c("Early Autumn", "Early Winter")) 

#npp
npp.boxplot <- bcd %>% 
  select(Season, degree_bin, int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int.NPP)) +
  geom_boxplot(width = 0.3, outlier.shape = NA) +
  geom_point(aes(fill = factor(degree_bin)), shape = 21, size = 3, alpha = 0.7) +
  #  scale_color_brewer(palette = "RdBu") +
  # scale_fill_brewer(palette = "RdBu") +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  theme_classic2(base_size = 16) +
  labs(x = "", y =  expression(paste("NPP, mmol C m"^-3, "d"^-1)), fill = "Latitude, ˚N") + 
  stat_compare_means(label.y = 0)  +
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.adj",
                     step.increase = 0.11,
                     tip.length = 0.01) +
    rremove("x.text") 
  

#bp
bp.boxplot <- bcd %>% 
  select(Season, degree_bin, int.bp) %>% 
  mutate_at(vars(contains("bp")), funs(./10^3)) %>% 
  distinct() %>% 
   ggplot(aes(x = factor(Season, levels = levels), y = int.bp)) +
  geom_boxplot(width = 0.3, outlier.shape = NA) +
  geom_point(aes(fill = factor(degree_bin)), shape = 21, size = 3, alpha = 0.7) +
  #  scale_color_brewer(palette = "RdBu") +
  # scale_fill_brewer(palette = "RdBu") +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  theme_classic2(base_size = 16) +
  labs(x = "", y =  expression(paste("BP, mmol C m"^-3, "d"^-1)), fill = "Latitude, ˚N") + 
  guides(fill = F) +
  stat_compare_means(label.y = 0)  +
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.adj",
                     step.increase = 0.11,
                     tip.length = 0.01) +
    rremove("x.text") 

#ba
ba.boxplot <- bcd %>% 
  select(Season, degree_bin, int.ba) %>% 
  distinct() %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int.ba)) +
  geom_boxplot(width = 0.3, outlier.shape = NA) +
  geom_point(aes(fill = factor(degree_bin)), shape = 21, size = 3, alpha = 0.7) +
  #  scale_color_brewer(palette = "RdBu") +
  # scale_fill_brewer(palette = "RdBu") +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  theme_classic2(base_size = 16) +
  labs(x = "", y =  expression(paste("BA, cells m"^-3)), fill = "Latitude, ˚N") +
  guides(fill = F) +
  stat_compare_means(label.y = 0)  +
  stat_compare_means(comparisons = my_comparisons, 
                     label = "p.adj",
                     step.increase = 0.11,
                     tip.length = 0.01) 



```


```{r patchwork rate & abundance plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 14, fig.width = 10, fig.align = "center"}

patchwork <- npp.boxplot / bp.boxplot / ba.boxplot 
patchwork +  plot_annotation(tag_levels = "a") + plot_layout(guides = "collect") &
  theme(plot.tag = element_text(size = 14))

```

```{r include = FALSE}
figure6 <-  npp.boxplot / bp.boxplot / ba.boxplot  +  plot_annotation(tag_levels = "a") + plot_layout(guides = "collect") &
  theme(plot.tag = element_text(size = 14))

ggsave("f6.jpg", figure6, device = "jpg",  width = 12, height = 12, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```


# Bar plots: BCD and BCD:NPP

Convert BCD and NPP to mmol C m^-3^ d^-1^  

```{r Summarize BCD and NPP data}
bcd.data <- bcd %>% 
  select(Season, Cruise:degree_bin, Station, ave_mld, sd_mld, int.temp, int.chl, int.ba, int.bcd, int.bcd_global, int.bp, int.NPP, bp.npp, bcd.npp, bcd.npp_global) %>% 
  distinct() %>% 
  mutate_at(vars(int.bcd, int.bcd_global, int.bp, int.NPP), funs(./10^3)) %>% 
  mutate_at(vars(bp.npp, bcd.npp, bcd.npp_global), funs(./10^2)) %>% 
  mutate(degree_bin = as.character(degree_bin)) 

bcd.summary <- bcd.data %>% 
  group_by(Season, Cruise, Station, degree_bin, ave_mld, sd_mld) %>% 
  summarise_at(vars(int.temp, int.chl, int.ba, int.bcd_global, int.bp, int.NPP, bp.npp, bcd.npp_global), list(mean = mean, sd = sd)) %>% 
  arrange(factor(Season, levels = levels), degree_bin) %>% 
  select(Season:sd_mld, contains(c("int.temp", "int.chl", "int.ba",  "int.NPP", "int.bp", "bp.npp", "int.bcd", "bcd.npp"))) 
  
bcd.cruise.summary <- bcd.data %>% 
  group_by(Season, Cruise) %>% 
  summarise_at(vars(int.temp, int.chl, int.ba, int.bcd_global, int.bp, int.NPP, bp.npp, bcd.npp_global), list(cruise_mean = mean, cruise_sd = sd, cruise_max = max, cruise_min = min)) %>% 
  arrange(factor(Season, levels = levels)) %>% 
  select(Season, contains(c("int.temp", "int.chl", "int.ba", "int.NPP", "int.bp", "bp.npp", "int.bcd", "bcd.npp")))

bcd.overall.summary <- bcd.data %>% 
  summarise_at(vars(int.temp, int.chl, int.ba, int.bcd_global, int.bp, int.NPP, bp.npp, bcd.npp_global), list(overall_mean = mean, overall_sd = sd, max = max, min = min))

bcd.npp.summary <- bcd.summary %>% 
  select(Season, Cruise,  degree_bin, int.NPP_mean, int.bcd_global_mean) %>% 
  rename(NPP = int.NPP_mean,
         BCD = int.bcd_global_mean) %>% 
  pivot_longer(c(NPP, BCD), names_to = "rate", values_to = "ave") %>% 
  left_join(., bcd.summary %>% 
  select(Season, Cruise, degree_bin,  int.NPP_sd, int.bcd_global_sd) %>% 
    rename(NPP = int.NPP_sd,
         BCD = int.bcd_global_sd) %>% 
  pivot_longer(c(NPP, BCD), names_to = "rate", values_to = "sd"))

bcd.npp_summary_table <- left_join(bcd.summary, bcd.cruise.summary) %>% 
  mutate_at(vars(contains(c("int.NPP", "int.bp", "int.bcd"))), round, 3) %>% 
  mutate_at(vars(contains(c("bp.npp", "bcd.npp"))), round, 2) 

# export_bar <- export %>% 
#   mutate(degree_bin = as.character(degree_bin)) %>% 
#   group_by(Season, Cruise, degree_bin) %>% 
#   summarise_at(vars(int_delta_DOC_100, doc_ncp_100, NCP_mol_100), list(mean = mean, sd = sd)) %>% 
#   arrange(factor(Season, levels = levels), degree_bin)

export_bar <- export_bioav %>%
  mutate(degree_bin = as.character(degree_bin)) %>%
  group_by(Season, Cruise, degree_bin) %>%
  summarise_at(vars(accm.doc), list(mean = mean, sd = sd), na.rm = T) %>%
  arrange(factor(Season, levels = levels), degree_bin)

  
```

```{r accm DOC table}
accm.doc_table <- export_bioav %>% 
  select(Cruise, Season, accm.doc) %>% 
  drop_na(accm.doc) %>% 
  group_by(Cruise, Season) %>% 
  summarise_at(vars(accm.doc), list(mean = mean, sd = sd))

accm.doc_table
```


```{r BCD and NPP bar plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 12}

bcd.bar <- bcd.summary %>% 
  ggplot(aes(x = degree_bin, y = int.bcd_global_mean, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
   geom_errorbar(aes(ymin = int.bcd_global_mean - int.bcd_global_sd, ymax = int.bcd_global_mean + int.bcd_global_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(""), y = expression(paste("BCD, mmol C m"^-3, "d"^-1)), colour = expression("")) +
  theme_classic2() +
   # theme(strip.background = element_blank(), strip.text = element_blank()) +
  facet_grid(~factor(Season, levels = levels), scales = "free") 

bcd.bar2 <- bcd.summary %>% 
  ggplot(aes(x = degree_bin, y = int.bcd_global_mean, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
   geom_errorbar(aes(ymin = int.bcd_global_mean - int.bcd_global_sd, ymax = int.bcd_global_mean + int.bcd_global_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(""), y = expression(paste("BCD, mmol C m"^-3, "d"^-1)), colour = expression("")) +
  theme_classic2() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 

bcd.npp.bar <- bcd.npp.summary  %>% 
  ggplot(aes(x = degree_bin, fill = factor(rate, levels = c("NPP", "BCD")), y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(""), y = expression(paste("mmol C m"^-3, "d"^-1)), colour = expression("")) +
  scale_fill_manual(values = custom.colors) +
  theme_classic2() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  theme(legend.position = "right",
        legend.title = element_blank()) 

ratio.bar <- bcd.summary %>% 
  ggplot(aes(x = degree_bin, y = bcd.npp_global_mean, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1,  fill = "#999999") +
  geom_errorbar(aes(ymin = bcd.npp_global_mean - bcd.npp_global_sd, ymax = bcd.npp_global_mean + bcd.npp_global_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression("Latitude, ˚N"), y = expression(paste("BCD:NPP")), colour = expression("")) +
  theme_classic2() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank())


# doc_sa.bar <-  export_bar %>% 
#   ggplot(aes(x = degree_bin, y = int_delta_DOC_100_mean, group = interaction(Season, degree_bin)))  +
#   geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#999999") +
#    geom_errorbar(aes(ymin = int_delta_DOC_100_mean - int_delta_DOC_100_sd, ymax = int_delta_DOC_100_mean + int_delta_DOC_100_sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
#   labs(x = expression(""), y = expression(paste("∆DOC, mol C m"^-3)), colour = expression("")) +
#   theme_classic2() +
#   facet_grid(~factor(Season, levels = levels), scales = "free") 


doc_sa.bar <-  export_bar %>%
  ggplot(aes(x = degree_bin, y = mean, group = interaction(Season, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#999999") +
   geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(""), y = expression(paste("DOC"["SA"],", mol C m"^-3)), colour = expression("")) +
  theme_classic2() +
  facet_grid(~factor(Season, levels = levels), scales = "free")
  
doc_sa.bar / bcd.bar / bcd.npp.bar / ratio.bar  +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
```

```{r}
figure7 <- doc_sa.bar / bcd.bar / bcd.npp.bar / ratio.bar  +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))

ggsave("f7.jpg", figure7, device = "jpg",  width = 12, height = 10, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```



```{r BCD and NPP bar plots2, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 12}
bcd.bar2 / bcd.npp.bar / ratio.bar  +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
```


# Regressions: Property-Property 

```{r}
summary(bcd.data$int.NPP)
```


## BCD v NPP

```{r Model 2 regression, echo = FALSE}
reg1 <- lmodel2(int.bcd_global ~ int.NPP, data = bcd.data, nperm = 99)


```

```{r}
reg_test <- lm(int.NPP ~ int.temp, data = bcd.data) ; summary(reg_test)
```


## Plots

```{r BCD and NPP regression plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8}
reg1.plot <- bcd.data %>% 
  ggplot(aes(x = int.NPP, y = int.bcd_global)) + 
  geom_abline(intercept = reg1$regression.results[3,2],
              slope = reg1$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
   geom_abline(intercept = reg1$confidence.intervals[3,2],
              slope = reg1$confidence.intervals[3,4],colour = "grey", linetype = 3, size = 1) +
  geom_abline(intercept = reg1$confidence.intervals[3,3],
              slope = reg1$confidence.intervals[3,5],colour = "grey", linetype = 3, size = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7) +
  labs(x =  expression(paste("NPP, mmol C m"^-3, "d"^-1)), y = expression(paste("BCD, mmol C m"^-3, "d"^-1))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  theme_classic2(base_size = 16) +
  theme(legend.title = element_blank()) +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.19x + 0.03", paste("r"^2," = 0.68, ", italic("p "), "<< 0.01"))), x = 2.7, y = 0.08, size = 6) 
  

reg1.plot

```

```{r}

ggsave("f8.jpg", reg1.plot, device = "jpg",  width = 8, height = 6, path = "~/Desktop/Dissertation/MS_Bioavailability/Submission 2/figures/")
```

```{r}

compare_means(bcd.npp_global_mean ~ Cruise, bcd.summary, method = "kruskal.test")


```

```{r}
compare_means(bcd.npp_global_mean ~ Season, bcd.summary)
```




## bp/bcd profile

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 5}
profile.data <- bcd %>% 
  select(Cruise, Season, Station, CampCN, degree_bin, Depth, bp, bcd_global) %>% 
  filter(CampCN == 120) %>% 
  drop_na(bp) %>% 
  select(Depth, bp:bcd_global) %>% 
  rename(BP = bp,
         BCD = bcd_global) %>% 
  pivot_longer(cols = c(BP, BCD), names_to = "rate", values_to = "value") 


profile <- profile.data %>% 
  ggplot(aes(x = Depth, y = value)) +
  geom_line(aes(color = factor(rate, levels = c("BP", "BCD"))), size = 0.7) +
  geom_point(aes(fill = factor(rate, levels = c("BP", "BCD"))), size = 3, shape = 21, color = "black", stroke = 1) + 
  labs(x = "Depth, m", y = expression(paste("BP or BCD, nmol C L"^-1,"d"^-1)), colour = "", fill = "") +
  scale_x_reverse() +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  ylim(0, 605) +
  coord_flip() +
  guides(colour = F) +
  theme_classic2(base_size = 16)

profile
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 5}
profile2 <- profile.data %>% 
  filter(rate == "BP") %>% 
  ggplot(aes(x = Depth, y = value)) +
  geom_line(aes(color = rate), size = 0.7) +
  geom_point(aes(fill = rate), size = 3, shape = 21, color = "black", stroke = 1) + 
  labs(x = "Depth, m", y = expression(paste("BP or BCD, nmol C L"^-1,"d"^-1)), colour = "", fill = "") +
  scale_x_reverse() +
  ylim(0, 605) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  coord_flip() +
  guides(colour = F) +
  theme_classic2(base_size = 16)

profile2 
```

# Plots for powerpoint

```{r}
library(officer)
```


```{r}


p1a <- ba_curves + labs(y = expression(paste("Cells L"^-1))) +  theme_classic2(16)
p1b <- doc_curves2 + theme_classic2(16) + theme(strip.background = element_blank(), strip.text.x = element_blank())
p1 <- p1a / p1b +
  plot_layout(guides = "collect") 
##
p2 <- bge_box + theme_classic2(18)
##
p3a <- bcd.bar2 + theme_classic2(16) 
p3b <- bcd.npp.bar + theme_classic2(16) + theme(strip.background = element_blank(), strip.text = element_blank()) + theme(legend.position = "right", legend.title = element_blank()) 
p3c <- ratio.bar + theme_classic2(16) + theme(strip.background = element_blank(), strip.text = element_blank()) 
p3 <- p3a / p3b / p3c


# initialize PowerPoint slide
officer::read_pptx() %>%
  # add slide ----
  officer::add_slide() %>%
  # specify object and location of object 
  officer::ph_with(p1, ph_location(width = 9, height = 5)) %>%
  
  officer::add_slide() %>%
  officer::ph_with(p2, ph_location(width = 9, height = 4)) %>%
  
  officer::add_slide() %>%
  officer::ph_with(p3, ph_location(width = 10, height = 8)) %>%
  
  # export slide 
  base::print(
    target = "~/Desktop/Dissertation/MS_Bioavailability/Presentations/biov_pres_figs.pptx"
    )

```

# Reviews

## 1.2 µm filtrate

```{r}
library(readxl)
library(googledrive)
library(googlesheets4)

headers <- read_sheet("https://docs.google.com/spreadsheets/d/1zw-W1k__BeuJg1oQpQQ_XT7zWLiY3dfL-dTaQ0pzN5Q/edit#gid=1446474071", sheet = "Bottle File Headers", skip = 0)

cols <- headers %>% 
  pull(col_type) %>% 
  str_c(., collapse = "")

google.df <-  read_sheet("https://docs.google.com/spreadsheets/d/1zw-W1k__BeuJg1oQpQQ_XT7zWLiY3dfL-dTaQ0pzN5Q/edit#gid=1446474071", sheet = "Bottle File", skip = 1, col_types = cols)

google.df1 <- google.df %>% 
  select(Cruise, Station, Date, SCN, Target_Z, BactAbund) %>% 
  filter(between(Target_Z, 1, 10)) %>%
  drop_na(BactAbund) %>% 
  filter(!Cruise == "AT32", SCN %in% c(3, 7, 12)) %>% 
  filter(!Cruise == "AT34" | !Station == 4 | !SCN %in% c(3, 7)) %>% 
  filter(!Cruise == "AT38" | !Station == 6 | !SCN %in% c(3, 12))  %>% 
  drop_na(BactAbund) %>% 
  select(-Date, -SCN) %>% 
  rename(Depth = Target_Z) %>% 
  mutate(Cruise = ifelse(Cruise == "AT39-6", "AT39", Cruise)) %>% 
  mutate(Depth = ifelse(Depth == 1, 5, Depth))


n4_filtrates <- readxl::read_xlsx("~/GITHUB/naames_bioav_ms/Input/master/NAAMES_4_Filter Retention_Bacterial_Abundance.xlsx", sheet = "Sheet1") %>% 
  mutate(cells = cells/10^8) 

ba <- read_csv("~/GITHUB/naames_bioav_ms/Input/master/N2-4_BactA_Remin_Master.csv") %>% 
  # filter(Hours == 0, Bottle %in% c("W", "1.2"), Depth != 200) 
filter(Hours == 0, Bottle %in% c("Niskin"), Depth != 200) %>% #niskin are actually 1.2 µm filtrate
  mutate(Depth = ifelse(Cruise == "AT34" & Station == 4, 5, Depth)) %>% 
  select(Cruise, Station, Depth, cellsperL) %>% 
  rename(cells = cellsperL) %>% 
  mutate(cells = cells/10^8,
         cells = ifelse(Cruise == "AT39", NA, cells)) %>% 
  full_join(., n4_filtrates) %>% 
  drop_na(cells)

initial.cond <- bge %>% 
  filter(Hours == 0) %>% 
  select(Cruise, Station, cells) %>% 
  distinct() %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_initial = mean(cells)) %>% 
  ungroup() %>% 
  select(Cruise, Station, ave_initial) %>% 
  distinct() %>% 
  mutate(ave_initial = ave_initial/10^8)


filtrate <- left_join(ba, google.df1) %>% 
  drop_na(BactAbund) %>% 
  mutate(ret = cells/BactAbund)  %>% 
  left_join(., initial.cond) %>% 
  rename(in_situ = BactAbund,
         inoc = cells,
         init = ave_initial) %>% 
  mutate(dil = init/inoc) %>% 
  mutate_at(vars(in_situ, inoc, init), funs(.*10^8)) %>%
  mutate_at(vars(in_situ, inoc, init), funs(./10^9))  
```
```{r}
filtrate %>% 
  summarise_at(vars(ret), list(mean = mean, sd = sd)) 
```

```{r}
filtrate %>% 
  summarise_at(vars(dil), list(mean = mean, sd = sd)) 
```


---
title: "BCD and DOC Bioavailability"
author: "Nicholas Baetge"
date: "5/26/2020"
output: github_document
---

# Intro

This document shows plots and tables of the merged field-experiment NAAMES DOC data.

```{r message = F, warning = F}
library(tidyverse) 
library(rmarkdown)
library(knitr)
library(readxl)
library(data.table) 
library(scales)
library(zoo)
library(oce)
library(patchwork)
#rmarkdown tables
library(stargazer)
library(pander)
library(growthcurver)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
```


```{r include = FALSE}
custom_theme <- function() {
  theme_test(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom_theme_linedraw <- function() {
  theme_linedraw(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "A" = "#E41A1C", "B" = "#377EB8", "C" = "#4DAF4A", "D" = "#FF7F00", "E" = "#FDB927", "F" = "#552583", "G" = "#FDB927", "H" = "#552583",   "Control" = "#E41A1C", "TW12" = "#377EB8", "T. Weissflogii 12C Exudate" = "#377EB8", "TW13" = "#4DAF4A", "T. Weissflogii 13C Exudate" = "#4DAF4A", "MixDS" = "#377EB8", "Deep Comm., Surface DOM" = "#377EB8","MixSD" = "#4DAF4A", "Surface Comm., Deep DOM" = "#4DAF4A", "SynLys" = "#377EB8", "Synechococcus Lysate" = "#377EB8", "SynExd" = "#4DAF4A", "Synechococcus Exudate" = "#4DAF4A", "TWExd" = "#FF7F00", "T. Weissflogii Exudate" = "#FF7F00", "TW5" = "#377EB8", "TW10" = "#4DAF4A", "TW20" = "#FF7F00", "Parallel" = "#377EB8", "W" = "#552583", "Whole Seawater" = "#552583", "1.2" = "#4DAF4A", "1.2 µm Filtrate" = "#4DAF4A", "NV" = "#FF7F00", "1.2 µm Filtrate: TFF Filtrate (3:7)" = "#FF7F00", "Carbon" = "#E41A1C", "Nitrogen" = "#377EB8", "+5 µmol C/L Exudate" = "#FF7F00", "+10 µmol C/L Exudate" = "#FF7F00", "+20 µmol C/L Exudate" = "#FF7F00", "Filter 1" = "#E41A1C", "Filter 2" = "#377EB8", "10 m" = "#E41A1C", "200 m" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A" , "Cruise Specific BGE" = "#377EB8", "Global BGE" = "#4DAF4A", "Long-term" = "#377EB8","Short-term" = "#E41A1C") 

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )


levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn",  "Summer", "Late Autumn", "Control", "Parallel", "SynLys", "SynExd", "TWExd", "MixSD", "MixDS", "TW12", "TW13", "TW5", "TW10", "TW20",  "Surface Comm., Deep DOM", "Deep Comm., Surface DOM", "Synechococcus Exudate", "Synechococcus Lysate", "T. Weissflogii Exudate", "T. Weissflogii 12C Exudate", "T. Weissflogii 13C Exudate", "+5 µmol C/L Exudate", "+10 µmol C/L Exudate","+20 µmol C/L Exudate", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "W", "Whole Seawater","1.2", "1.2 µm Filtrate","NV", "1.2 µm Filtrate: TFF Filtrate (3:7)")
```

# Import Data

```{r}
doc <- read_rds("~/naames_bioav_ms/Output/processed_bioavailability.rds") %>% 
   select(-c(Bottle, doc, interp_doc)) %>% 
  arrange(Cruise, Station, Hours) %>% 
  distinct() %>% 
  mutate(bge = ifelse(Cruise == "AT39" & Station == 4, T, F),
         bge = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), T, bge),
         bge = ifelse(Cruise == "AT38" & Station %in% c(3, 6), T, bge),
         degree_bin = as.character(degree_bin))  %>% 
  distinct() 


bcd <- read_rds("~/naames_bioav_ms/Output/processed_integrated_BCD.rds") %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_int.BCD = mean(int.bcd, na.rm = T),
         sd_int.BCD = sd(int.bcd, na.rm = T),
         ave_int.bp = mean(int.bp, na.rm = T),
         sd_int.bp = sd(int.bp, na.rm = T),
         ave_int.ba = mean(int.ba, na.rm = T),
         sd_int.ba = sd(int.ba, na.rm = T),
         ave_int.bc_i = mean(int.bc_i, na.rm = T),
         sd_int.bc_i = sd(int.bc_i, na.rm = T),
         ave_int.bc_s = mean(int.bc_s, na.rm = T),
         sd_int.bc_s = sd(int.bc_s, na.rm = T),
         ave_int.NPP = mean(int.NPP, na.rm = T),
         sd_int.NPP = sd(int.NPP, na.rm = T),
         ave_int.mew_i = mean(mew.season_i, na.rm = T),
         sd_int.mew_i = sd(mew.season_i, na.rm = T),
         ave_int.mew_s = mean(mew.season_s, na.rm = T),
         sd_int.mew_s = sd(mew.season_s, na.rm = T),
         ave_bcd.npp = mean(bcd.npp, na.rm = T),
         sd_bcd.npp = sd(bcd.npp, na.rm = T)) %>% 
  ungroup() %>% 
  mutate_at(vars(ave_int.bp, sd_int.bp, ave_int.bc_i:sd_int.mew_s), round, 2) %>% 
  mutate_at(vars(ave_bcd.npp, sd_bcd.npp), round)
```


Units for imported data frames are currently: 

- BP, µmol C m^-3^ d^-1^
- BCD, µmol C m^-3^ d^-1^ 
- BA, cells m^-3^
- BC,  µmol C m^-3^
- mew, d^-1^
- NPP, µmol C m^-3^ d^-1^
- ∆DOC (from export MS, integrated to Ez), mol C m^-2^

NPP and BCD are converted to: mmol C m^-3^ d^-1^

# Bar plots: NPP, BP, BA, µ, ∆DOC

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 14, fig.width = 12, fig.align = "center", warning = FALSE}

#NPP
npp.bar <- bcd %>% 
  select(Cruise:Station, degree_bin, ave_int.NPP, sd_int.NPP) %>%  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave_int.NPP, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave_int.NPP - sd_int.NPP, ymax = ave_int.NPP + sd_int.NPP), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  guides(fill = F) 
  
#BP
bp.bar <- bcd %>% 
  select(Cruise:Station, degree_bin, ave_int.bp, sd_int.bp) %>% distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave_int.bp, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave_int.bp - sd_int.bp, ymax = ave_int.bp + sd_int.bp), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BP, µmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)

#BA 
ba.bar <- bcd %>% 
  select(Cruise:Station, degree_bin, ave_int.ba, sd_int.ba) %>% distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave_int.ba, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave_int.ba - sd_int.ba, ymax = ave_int.ba + sd_int.ba), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BA, cells m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)


#µ
mew.bar <- bcd %>% 
  select(Cruise:Station, degree_bin, contains("mew")) %>% 
  distinct() %>% 
  pivot_longer(cols = c(ave_int.mew_i, ave_int.mew_s), names_to = "ccf", values_to = "mew") %>%  
  mutate(ccf = ifelse(ccf == "ave_int.mew_i", "Initial CCF", NA),
         ccf = ifelse(ccf == "ave_int.mew_i", "Stationary CCF", ccf),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(mew),
         sd = sd(mew)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("µ, d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F) 

# ∆DOC
deldoc.bar <- doc %>% 
  select(Season:Subregion, degree_bin, ave_Ez, ave_int_delta_DOC_ez, sd_int_delta_DOC_ez) %>% 
  mutate_at(vars(contains("int_delta_DOC")), funs(./ave_Ez * 10^3)) %>% 
  drop_na(ave_int_delta_DOC_ez) %>% 
  distinct() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave_int_delta_DOC_ez, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave_int_delta_DOC_ez - sd_int_delta_DOC_ez, ymax = ave_int_delta_DOC_ez + sd_int_delta_DOC_ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mmol C m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)

npp.bar / bp.bar / ba.bar / mew.bar / deldoc.bar +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
```

Error bars for µ represent standard deviation from mean of values calculated using different CCFs to convert BA to BC (Global Initial CCF, Global Stationary CCF, Season-Specific Initial CCF, Season-Specific Stationary CCF). All other error bars represent standard deviation from mean of station values. 





# Line plots: DOC Decay Curves 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 16, fig.align = "center", warning = FALSE}
doc %>% 
  drop_na(sd_doc) %>% 
  group_by(Cruise, Station) %>%
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Cruise, Station, degree_bin))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_vline(aes(xintercept = 30), linetype = 3) +
  geom_errorbar(aes(ymin = norm_doc - sd_doc, ymax = norm_doc + sd_doc, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = bge), size = 0.75, alpha = 0.7) +
  geom_label(aes(x = 7, y = -1, label = "Short-term"), size = 3) +
  geom_label(aes(x = 30, y = -1, label = "Long-term"), size = 3) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  labs(x = expression(italic("Days")), y = expression(italic(paste("Seasonally Accumulated DOC, µmol C L"^-1)))) +
  custom_theme() +
  guides(color = F, linetype = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 16, fig.align = "center", warning = FALSE}
doc %>% 
  drop_na(sd_doc) %>% 
  group_by(Cruise, Station) %>%
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Cruise, Station, degree_bin))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_vline(aes(xintercept = 30), linetype = 3) +
  geom_errorbar(aes(ymin = norm_doc - sd_doc, ymax = norm_doc + sd_doc, color = factor(Subregion, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Subregion, linetype = bge), size = 0.75, alpha = 0.7) +
  geom_label(aes(x = 7, y = -1, label = "Short-term"), size = 3) +
  geom_label(aes(x = 30, y = -1, label = "Long-term"), size = 3) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
 labs(x = expression(italic("Days")), y = expression(italic(paste("Seasonally Accumulated DOC, µmol C L"^-1)))) +
  custom_theme() +
  guides(color = F, linetype = F)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
doc %>% 
  filter(degree_bin == 44) %>% 
  drop_na(sd_doc) %>% 
  group_by(Cruise, Station) %>%
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Cruise, Station, degree_bin))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_vline(aes(xintercept = 30), linetype = 3) +
  geom_errorbar(aes(ymin = norm_doc - sd_doc, ymax = norm_doc + sd_doc, color = factor(Season, levels = levels)), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = bge), size = 0.75, alpha = 0.7) +
  geom_label(aes(x = 7, y = -1, label = "Short-term"), size = 3) +
  geom_label(aes(x = 30, y = -1, label = "Long-term"), size = 3) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  #facet_grid(~factor(Season, levels = levels), scales = "free") +
 labs(x = expression(italic("Days")), y = expression(italic(paste("Seasonally Accumulated DOC, µmol C L"^-1)))) +
  custom_theme() +
  ggtitle("44˚N") +
  guides(color = F, linetype = F)
```


Black vertical dashed and dotted lines indicate the 7 and 30-day marks, respectively. Dashed decay lines indicate experiments in which BGEs could be calculated. 

# Table: ∆DOC, Bioavailability, Persistence

Seasonally accumulated DOC is expressed as mmol C m^-3^ or µmol C L^-1^

```{r}
bioav.table <- doc %>% 
  select(Season, Station, degree_bin, ave_Ez, sd_Ez, ave_int_delta_DOC_ez, sd_int_delta_DOC_ez, accm_doc, sd_accm_doc, total.bioav_accm_doc:lt.bioav_accm_doc, total.per_bioav:bge) %>% 
  distinct() %>% 
  mutate_at(vars(ave_int_delta_DOC_ez, sd_int_delta_DOC_ez), funs(round((./ave_Ez) * 10^3, 2))) %>% 
  arrange(degree_bin, factor(Season, levels = levels)) %>% 
  ungroup()
```


```{r echo = FALSE, results = 'asis'}
kable(bioav.table, caption = "Seasonal Accumulated DOC Bioavailability and Persistance")
```

```{r}
bioav.table2 <- bioav.table %>% 
  select(-c(ave_Ez:sd_int_delta_DOC_ez)) %>% 
  drop_na(accm_doc) %>% 
  group_by(Season) %>% 
  summarize(accm = mean(accm_doc, na.rm = T),
            sd_accm = sd(accm_doc, na.rm = T),
            total.bv = mean(total.bioav_accm_doc, na.rm = T),
            sd_total.bv = sd(total.bioav_accm_doc, na.rm = T),
            st.bv = mean(st.bioav_accm_doc, na.rm = T),
            sd_st.bv = sd(st.bioav_accm_doc, na.rm = T),
            total.per_bv = mean(total.per_bioav, na.rm = T),
            sd_total.per_bv = sd(total.per_bioav, na.rm = T),
            st.per_bv = mean(st.per_bioav, na.rm = T),
            sd_st.per_bv = sd(st.per_bioav, na.rm = T),
            pers = mean(persis_doc, na.rm = T),
            sd_pers = sd(persis_doc, na.rm = T),
            per_pers = mean(per_persis, na.rm = T),
            sd_per_pers = sd(per_persis, na.rm = T),
            st.ddoc_rate = mean(st.ddoc, na.rm = T),
            sd_st.ddoc_rate = sd(st.ddoc, na.rm = T),
            total.ddoc_rate = mean(total.ddoc, na.rm = T),
            sd_total.ddoc_rate = sd(total.ddoc, na.rm = T),
            stations = n()
            
            ) %>% 
  mutate_at(vars(accm:sd_st.bv, pers, sd_pers), round, 1) %>% 
  mutate_at(vars(contains(c("per_", "rate"))), round) %>% 
  arrange(factor(Season, levels = levels))
```

```{r echo = FALSE, results = 'asis'}
kable(bioav.table2, caption = "Seasonal Accumulated DOC Bioavailability and Persistance")
```

# Bar plots: Experiment ∆DOC and %Bioavailability


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 12, fig.align = "center", warning = FALSE}
# δDOC
ddoc.bar <- doc %>% 
  filter(!Cruise == "AT32") %>% 
  drop_na(total.bioav_accm_doc) %>% 
  select(Season:Subregion, degree_bin, total.bioav_accm_doc, st.bioav_accm_doc) %>% 
  distinct() %>% 
  pivot_longer(cols = c(total.bioav_accm_doc, st.bioav_accm_doc), names_to = "names", values_to = "values") %>%  
  mutate(names = ifelse(names == "total.bioav_accm_doc", "Long-term", "Short-term" )) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = values, fill = names, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  labs(x = expression(italic("")), y = expression(italic(paste("Bioavailable DOC, µmol C L"^-1))), colour = expression(italic(""))) +
  scale_fill_manual(values = custom.colors) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  #guides(fill = F)

#percent bioav
bioav_doc.bar <- doc %>% 
  filter(!Cruise == "AT32") %>% 
  drop_na(total.bioav_accm_doc) %>% 
  select(Season:Subregion, degree_bin, total.per_bioav, st.per_bioav) %>% 
  distinct() %>% 
  pivot_longer(cols = c(total.per_bioav, st.per_bioav), names_to = "names", values_to = "values") %>%  
  mutate(names = ifelse(names == "total.per_bioav", "Long-term", "Short-term" )) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  values, fill = names, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("Bioavailable DOC, %"))), colour = expression(italic(""))) +
  scale_fill_manual(values = custom.colors) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)


ddoc.bar / bioav_doc.bar + 
  plot_annotation(caption = "Experiemnts without long-term DOC bioavailability estimates have been omitted from this plot", tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))

```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 6, fig.align = "center", warning = FALSE}
# δDOC
ddoc44.bar <- doc %>% 
  filter(!Cruise == "AT32", degree_bin == 44) %>% 
  select(Season:Subregion, degree_bin, total.bioav_accm_doc, st.bioav_accm_doc) %>% 
  distinct() %>% 
  pivot_longer(cols = c(total.bioav_accm_doc, st.bioav_accm_doc), names_to = "names", values_to = "values") %>%  
  mutate(names = ifelse(names == "total.bioav_accm_doc", "Long-term", "Short-term" )) %>% 
  ##PLOT
  ggplot(aes(x = factor(Season, levels = levels), y = values, fill = names, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, width = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("Bioavailable DOC, µmol C L"^-1))), colour = expression(italic(""))) +
  scale_fill_manual(values = custom.colors) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() 
  #facet_grid(~factor(Season, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  #guides(fill = F)

#percent bioav
bioav_doc44.bar <- doc %>% 
  filter(!Cruise == "AT32", degree_bin == 44) %>% 
  select(Season:Subregion, degree_bin, total.per_bioav, st.per_bioav) %>% 
  distinct() %>% 
  pivot_longer(cols = c(total.per_bioav, st.per_bioav), names_to = "names", values_to = "values") %>%  
  mutate(names = ifelse(names == "total.per_bioav", "Long-term", "Short-term" )) %>% 
  ##PLOT
  ggplot(aes(x = factor(Season, levels = levels), y =  values, fill = names, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, width = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("Bioavailable DOC, %"))), colour = expression(italic(""))) +
  scale_fill_manual(values = custom.colors) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  #facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)


ddoc44.bar / bioav_doc44.bar + 
  plot_annotation(title = "44˚N", tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))

```

# Table: NPP and BCD

NPP and BCD are converted to: mmol C m^-3^ d^-1^

```{r message = F}
bcd_table <- bcd %>% 
  select(Cruise:degree_bin, ave_int.BCD, sd_int.BCD) %>% 
  distinct() %>% 
  mutate_at(vars(ave_int.BCD, sd_int.BCD), funs(./10^3)) %>% 
  distinct() %>% 
  left_join(., bcd %>%
              group_by(Cruise, Station) %>% 
              mutate(ave_Ez = mean(Ez, na.rm = T),
                     sd_Ez = sd(Ez, na.rm = T)) %>% 
              ungroup() %>% 
              select(Cruise:degree_bin, ave_Ez, sd_Ez, ave_int.NPP, sd_int.NPP) %>% 
              distinct() %>% 
              mutate_at(vars(contains("NPP")), funs(round(./10^3, 2)))
            ) %>% 
  left_join(., bcd %>% 
              select(Cruise:degree_bin, ave_bcd.npp, sd_bcd.npp) %>% 
              distinct()
            ) %>% 
  select(Cruise:degree_bin, ave_Ez:sd_int.NPP, everything()) %>% 
  mutate_at(vars(ave_Ez, sd_Ez), round) %>% 
  mutate_at(vars(ave_int.NPP:sd_int.BCD), round, 2) %>% 
  arrange(factor(Season, levels = levels), degree_bin)
```

```{r echo = FALSE, results = 'asis'}
kable(bcd_table, caption = "BCD & NPP")
```

```{r}
bcd_table2 <- bcd_table %>% 
  group_by(Cruise) %>% 
  summarize(Ez = mean(ave_Ez),
            sd_Ez = sd(ave_Ez),
            NPP = mean(ave_int.NPP), 
            sd_NPP = sd(ave_int.NPP),
            BCD = mean(ave_int.BCD),
            sd_BCD = sd(ave_int.BCD),
            BCD_NPP = mean(ave_bcd.npp),
            sd_BCD_NPP = sd(ave_bcd.npp))
```


# Bar plots: BCD and BCD:NPP

We'll convert BCD and NPP to mmol C m^-3^ d^-1^ before plotting. 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 12, fig.align = "center", warning = FALSE}
bcd.bar <- bcd %>% 
  select(Cruise:degree_bin, contains("_int.")) %>% 
  distinct() %>% 
  mutate(bge = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge),
         bge = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge)) %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
   mutate_at(vars(ave_int.BCD, sd_int.BCD), funs(./10^3)) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave_int.BCD, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
  geom_errorbar(aes(ymin = ave_int.BCD - sd_int.BCD, ymax = ave_int.BCD + sd_int.BCD), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  geom_text(aes(label = bge, y = ave_int.BCD + 0.07), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 

bcd.npp.bar <- bcd %>% 
  select(Cruise:degree_bin, ave_int.NPP, ave_int.BCD) %>% 
  distinct() %>% 
   mutate(bge = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge),
         bge = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge)) %>% 
  pivot_longer(cols = c(ave_int.NPP, ave_int.BCD), names_to = "names", values_to = "ave") %>%  
  mutate(names = ifelse(names %in% c("ave_int.BCD"), "BCD", "NPP"),
         degree_bin = as.character(degree_bin),
         bge = ifelse(names == "BCD", NA, bge)) %>% 
  left_join(., bcd %>% 
  select(Cruise:degree_bin, sd_int.NPP, sd_int.BCD) %>% 
  distinct() %>% 
   mutate(bge = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge),
         bge = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge)) %>% 
  pivot_longer(cols = c(sd_int.NPP, sd_int.BCD), names_to = "names", values_to = "sd") %>%  
  mutate(names = ifelse(names %in% c("sd_int.BCD"), "BCD", "NPP"),
         degree_bin = as.character(degree_bin),
         bge = ifelse(names == "BCD", NA, bge))
  ) %>% 
  ungroup() %>% 
  mutate_at(vars(ave, sd), funs(./10^3)) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, fill = factor(names, levels = c("NPP", "BCD")), y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
    geom_text(aes(label = bge, y = ave + 0.4), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  theme(legend.position = "right",
        legend.title = element_blank()) 

ratio.bar <- bcd %>% 
  select(Cruise:degree_bin, ave_bcd.npp, sd_bcd.npp) %>% 
  distinct() %>% 
  mutate(bge = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge),
         bge = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge)) %>%  
  mutate(degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave_bcd.npp, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1,  fill = "#999999") +
  geom_errorbar(aes(ymin = ave_bcd.npp - sd_bcd.npp, ymax = ave_bcd.npp + sd_bcd.npp), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
   geom_text(aes(label = bge, y = ave_bcd.npp + 12), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("BCD:NPP"))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank())
  
bcd.bar / bcd.npp.bar / ratio.bar +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 14))
```


# Merge DOC and BCD data

Here we merge the integrated and depth-normalized data. We'll also convert:

- BCD to mmol C m^-3^ d^-1^
- BC to mmol C m^-3^
- NPP to mmol C m^-3^ d^-1^
- ∆DOC to mmol C m^-3^ (µmol C L^-1^)


```{r message = F}

bcd_bioav <- bcd %>% 
  group_by(Cruise, Station) %>%
  mutate(ave_Ez = mean(Ez, na.rm = T),
         sd_Ez = sd(Ez, na.rm = T)) %>% 
  ungroup() %>% 
  select(Cruise:degree_bin, contains(c("_Ez", "_int.", "_bcd.npp"))) %>% distinct() %>% 
  mutate(Station = as.character(Station)) %>% 
  left_join(., doc %>% 
              select(Cruise:Subregion, degree_bin, ave_int_delta_DOC_ez, sd_int_delta_DOC_ez, accm_doc:bge) %>%
              distinct() %>% 
              mutate(degree_bin = as.numeric(degree_bin))
            ) %>% 
  mutate_at(vars(ave_int.bc_i:sd_int.NPP, ave_int.BCD, sd_int.BCD),
            funs(round(./10^3, 2))) %>% 
  mutate_at(vars(ave_int_delta_DOC_ez, sd_int_delta_DOC_ez),
            funs(round(./ave_Ez * 10^3, 2))) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_int.mew = (ave_int.mew_i + ave_int.mew_s)/2,
         sd_int.mew = sqrt(mean(c((ave_int.mew_i - ave_int.mew)^2,  (ave_int.mew_s - ave_int.mew)^2))))
```


# Regressions: Property-Property 

## ** BCD v NPP

```{r echo = FALSE}
reg1 <- lmodel2(ave_int.BCD ~ ave_int.NPP, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg1
```

## BCD v Seasonally Accumulated DOC

```{r echo = FALSE}
reg2 <- lmodel2(ave_int.BCD ~ ave_int_delta_DOC_ez, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg2
```


## BCD v % DOC Bioavailability

```{r echo = FALSE}
reg3 <- lmodel2(ave_int.BCD ~ total.per_bioav, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg3
```


```{r echo = FALSE}
reg4 <- lmodel2(ave_int.BCD ~ st.per_bioav, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg4
```

## BCD v DOC removal rate

```{r echo = FALSE}
reg5 <- lmodel2(ave_int.BCD ~ total.ddoc, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg5
```

```{r echo = FALSE}
reg6 <- lmodel2(ave_int.BCD ~ st.ddoc, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg6
```


## ** µ v NPP 

```{r echo = FALSE}
reg7 <- lmodel2(ave_int.mew_i ~ ave_int.NPP, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg7
```

## µ v Seasonally Accumulated DOC 

```{r echo = FALSE}
reg8 <- lmodel2(ave_int.mew ~ ave_int_delta_DOC_ez, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg8
```

## µ v % DOC Bioavailability

```{r echo = FALSE}
reg9 <- lmodel2(ave_int.mew ~ total.per_bioav, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg9
```

```{r echo = FALSE}
reg10 <- lmodel2(ave_int.mew_i ~ st.per_bioav, data = bcd_bioav, nperm = 99)
```

```{r echo = FALSE}
reg10
```

# Plots: Property-Property

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 16, fig.align = "center", warning = FALSE}
reg1.plot <- bcd_bioav %>% 
  ggplot(aes(x = ave_int.NPP, y = ave_int.BCD)) + 
  geom_abline(intercept = reg1$regression.results[3,2],
              slope = reg1$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_int.BCD - sd_int.BCD, ymax = ave_int.BCD + sd_int.BCD), width = 0.05) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_int.NPP - sd_int.NPP, xmax = ave_int.NPP + sd_int.NPP), height = 0.01) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.18x + 0.07", paste("r"^2," = 0.70, ", italic("p "), "<< 0.01"))), x = 3.1, y = 0.08, size = 4) 
  
reg2.plot  <- bcd_bioav %>% 
  ggplot(aes(x = ave_int_delta_DOC_ez, y = ave_int.BCD)) + 
  geom_abline(intercept = reg2$regression.results[3,2],
              slope = reg2$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_int.BCD - sd_int.BCD, ymax = ave_int.BCD + sd_int.BCD), width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC, mmol C m"^-3))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F, fill = F) +
  annotate( geom = "text", label = expression(atop("y = -0.07x + 0.45", paste("r"^2," = 0.04, ", italic("p "), "= 0.78"))), x = 6.95, y = 0.58, size = 4) 

reg4.plot  <- bcd_bioav %>% 
  ggplot(aes(x = st.per_bioav, y = ave_int.BCD)) + 
  geom_abline(intercept = reg4$regression.results[3,2],
              slope = reg4$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_int.BCD - sd_int.BCD, ymax = ave_int.BCD + sd_int.BCD), width = 0.8) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste("Short-term Bioavailability of Seasonally Accumulated DOC, %"))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F, fill = F) +
  annotate( geom = "text", label = expression(atop("y = 0.01x + 0.02", paste("r"^2," = 0.07, ", italic("p "), "= 0.33"))), x = 69, y = 0.09, size = 4) 

reg7.plot <- bcd_bioav %>% 
  ggplot(aes(x = ave_int.NPP, y = ave_int.mew_i)) + 
  geom_abline(intercept = reg7$regression.results[3,2],
              slope = reg7$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_int.mew_i - sd_int.mew_i, ymax = ave_int.mew_i + sd_int.mew_i), width = 0.05) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_int.NPP - sd_int.NPP, xmax = ave_int.NPP + sd_int.NPP), height = 0.002) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 1) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("µ, d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F, fill = F) +
  annotate( geom = "text", label = expression(atop("y = 0.04x + 0.01", paste("r"^2," = 0.42, ", italic("p "), "<< 0.01"))), x = 3.1, y = 0.015, size = 4) 


(reg1.plot + reg2.plot) / (reg7.plot + reg4.plot) + plot_annotation(tag_levels = "a")

```












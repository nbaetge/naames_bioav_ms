---
title: "NAAMES DOC Remineralization Bioassays - Bottles"
author: "Nicholas Baetge"
date: "2/29/2020"
output: github_document
---

# Intro

This document shows how **individual bottle** data from NAAMES DOC remineralization bioassays were processed, QC'd, and analyzed. 

```{r message = F, warning = F}
library(tidyverse) 
library(rmarkdown)
library(knitr)
library(readxl)
library(data.table) 
library(scales)
library(zoo)
library(oce)
library(patchwork)
#rmarkdown tables
library(stargazer)
library(pander)
library(growthcurver)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
```


```{r include = FALSE}
custom_theme <- function() {
  theme_test(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom_theme_linedraw <- function() {
  theme_linedraw(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "A" = "#E41A1C", "B" = "#377EB8", "C" = "#4DAF4A", "D" = "#FF7F00", "E" = "#FDB927", "F" = "#552583", "G" = "#FDB927", "H" = "#552583",   "Control" = "#E41A1C", "TW12" = "#377EB8", "T. Weissflogii 12C Exudate" = "#377EB8", "TW13" = "#4DAF4A", "T. Weissflogii 13C Exudate" = "#4DAF4A", "MixDS" = "#377EB8", "Deep Comm., Surface DOM" = "#377EB8","MixSD" = "#4DAF4A", "Surface Comm., Deep DOM" = "#4DAF4A", "SynLys" = "#377EB8", "Synechococcus Lysate" = "#377EB8", "SynExd" = "#4DAF4A", "Synechococcus Exudate" = "#4DAF4A", "TWExd" = "#FF7F00", "T. Weissflogii Exudate" = "#FF7F00", "TW5" = "#377EB8", "TW10" = "#4DAF4A", "TW20" = "#FF7F00", "Parallel" = "#377EB8", "W" = "#552583", "Whole Seawater" = "#552583", "1.2" = "#4DAF4A", "1.2 µm Filtrate" = "#4DAF4A", "NV" = "#FF7F00", "1.2 µm Filtrate: TFF Filtrate (3:7)" = "#FF7F00", "Carbon" = "#E41A1C", "Nitrogen" = "#377EB8", "+5 µmol C/L Exudate" = "#FF7F00", "+10 µmol C/L Exudate" = "#FF7F00", "+20 µmol C/L Exudate" = "#FF7F00", "Filter 1" = "#E41A1C", "Filter 2" = "#377EB8", "10 m" = "#E41A1C", "200 m" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A" , "Cruise Specific BGE" = "#377EB8", "Global BGE" = "#4DAF4A") 

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )


levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn",  "Summer", "Late Autumn", "Control", "Parallel", "SynLys", "SynExd", "TWExd", "MixSD", "MixDS", "TW12", "TW13", "TW5", "TW10", "TW20",  "Surface Comm., Deep DOM", "Deep Comm., Surface DOM", "Synechococcus Exudate", "Synechococcus Lysate", "T. Weissflogii Exudate", "T. Weissflogii 12C Exudate", "T. Weissflogii 13C Exudate", "+5 µmol C/L Exudate", "+10 µmol C/L Exudate","+20 µmol C/L Exudate", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "W", "Whole Seawater","1.2", "1.2 µm Filtrate","NV", "1.2 µm Filtrate: TFF Filtrate (3:7)")
```







## BA, BP, BCD, µ, and NPP

We'll estimate BCD for each station of all the cruises using bacterial production and the global average BGE of 24%. Parameters are integrated to euphotic zone determined by Fox et al 2020. Not that we'll be averaging casts taken throughout the day/night. 

```{r}
#import and wrangle NPP data
#we'll convert NPP from mg C/ m2 / d to umol C/ m2 / d 
npp <- read_xlsx("Input/NPP for Nick.xlsx", sheet = 2) %>% 
  filter(!station %in% c("NA","N4S2RF")) %>% 
  separate(station, into = c("Cruise", "Station"), sep = "S") %>% 
  select(-Cruise) %>% 
  mutate(Cruise = ifelse(Bloom_phase == "Accumulation phase", "AT39", NA),
         Cruise = ifelse(Bloom_phase == "Climax transition", "AT34", Cruise),
         Cruise = ifelse(Bloom_phase == "Equilibrium phase", "AT38", Cruise),
         Cruise = ifelse(Bloom_phase == "Winter transition", "AT32", Cruise)) %>% 
  select(Cruise, Station, Ez, Ez_NPP) %>% 
  mutate(Station = ifelse(Station %in% c("4a", "4b", "4c", "4d"), 4, Station),
         Station = ifelse(Station %in% c("6a", "6b", "6c", "6d", "6e"), 6, Station),
         Station = as.numeric(Station)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_Ez = mean(Ez),
         sd_Ez = sd(Ez),
         Ez_NPP = Ez_NPP * (10^3/12),
         ave_NPP = mean(Ez_NPP),
         sd_NPP = sd(Ez_NPP)) %>%
  ungroup() %>% 
  select(-c(Ez, Ez_NPP)) %>% 
  distinct() %>% 
  mutate_at(vars(ave_Ez:sd_NPP), round)
```



```{r warning = F, message = F}
#import bact data and join with npp data
bact <- read_rds("Input/processed_bf.2.2020.rds") %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 50, 75, 100, 150, 200, 300, 400, 500, 750, 1000, 1250, 1500 )) %>% 
  select(Cruise:Station, degree_bin, CampCN, Target_Z, BactProd_C, BactProd_C_sd, BactAbund, BactAbund_sd, contains("Influx"), interp_phytodetritus) %>%  
  group_by(Cruise, Station, CampCN, Target_Z) %>% 
  mutate(phyto = interp_Pro_Influx + interp_Syn_Influx + interp_Nano_Influx + interp_Pico_Influx) %>% 
  ungroup() %>% 
  select(-contains("Influx")) %>% 
  mutate(Cruise = gsub("AT39-6", "AT39", Cruise)) %>% 
  mutate(degree_bin = ifelse(Cruise == "AT34" & Station == 4, 48, degree_bin)) %>% 
  mutate_at(vars(BactProd_C:BactProd_C_sd), round, 2) %>% 
  filter(!is.na(BactProd_C) | Target_Z == 0) %>% 
  group_by(Cruise, Station, CampCN) %>% 
  fill(BactProd_C:BactAbund_sd, .direction = "up") %>% 
  drop_na(BactProd_C) %>% 
  rename(Depth = Target_Z,
         bp = BactProd_C, 
         sd_bp = BactProd_C_sd,
         ba = BactAbund,
         sd_ba = BactAbund_sd,
         phytodet = interp_phytodetritus) %>% 
  mutate(max_depth = max(Depth, na.rm = T)) %>% 
  ungroup() %>% 
  select(Cruise:CampCN, max_depth, Depth,  everything()) %>% 
  left_join(., npp) %>% 
  select(Cruise:max_depth, ave_Ez:sd_NPP, everything()) 

#interpolate data for Ez depth
#split the df by CampCN  
add_ez.list <- split(bact, bact$CampCN)

#create a function to add an empty row to each cast, then add the Ez to the Target Z column 
add.func <- function(morty){
  morty[nrow(morty) + 1,] <- NA
  morty$Depth[is.na(morty$Depth)] <- morty$ave_Ez
  rick <- morty %>% 
    fill(., Cruise:sd_NPP, .direction = c("updown")) %>% 
    arrange(CampCN, Depth)
 }

#apply function to list 
added_ez.list <- lapply(add_ez.list, add.func)


#save the list as a data frame 
added_ez.df <- plyr::ldply(added_ez.list, data.frame) %>% 
  drop_na(Depth) %>% 
  select(-.id)  %>% 
  group_by(Cruise, Station, CampCN, Depth) %>% 
  fill(bp:phyto, .direction = "downup") %>% 
  ungroup() %>% 
  distinct()

#split the data frame into lists based on the campaign cast number
to_interpolate.list <- split(added_ez.df, added_ez.df$CampCN)

#create a function that will linearly interpolate each VOI according to the depth intervals of the casts 
interpolate.func <- function(copper) {
to_interpolate.df <- copper %>% 
  select(Depth:ncol(.)) %>% 
  zoo(., order.by = .$Depth) 

interp_bp <- as.numeric(na.approx(to_interpolate.df$bp, na.rm = F))
interp_ba <- as.numeric(na.approx(to_interpolate.df$ba, na.rm = F))
interp_phytodet <- as.numeric(na.approx(to_interpolate.df$phytodet, na.rm = F))
interp_phyto <- as.numeric(na.approx(to_interpolate.df$phyto, na.rm = F))
Depth <- to_interpolate.df$Depth
interpolations.df <- data.frame(Depth, interp_bp, interp_ba, interp_phytodet, interp_phyto)
}

#apply function to list 
interpolations.list <- lapply(to_interpolate.list, interpolate.func)

#save the list as a data frame 
interpolations.df <- plyr::ldply(interpolations.list, data.frame) %>% 
  rename(., CampCN = .id) 

#combine the interpolated and non-interpolated data frames
interpolations.df$CampCN <- as.numeric(interpolations.df$CampCN)
interpolated.df <- right_join(bact, interpolations.df) %>% 
  fill(Cruise:max_depth, .direction = "downup") %>% 
  group_by(Cruise, Station, CampCN) %>% 
  fill(ave_Ez:sd_NPP, .direction = "updown") %>% 
  ungroup() %>% 
  mutate_at(vars(interp_bp), round, 2)

#calculate bcd and specific growth rates
bcd <- interpolated.df %>% 
  mutate(cr_bge = ifelse(Cruise == "AT32", 0.22, NA),
         cr_bge = ifelse(Cruise == "AT34", 0.26, cr_bge),
         cr_bge = ifelse(Cruise == "AT38", 0.22, cr_bge),
         cr_bge = ifelse(Cruise == "AT39", 0.26, cr_bge),
         cr_i.ccf = ifelse(Cruise == "AT32", 50, NA),
         cr_i.ccf = ifelse(Cruise == "AT34", 13, cr_i.ccf),
         cr_i.ccf = ifelse(Cruise == "AT38", 50, cr_i.ccf),
         cr_i.ccf = ifelse(Cruise == "AT39", 20, cr_i.ccf),
         cr_s.ccf = ifelse(Cruise == "AT32", 31, NA),
         cr_s.ccf = ifelse(Cruise == "AT34", 15, cr_s.ccf),
         cr_s.ccf = ifelse(Cruise == "AT38", 31, cr_s.ccf),
         cr_s.ccf = ifelse(Cruise == "AT39", 22, cr_s.ccf),
         bge = 0.24,
         #bp in nmol C / L / d is equivalent to  µmol C / m3 / d 
         bcd.cr_bge = interp_bp/cr_bge,
         bcd = interp_bp/bge,
         # bact carbon in µmol C/m3
         bc.i = interp_ba * (10^3) * cr_i.ccf * (1/10^15) * (1/12) * 10^6,
         bc.s = interp_ba * (10^3) * cr_s.ccf * (1/10^15) * (1/12) * 10^6)  %>%
  mutate_at(vars(bcd, bcd.cr_bge), round) %>% 
  group_by(Cruise, Station, Depth) %>% 
  mutate(bcd.stat.cr_bge = mean(bcd.cr_bge, na.rm = T),
         bcd.stat = mean(bcd, na.rm = T),
         #convert to cells / m3
         ba.stat = mean(interp_ba, na.rm = T) * 1000,
         sd_ba.stat = sd(interp_ba, na.rm = T) * 1000,
         bp.stat = mean(interp_bp, na.rm = T),
         sd_bp.stat = sd(interp_bp, na.rm = T),
         bc.i.stat = mean(bc.i, na.rm = T),
         sd_bc.i.stat = sd(bc.i, na.rm = T),
         bc.s.stat = mean(bc.s, na.rm = T),
         sd_bc.s.stat = sd(bc.s, na.rm = T),
         phytodet.stat = mean(interp_phytodet, na.rm = T),
         phyto.stat = mean(interp_phyto, na.rm = T)) %>% 
  mutate_at(vars(bcd.stat.cr_bge, bcd.stat), round) %>% 
 # mutate_at(vars(sp_gr.i.ccf.stat:sd_sp_gr.s.ccf.stat), round, 4) %>% 
  ungroup() %>% 
  group_by(Cruise, Subregion, Depth) %>% 
  mutate(ba.cr.sr = mean(interp_ba, na.rm = T) * 1000,
         sd_ba.cr.sr = sd(interp_ba, na.rm = T) * 1000,
         bp.cr.sr = mean(interp_bp, na.rm = T),
         sd_bp.cr.sr = sd(interp_bp, na.rm = T)) %>% 
  ungroup() %>% 
  select(Cruise:degree_bin, ave_Ez:sd_NPP, bge, cr_bge, Depth, contains("stat"), contains("sr")) %>% 
  distinct() 


int_bcd_100 <- bcd %>% 
  group_by(Cruise, Station) %>% 
  filter(Depth <= 100) %>% 
  mutate(int.bcd.cr_bge.100 = integrateTrapezoid(Depth, bcd.stat.cr_bge, type = "A"),
         int.bcd.100 = integrateTrapezoid(Depth, bcd.stat, type = "A"))  %>% 
  mutate_at(vars(contains("int.bcd")), round) %>% 
  # depth normalize 
  mutate_at(vars(int.bcd.cr_bge.100:int.bcd.100), funs(./100)) %>% 
  select(Cruise:degree_bin, int.bcd.cr_bge.100, int.bcd.100) %>% 
  distinct()


int_bcd <- bcd %>% 
  group_by(Cruise, Station) %>% 
  filter(Depth <= ave_Ez) %>% 
  mutate(int.bcd.cr_bge.ez = integrateTrapezoid(Depth, bcd.stat.cr_bge, type = "A"),
         int.bcd.ez = integrateTrapezoid(Depth, bcd.stat, type = "A"),
         int.bp.ez = integrateTrapezoid(Depth, bp.stat, type = "A"),
         sd_int.bp.ez = integrateTrapezoid(Depth, sd_bp.stat, type = "A"),
         int.ba.ez = integrateTrapezoid(Depth, ba.stat, type = "A"),
         sd_int.ba.ez = integrateTrapezoid(Depth, sd_ba.stat, type = "A"),
         int.bc.i.ez = integrateTrapezoid(Depth, bc.i.stat, type = "A"),
         int.bc.s.ez = integrateTrapezoid(Depth, bc.s.stat, type = "A"),
         int.phyodet.ez = integrateTrapezoid(Depth, phytodet.stat, type = "A"),
         int.phyto.ez = integrateTrapezoid(Depth, phyto.stat, type = "A"))  %>% 
  mutate_at(vars(contains("int.bcd"), contains("bcd.ez_npp")), round) %>% 
  # depth normalize 
  mutate_at(vars(int.bcd.cr_bge.ez:int.phyto.ez), funs(./ave_Ez)) %>% 
  mutate(int.NPP = ave_NPP/ave_Ez,
         sd_int.NPP = sd_NPP/ave_Ez, 
         mew.i = int.bp.ez/int.bc.i.ez,
         mew.s = int.bp.ez/int.bc.s.ez,
         bcd.ez_npp.cr_bge = int.bcd.cr_bge.ez/int.NPP * 100,
         bcd.ez_npp = int.bcd.ez/int.NPP * 100) %>% 
  select(Cruise:cr_bge, int.bcd.cr_bge.ez:bcd.ez_npp, Depth, contains("stat"), contains("cr.sr")) %>% 
  distinct() %>% 
  ungroup() %>% 
  left_join(., int_bcd_100)
    



```



```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}
int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.bcd.ez, int.bcd.cr_bge.ez) %>% 
  distinct() %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
  mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.ez, int.bcd.ez), names_to = "bcd", values_to = "value") %>%  
  mutate(bcd = ifelse(bcd == "int.bcd.cr_bge.ez", "Cruise-Specific BGE", "Campaign BGE"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(value)/10^3,
         sd = sd(value)/10^3) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  geom_text(aes(label = bge_stat, y = ave + 0.1), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}
int_bcd %>% 
  select(Cruise:Station, degree_bin, bcd.ez_npp.cr_bge, bcd.ez_npp ) %>% 
  distinct() %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
   mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(bcd.ez_npp.cr_bge, bcd.ez_npp), names_to = "bcd_npp", values_to = "value") %>%  
  mutate(bcd_npp = ifelse(bcd_npp == "bcd.ez_npp.cr_bge", "Cruise-Specific BGE", "Campaign BGE"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(value),
         sd = sd(value)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
   geom_text(aes(label = bge_stat, y = ave + 10), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("BCD:NPP"))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank())
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.bcd.cr_bge.ez, int.bcd.ez) %>% 
  distinct() %>% 
   mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(int.NPP, int.bcd.cr_bge.ez, int.bcd.ez), names_to = "rate", values_to = "value") %>%  
  mutate(rate = ifelse(rate %in% c("int.bcd.cr_bge.ez", "int.bcd.ez"), "BCD", "NPP"),
         degree_bin = as.character(degree_bin),
         bge_stat = ifelse(rate == "BCD", NA, bge_stat)) %>% 
  group_by(Cruise, Station, rate) %>% 
  mutate(ave = mean(value)/10^3,
         sd = sd(value)/10^3,
         sd = ifelse(rate == "NPP", sd_int.NPP/10^3, sd )) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, fill = factor(rate, levels = c("NPP", "BCD")), y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
    geom_text(aes(label = bge_stat, y = ave + 1), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.NPP, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.NPP - sd_int.NPP, ymax = int.NPP + sd_int.NPP), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.bp.ez, sd_int.bp.ez) %>% 
  distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.bp.ez, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.bp.ez - sd_int.bp.ez, ymax = int.bp.ez + sd_int.bp.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BP, µmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.ba.ez, sd_int.ba.ez) %>% 
  distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.ba.ez, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.ba.ez - sd_int.ba.ez, ymax = int.ba.ez + sd_int.ba.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BA, cells m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, mew.i, mew.s) %>% 
  distinct() %>% 
  pivot_longer(cols = c(mew.i, mew.s), names_to = "ccf", values_to = "mew") %>%  
  mutate(ccf = ifelse(ccf == "mew.i", "Initial CCF", "Stationary CCF"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(mew),
         sd = sd(mew)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("µ, d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```
 
#### organized by NPP 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

bp <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.bp.ez, sd_int.bp.ez) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int.bp.ez, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), color = "black",  position = position_dodge(), stat = "identity",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = int.bp.ez - sd_int.bp.ez, ymax = int.bp.ez + sd_int.bp.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = "", y = expression(italic(paste("BP, µmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() 
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
 # guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

ba <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.ba.ez, sd_int.ba.ez) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(contains("ba")), funs(round(./10^12, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int.ba.ez, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = int.ba.ez - sd_int.ba.ez, ymax = int.ba.ez + sd_int.ba.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = "", y = expression(italic(paste("BA, * 10"^12, " cells  m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() +
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F, linetype = F)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

mew <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, mew.s, mew.i) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  pivot_longer(cols = c(mew.s, mew.i), names_to = "CCF", values_to = "mew") %>%  
  mutate(CCF = ifelse(CCF == "mew.i", "Initial", "Stationary")) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(mew),
         sd = sd(mew)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  ave, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("µ, fmol C cell"^-1, "m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
   scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() +
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F, linetype = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 14, fig.align = "center", warning = FALSE}
bp + ba + mew + plot_layout(ncol = 1, nrow = 3)
```


```{r}
bcd_table <- int_bcd %>% 
  select(Cruise:Station, degree_bin,  int.bcd.cr_bge.ez, int.bcd.ez) %>% 
  distinct() %>% 
  mutate_at(vars(int.bcd.cr_bge.ez, int.bcd.ez), funs(./1000)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.ez, int.bcd.ez), names_to = "var", values_to = "bcd") %>% 
  select(-var) %>% 
  distinct() %>% 
  group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
  summarise(ave_BCD = round(mean(bcd), 2),
            sd_BCD = round(sd(bcd), 2)) %>% 
  ungroup() %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin,  ave_Ez, sd_Ez, int.NPP, sd_int.NPP) %>% 
              distinct() %>% 
              mutate_at(vars(contains("NPP")), funs(round(./10^3, 2)))) %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin,   bcd.ez_npp.cr_bge, bcd.ez_npp) %>% 
              distinct() %>% 
              pivot_longer(cols = c( bcd.ez_npp.cr_bge, bcd.ez_npp), names_to = "var", values_to = "bcd_npp") %>% 
              select(-var) %>% 
              distinct() %>% 
              group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
              summarise(ave_BCD_NPP = mean(bcd_npp),
                        sd_BCD_NPP = sd(bcd_npp)) %>% 
              ungroup()
            
            ) %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin, int.bcd.cr_bge.100, int.bcd.100) %>% 
              distinct() %>% 
              pivot_longer(cols = c( int.bcd.cr_bge.100, int.bcd.100), names_to = "var", values_to = "bcd_100") %>% 
              select(-var) %>% 
              distinct() %>% 
              group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
              summarise(ave_BCD_100 = mean(bcd_100),
                        sd_BCD_100 = sd(bcd_100)) %>% 
              ungroup()
            
            ) %>% 
  arrange(factor(Season, levels = levels)) %>% 
  group_by(Cruise) %>% 
  mutate(Cruise_ave_Ez = mean(ave_Ez),
         Cruise_sd_Ez = sd(ave_Ez),
         Cruise_ave_NPP = mean(int.NPP),
         Cruise_sd_NPP = sd(int.NPP),
         Cruise_ave_BCD = mean(ave_BCD),
         Cruise_sd_BCD = sd(ave_BCD),
         Cruise_ave_BCD_NPP = mean(ave_BCD_NPP),
         Cruise_sd_BCD_NPP = sd(ave_BCD_NPP)
         ) %>% 
  ungroup() %>% 
  group_by(Cruise, Subregion) %>% 
  mutate(Cruise_SR_ave_NPP = mean(int.NPP),
         Cruise_SR_sd_NPP = mean(int.NPP),
         Cruise_SR_ave_BCD = mean(ave_BCD),
         Cruise_SR_sd_BCD = sd(ave_BCD),
         Cruise_SR_ave_BCD_NPP = mean(ave_BCD_NPP),
         Cruise_SR_sd_BCD_NPP = sd(ave_BCD_NPP)
         ) %>% 
  ungroup() %>% 
  mutate_at(vars(contains("BCD_NPP")), round) %>% 
  mutate_at(vars(ave_BCD_100:Cruise_sd_BCD, Cruise_SR_ave_NPP:Cruise_SR_sd_BCD ), round, 2) %>% 
  arrange(factor(Season, levels = levels), factor(Subregion, levels = levels))
```
```{r echo = FALSE, results = 'asis'}
kable(bcd_table, caption = "BCD & NPP")
```



```{r echo = FALSE}
bcd_npp.reg <- lmodel2(ave_BCD ~ int.NPP, data = bcd_table , nperm = 99)
```

```{r echo = FALSE}
bcd_npp.reg
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_table %>% 
  ggplot(aes(x = int.NPP, y = ave_BCD)) + 
  geom_abline(intercept = bcd_npp.reg$regression.results[3,2],
              slope = bcd_npp.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_BCD - sd_BCD, ymax = ave_BCD + sd_BCD), width = 0.1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = int.NPP - sd_int.NPP, xmax = int.NPP + sd_int.NPP), width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.17x + 0.07", paste("r"^2,"= 0.71, ", italic("p "), "<< 0.01"))), x = 3, y = 0.1, size = 7) 

```

#### Profiles


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(bp.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ave_Ez, bp.cr.sr, sd_bp.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = bp.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = bp.cr.sr - sd_bp.cr.sr, ymax = bp.cr.sr + sd_bp.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Production, µmol C m"^3, "d"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(ba.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ba.cr.sr, sd_ba.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = ba.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = ba.cr.sr - sd_ba.cr.sr, ymax = ba.cr.sr + sd_ba.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Abundance, Cells m"^3))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

# Merge Data with Export MS Data

Here, we put our experimental data in the context of the results from the export MS to explore remineralization of the seasonally accumulated DOC pool:

- We first calculate treatment averages for each experiment
- For the surface values at each station, we then subtract the DOC concentration of the winter/early springtime deeply mixed condition (from the export MS) from the DOC concentrations in the experiments conducted at the respective station (**norm_doc**).
- We estimate the concentration of the seasonally accumulated DOC pool as the difference between the initial DOC concentration in each experiment and the DOC concentration of the mixed condition (**accm_doc**)
- We then estimate the total DOC drawdown for the experiments (**bioav_doc**), the total remaining DOC after drawdown(**persis_doc**), the percent DOC bioavalability and persistence (**per_bioav** and **per_persis**, respectively)
- Lastly we calculate the rate of DOC drawdown (nmol C L^-1^ d^-1^, **ddoc**)


```{r message = F, warning = F}

export <- readRDS("~/naames_export_ms/Output/processed_export_for_bioavMS.5.14.20.rds") %>% 
  mutate(Cruise = gsub("AT39-6", "AT39", Cruise)) %>% 
  select(Cruise, Season, degree_bin, Subregion, Station, Target_Z, Ez, ave_N, sd_N, ave_PO4, sd_PO4, ave_Pro:sd_Nano, redis_DOC_vol, NCP_mol_100, doc_ncp_100, int_delta_DOC_100, doc_don_100, int_delta_N_100, int_N_100_vol, int_N_ez, int_PO4_100_vol, int_PO4_ez) %>% 
  distinct() %>% 
  mutate_at(vars(redis_DOC_vol, int_N_100_vol, int_PO4_100_vol), round, 1) %>% 
  mutate_at(vars(NCP_mol_100:doc_ncp_100, int_delta_DOC_100, int_delta_N_100, int_N_ez, int_PO4_ez), round, 2) %>%
  mutate_at(vars(doc_don_100), round) %>% 
  mutate_at(vars(Station), as.character) %>% 
  #error associated with the approach in calculating seasonally accumulated DON led to 17%  of total samples (5 of 29) being negative.  As a result these data were removed from further analyses.
  mutate(doc_don_100 = ifelse(doc_don_100 < 0, NA, doc_don_100), 
         total_phyto = ave_Pro + ave_Syn + ave_Pico + ave_Nano)


export_bioav <- left_join(calcs %>% filter(!Station == "U"), export %>% select(-c( Target_Z, ave_N, sd_N, ave_Pro:sd_Nano)) %>%  distinct()) %>% 
  mutate(redis_DOC_vol = ifelse(Station %in% c("S2RD", "S2RF"), 55.0, redis_DOC_vol),
         degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>%  
  group_by(Cruise, Station, Depth, Treatment, Hours) %>% 
  mutate(trt_ave_doc = ifelse(!is.na(interp_doc), round(mean(interp_doc, na.rm = T),1), NA),
         trt_sd_doc = ifelse(!is.na(doc), round(sd(doc, na.rm = T),1), NA)) %>% 
  ungroup() %>% 
  group_by(Cruise, Station, Depth, Treatment) %>% 
  mutate(norm_doc = ifelse(Depth != 200 | Treatment == "MixDS", trt_ave_doc - redis_DOC_vol, NA),
         norm_doc_from_t0 = ifelse(!is.na(norm_doc), first(norm_doc) - norm_doc, NA),
         accm_doc = ifelse(Depth == 10 & Treatment == "Control", first(trt_ave_doc) - redis_DOC_vol, NA),
         total.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, last(trt_ave_doc) - redis_DOC_vol, NA),
         st.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & Days == 7, trt_ave_doc - redis_DOC_vol, NA),
         lt.bioav_accm_doc = total.bioav_accm_doc - st.bioav_accm_doc,
         time.total.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, last(Days), NA),
         time.lt.bioav_accm_doc = time.total.bioav_accm_doc - 7,
         total.bioav_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, first(norm_doc) - last(norm_doc), NA),
         st.bioav_doc = ifelse(Depth == 10 & Treatment == "Control" & Days == 7, first(norm_doc) - norm_doc, NA),
         lt.bioav_doc = total.bioav_doc - st.bioav_doc,
         total.per_bioav = round((total.bioav_doc/accm_doc * 100)),
         st.per_bioav = round((st.bioav_doc/accm_doc * 100)),
         lt.per_bioav = round((lt.bioav_doc/accm_doc * 100)),
         persis_doc = accm_doc - total.bioav_doc,
         per_persis = round((persis_doc/accm_doc * 100)),
         st.ddoc = round((st.bioav_doc/7) * 1000),
         lt.ddoc = round((lt.bioav_doc/time.lt.bioav_accm_doc) * 1000),
         total.ddoc = round((total.bioav_doc/time.total.bioav_accm_doc) * 1000)) %>%   
  ungroup() %>% 
  group_by(Cruise, Station, Depth) %>% 
  fill(accm_doc:lt.ddoc, .direction = "downup") %>% 
  ungroup() %>% 
  select(Season:Station, ave_lat:Subregion, Depth:interp_doc, redis_DOC_vol:lt.ddoc, everything() ) %>% 
  left_join(., int_bcd %>% mutate_at(vars(Station), as.character)) %>% 
  mutate(Subregion = ifelse(Station %in% c("S2RF", "S2RD"), "GS/Sargasso", Subregion ))

    
```



## Nitrate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_N_100_vol) %>% 
  distinct() %>% 
  drop_na(int_N_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
n_ez <-  export %>%
  select(Season, Ez, int_N_ez) %>% 
  mutate(int_N_ez = ((int_N_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_N_ez) 

n_anova <- welch_anova_test(int_N_ez ~ Season, data = n_ez) 
n_anova 
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
n_gh <- games_howell_test(int_N_ez ~ Season, data = n_ez)
n_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

n_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.04")), x = "Early Spring", y = 1.5, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_N) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_N, sd_N) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_N = mean(ave_N),
         group_sd_N = sd(ave_N)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_N, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_N - group_N, ymax = group_N + group_N, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Nitrate, µmol N L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## Phosphate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_PO4_100_vol) %>% 
  distinct() %>% 
  drop_na(int_PO4_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
p_ez <-  export %>%
  select(Season, Ez, int_PO4_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

p_anova <- welch_anova_test(int_PO4_ez ~ Season, data = p_ez) 
p_anova 
```

#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
p_gh <- games_howell_test(int_PO4_ez ~ Season, data = p_ez)
p_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

p_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.21")), x = "Early Spring", y = 0.13, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   p_gh, label = "p.adj.signif",
  #   y.position = c(0.1, 0.12, 0.13, 0.14, 0.15, 0.16)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_PO4) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_PO4, sd_PO4) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_P = mean(ave_PO4),
         group_sd_P = sd(ave_PO4)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_P, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_P - group_P, ymax = group_P + group_P, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Phosphate, µmol P L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## N:P

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
np_ez <-  export %>%
  select(Season, Ez, int_PO4_ez, int_N_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10,
         int_N_ez = ((int_N_ez)/Ez)/10,
         int_NP_ez = int_N_ez/int_PO4_ez) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

np_anova <- welch_anova_test(int_NP_ez ~ Season, data = np_ez) 
np_anova 
```

```{r}
np_ez %>% 
  filter(Season == "Early Spring") %>% 
  summary()
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
np_gh <- games_howell_test(int_NP_ez ~ Season, data = np_ez)
np_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

np_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_NP_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("N:P")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.02")), x = "Early Spring", y = 32, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    np_gh, label = "p.adj.signif",
    y.position = c(25,24,23,29,21,27))
  
```



# ∆DOC

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

export_bioav %>% 
  select(Season:Station, degree_bin, Subregion, ave_Ez, int.NPP, sd_int.NPP, int_delta_DOC_100) %>% 
  drop_na(int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  # expression(italic("NPP, mmol C m"^-3, "d"^-1))
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 14, fig.align = "center", warning = FALSE}

export_bioav %>% 
  select(Season:Station, degree_bin, Subregion, ave_Ez, int.NPP, sd_int.NPP, int_delta_DOC_100) %>% 
  drop_na(int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3,2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1) +
  labs(x = expression(italic("NPP, mmol C m"^-3, "d"^-1)), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) 
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 14, fig.align = "center", warning = FALSE}

export %>% 
  select(Season:Station, degree_bin, Subregion,  int_delta_DOC_100) %>% 
  drop_na(int_delta_DOC_100) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3,2))) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(fill = "#999999", position = position_dodge(), stat = "identity", color = "black",  alpha = 1) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) 
```




```{r}
aov.delta_doc <- export_bioav %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
ddoc_anova <- welch_anova_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc) 
ddoc_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
ddoc_gh <- games_howell_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc)
ddoc_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
library(ggpubr)

export %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_delta_DOC_100)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC, mol C m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    ddoc_gh, label = "p.adj.signif", 
    y.position = c(1.5, 1.4, 1.3, 1.8, 0.45, 1.7)
    )
  
  
```


# DOC:DON

```{r}
aov.cn <- export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  filter(!doc_don_100 > 90) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}

cn_anova <- welch_anova_test(doc_don_100 ~ Season, data = aov.cn) 
cn_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
cn_gh <- games_howell_test(doc_don_100 ~ Season, data = aov.cn)
cn_gh
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = doc_don_100)) +
  geom_boxplot(width = 0.3, outlier.color = "white", outlier.fill = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC:DON")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.15")), x = "Early Spring", y = 95, size = 4, hjust = 0) 
  
  
```

```{r}
export %>%
  select(Season, int_delta_DOC_100, doc_don_100) %>% 
  rename(accm_doc = int_delta_DOC_100) %>% 
  group_by(Season) %>% 
  summarise(ave_accm_doc = round(mean(accm_doc, na.rm = T), 2),
            sd_accm_doc = round(sd(accm_doc, na.rm = T), 2),
            med_accm_doc = round(median(accm_doc, na.rm = T), 2),
            min_accm_doc = round(min(accm_doc, na.rm = T), 2),
            max_accm_doc = round(max(accm_doc, na.rm = T), 2),
            
            ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```

```{r}
export %>%
  select(Season, doc_don_100) %>% 
  group_by(Season) %>% 
  filter(!doc_don_100 > 90) %>% 
  summarise(ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```



# Remineralization of Seasonally Accumulated DOC

### NAAMES 2

#### No Addition

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~degree_bin, scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~Station, scales = "free") +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Station == 2) %>% 
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Station == 2) %>% 
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)
```


## NAAMES 3

#### No Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Treatment == "Control") %>%  
   drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 DOC") + 
  guides(color = F, fill = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Treatment == "Control") %>%  
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 DOC") + 
  guides(color = F, fill = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Station == 1, Treatment %in% c("Control", "SynExd", "SynLys", "TWExd")) %>%
 drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free_y") +
  ggtitle("NAAMES 3 Station 1 Addition Experiment") + 
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Station == 1, Treatment %in% c("Control", "SynExd", "SynLys", "TWExd")) %>%
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free_y") +
  ggtitle("NAAMES 3 Station 1 Addition Experiment") + 
  guides(color = F)


```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Depth == 10, Station %in% c(1, 3, 6), Treatment %in% c("Control", "SynLys")) %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 Addition Experiments") +
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Depth == 10, Station %in% c(1, 3, 6), Treatment %in% c("Control", "SynLys")) %>% 
  drop_na(norm_doc) %>%
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 Addition Experiments") +
  guides(color = F)

```


### NAAMES 4

#### No Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Treatment == "Control") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Station)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Station), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Station), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 4 DOC") +
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Treatment == "Control") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Station)) + 
  geom_point(aes(fill = Station), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Station), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 4 DOC") +
  guides(color = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Station == 2, !Treatment == "Parallel") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~facet_treatment, scales = "free") +
  guides(fill = F, color = F)

```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Station == 2, !Treatment == "Parallel") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~facet_treatment, scales = "free_y") +
  guides(fill = F, color = F)

```

## Seasonal Comparison

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 16, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Season, Cruise, Station, stationary, Subregion, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, T, F),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), T, bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), T, bge_stat)) %>% 
  distinct() %>% 
  filter(Treatment == "Control", Depth == 10) %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Cruise, Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Cruise, Station, degree_bin))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_vline(aes(xintercept = 30), linetype = 3) +
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = bge_stat), size = 0.75, alpha = 0.7) +
  geom_label(aes(x = 7, y = -1, label = "Short-Term"), size = 3) +
  geom_label(aes(x = 30, y = -1, label = "Long-Term"), size = 3) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  guides(color = F, linetype = F)
```

```{r}
bioav.table <- export_bioav %>% 
  filter(Depth == 10, Treatment == "Control") %>% 
  select(Season:Subregion, contains("bioav_doc"), contains("per_bioav"), contains("persis"), contains("ddoc")) %>% 
  distinct() %>% 
  group_by(Season, Subregion) %>% 
  summarise(ave_total.per_bioav = round(mean(total.per_bioav, na.rm = T), 2),
            sd_total.per_bioav = round(sd(total.per_bioav, na.rm = T), 2),
            ave_st.per_bioav = round(mean(st.per_bioav, na.rm = T), 2),
            sd_st.per_bioav = round(sd(st.per_bioav, na.rm = T), 2),
            ave_lt.per_bioav = round(mean(lt.per_bioav, na.rm = T), 2),
            sd_lt.per_bioav = round(sd(lt.per_bioav, na.rm = T), 2),
            
            ave_per_persis = round(mean(per_persis, na.rm = T), 2),
            sd_per_persis = round(sd(per_persis, na.rm = T), 2),
            
            ave_st.ddoc = round(mean(st.ddoc, na.rm = T), 2),
            sd_st.ddoc = round(sd(st.ddoc, na.rm = T), 2),
            ave_lt.ddoc = round(mean(lt.ddoc, na.rm = T), 2),
            sd_lt.ddoc = round(sd(lt.ddoc, na.rm = T), 2),
            ave_total.ddoc = round(mean(total.ddoc, na.rm = T), 2),
            sd_total.ddoc = round(sd(total.ddoc, na.rm = T), 2),
            
            ) %>%
   arrange(factor(Season, levels = levels)) %>% 
  ungroup()
```


```{r echo = FALSE, results = 'asis'}
kable(bioav.table, caption = "Seasonal Accumulated DOC Bioavailability and Persistance")
```


```{r}

bcd_bioav_table <- int_bcd %>% 
  select(Cruise:Station, degree_bin,  int.bcd.cr_bge.100, int.bcd.100, int.bcd.ez) %>% 
  distinct() %>% 
  #convert from µmol C m-3 d-1 to µmol C m-2 d-1
  mutate_at(vars(int.bcd.cr_bge.100:int.bcd.100), funs(./1000)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.100, int.bcd.100), names_to = "var", values_to = "bcd") %>%
  select(-var) %>%
  distinct() %>% 
  group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
  summarise(ave_BCD = mean(bcd),
            sd_BCD = sd(bcd)) %>% 
  ungroup() %>% 
  mutate(Station = as.character(Station)) %>% 
  left_join(. , export) %>% 
   arrange(factor(Season, levels = levels))  %>% 
  filter(!doc_don_100 > 50) 

  
```

```{r}
bcd_bioav.reg_data <- bcd_bioav_table %>% 
  group_by(Cruise, Subregion) %>% 
  mutate(group_bcd = mean(ave_BCD),
         sd_group_bcd = sd(ave_BCD)) %>% 
  select(Cruise:Subregion, group_bcd, sd_group_bcd) %>% 
  distinct() %>% 
  left_join(., bioav.table)

bcd_total_bioav.reg <-  bcd_bioav.reg_data %>% 
  drop_na(ave_total.per_bioav)

bcd_st_bioav.reg_data <-  bcd_bioav.reg_data %>% 
  drop_na(ave_st.per_bioav)
  

```

```{r}
lmodel2(group_bcd ~ ave_total.per_bioav, data = bcd_total_bioav.reg , nperm = 99)
```
```{r}
bcd_st_bioav.reg <- lmodel2(group_bcd ~ ave_st.per_bioav, data = bcd_st_bioav.reg_data, nperm = 99)

bcd_st_bioav.reg 
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_st_bioav.reg_data %>% 
  ggplot(aes(x = ave_st.per_bioav, y = group_bcd)) + 
  geom_abline(intercept = bcd_st_bioav.reg$regression.results[3,2],
              slope = bcd_st_bioav.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = group_bcd - sd_group_bcd, ymax = group_bcd + sd_group_bcd), width = 1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_st.per_bioav - sd_st.per_bioav, xmax = ave_st.per_bioav + sd_st.per_bioav), width = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC % Bioavailability (< 7 d)"))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.006x + 0.08", paste("r"^2,"= 0.64, ", italic("p "), "= 0.03"))), x = 70, y = 0.13, size = 7) 

```


```{r}
bioav.table2 <- export_bioav %>% 
  filter(Depth == 10, Treatment == "Control") %>% 
  select(Season:Subregion, contains("bioav_doc"), contains("per_bioav"), contains("persis"), contains("ddoc")) %>% 
  distinct() %>% 
  group_by(Season, degree_bin, Station) %>% 
  summarise(ave_total.per_bioav = round(mean(total.per_bioav, na.rm = T), 2),
            sd_total.per_bioav = round(sd(total.per_bioav, na.rm = T), 2),
            ave_st.per_bioav = round(mean(st.per_bioav, na.rm = T), 2),
            sd_st.per_bioav = round(sd(st.per_bioav, na.rm = T), 2),
            ave_lt.per_bioav = round(mean(lt.per_bioav, na.rm = T), 2),
            sd_lt.per_bioav = round(sd(lt.per_bioav, na.rm = T), 2),
            
            ave_per_persis = round(mean(per_persis, na.rm = T), 2),
            sd_per_persis = round(sd(per_persis, na.rm = T), 2),
            
            ave_st.ddoc = round(mean(st.ddoc, na.rm = T), 2),
            sd_st.ddoc = round(sd(st.ddoc, na.rm = T), 2),
            ave_lt.ddoc = round(mean(lt.ddoc, na.rm = T), 2),
            sd_lt.ddoc = round(sd(lt.ddoc, na.rm = T), 2),
            ave_total.ddoc = round(mean(total.ddoc, na.rm = T), 2),
            sd_total.ddoc = round(sd(total.ddoc, na.rm = T), 2),
            
            ) %>%
   arrange(factor(Season, levels = levels)) %>% 
  ungroup() %>% 
  left_join(., bcd_bioav_table %>% 
              group_by(Cruise, degree_bin, Station) %>% 
              mutate(group_bcd = mean(ave_BCD),
                     sd_group_bcd = sd(ave_BCD)) %>% 
              select(Cruise:Subregion,degree_bin, group_bcd, sd_group_bcd) %>%
              distinct() )

bcd_total_bioav.reg_data <-  bioav.table2 %>% 
  drop_na(ave_total.per_bioav)

bcd_st_bioav.reg_data <-  bioav.table2 %>% 
  drop_na(ave_st.per_bioav)
```

```{r}
bcd_st_bioav.reg <- lmodel2(group_bcd ~ ave_st.per_bioav, data = bcd_st_bioav.reg_data, nperm = 99)

bcd_st_bioav.reg 
```
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_st_bioav.reg_data %>% 
  ggplot(aes(x = ave_st.per_bioav, y = group_bcd)) + 
  geom_abline(intercept = bcd_st_bioav.reg$regression.results[3,2],
              slope = bcd_st_bioav.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = group_bcd - sd_group_bcd, ymax = group_bcd + sd_group_bcd), size = 0.2, width = 0.1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_st.per_bioav - sd_st.per_bioav, xmax = ave_st.per_bioav + sd_st.per_bioav), size = 0.2, width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Accumulated DOC % Bioavailability (< 7 d)"))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() #+
  #annotate( geom = "text", label = expression(atop("y = 0.006x + 0.08", paste("r"^2,"= 0.64, ", italic("p "), "= 0.03"))), x = 3, y = 0.1, size = 7) 

```

##


```{r echo = FALSE}
bcd_doc.reg <- lmodel2(ave_BCD ~ int_delta_DOC_100, data = bcd_bioav_table , nperm = 99)
```

```{r echo = FALSE}
bcd_doc.reg 
```
```{r echo = FALSE}
bcd_cn.reg <- lmodel2(ave_BCD ~ doc_don_100, data = bcd_bioav_table , nperm = 99)
```

```{r echo = FALSE}
bcd_cn.reg
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_bioav_table %>% 
  select(Season, int_delta_DOC_100, ave_BCD) %>% 
  distinct() %>% 
  ggplot(aes(x = int_delta_DOC_100, y = ave_BCD)) + 
  geom_abline(intercept = bcd_doc.reg$regression.results[3,2],
             slope = bcd_doc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC, mol C m"^-2))), y = expression(italic(paste("BCD, µmol C m"^-2, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
    annotate( geom = "text", label = expression(atop("y = -0.31x + 0.33", paste("r"^2,"= 0.14, ", italic("p "), "= 0.14"))), x = 0.8, y = 0.3, size = 7) 

```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_bioav_table %>% 
  select(Season, doc_don_100, ave_BCD, sd_BCD) %>% 
  distinct() %>%  
  ggplot(aes(x = doc_don_100, y = ave_BCD)) + 
  geom_abline(intercept = bcd_cn.reg$regression.results[3,2],
             slope = bcd_cn.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar( aes(color = factor(Season, levels = levels), ymax = ave_BCD + sd_BCD, ymin = ave_BCD - sd_BCD), width = 0.4) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC:DON"))), y = expression(italic(paste("BCD, mmol C m"^-2, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
    annotate( geom = "text", label = expression(atop("y = -0.01x + 0.32", paste("r"^2,"= 0.09, ", italic("p "), "<< 0.01"))), x = 30, y = 0.4, size = 7) 

```

This seasonal comparison is best exemplifies at 44˚N where we have experiments from all cruises. It shows:

- an increase in the accumulated DOC pool from the early spring to the early autumn
- an increase in the persistent fraction of the bulk DOC as the seasons progress
  + DOC in the early spring does not accumulate (also apparent at 39˚N)
  + 64% of DOC pool in the late spring was persistent while 69% of the DOC pool in the early autumn was persistent. This would imply an increase of the persistent DOC fraction by 5%. I think this suggests that most of the net production of persistent DOC occurs in the late spring, closer to the timing of the bloom peak. 

Overall, there are elevated persistent fractions in the late spring and early autumn, with greater proportion of the early autumn pool beeing more consistently persistant. 

Our addition experiments are consistent with our definition of DOC persistence. In every cruise, the addition of SPE-DOM substrates (different quality and substrates) stimulated drawdown of accumulated DOC and bacterioplankton growth, but did not result in drawdown into the persistent pool. 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 16, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  mutate(Addition = ifelse(Treatment == "Control", F, T)) %>% 
  select(Season, Cruise, Station, degree_bin, Depth, Addition, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc, accm_doc, total.bioav_accm_doc) %>% 
  distinct() %>% 
  filter(Depth == 10, !Treatment %in% c("MixDS", "MixSD"), !Cruise == "AT34", Addition == T) %>% 
  mutate(degree_bin = paste(degree_bin, "˚N"), 
         plot_treatment = ifelse(Cruise != "AT39", facet_treatment, "T. Weissflogii Exudate")) %>% 
  group_by(Cruise, Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_hline(aes(yintercept = 0)) +
  geom_hline(aes(yintercept = accm_doc), linetype = 2) +
  geom_label(aes(x = 50, y = accm_doc + 1.75, label = "Seasonally Accm. DOC"), size = 3) +
  geom_hline(aes(yintercept = total.bioav_accm_doc), linetype = 3) +
  geom_label(aes(x = 45, y = total.bioav_accm_doc - 1.5, label = "Non-addition Bioavailable DOC"), size = 3) +
  geom_line(aes(color = plot_treatment), alpha = 0.7) +
   geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
   geom_point(aes(fill = plot_treatment, shape = factor(Season, levels = levels)), size = 4, alpha = 0.7 ) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  scale_shape_manual(values = custom.shapes) +
  facet_grid(~degree_bin, scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  guides(fill = F)
```






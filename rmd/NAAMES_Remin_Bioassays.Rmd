---
title: "NAAMES DOC Remineralization Bioassays - Bottles"
author: "Nicholas Baetge"
date: "2/29/2020"
output: github_document
---

# Intro

This document shows how **individual bottle** data from NAAMES DOC remineralization bioassays were processed, QC'd, and analyzed. 

```{r message = F, warning = F}
library(tidyverse) 
library(rmarkdown)
library(knitr)
library(readxl)
library(data.table) 
library(scales)
library(zoo)
library(oce)
library(patchwork)
#rmarkdown tables
library(stargazer)
library(pander)
library(growthcurver)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
```


```{r include = FALSE}
custom_theme <- function() {
  theme_test(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom_theme_linedraw <- function() {
  theme_linedraw(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "A" = "#E41A1C", "B" = "#377EB8", "C" = "#4DAF4A", "D" = "#FF7F00", "E" = "#FDB927", "F" = "#552583", "G" = "#FDB927", "H" = "#552583",   "Control" = "#E41A1C", "TW12" = "#377EB8", "T. Weissflogii 12C Exudate" = "#377EB8", "TW13" = "#4DAF4A", "T. Weissflogii 13C Exudate" = "#4DAF4A", "MixDS" = "#377EB8", "Deep Comm., Surface DOM" = "#377EB8","MixSD" = "#4DAF4A", "Surface Comm., Deep DOM" = "#4DAF4A", "SynLys" = "#377EB8", "Synechococcus Lysate" = "#377EB8", "SynExd" = "#4DAF4A", "Synechococcus Exudate" = "#4DAF4A", "TWExd" = "#FF7F00", "T. Weissflogii Exudate" = "#FF7F00", "TW5" = "#377EB8", "TW10" = "#4DAF4A", "TW20" = "#FF7F00", "Parallel" = "#377EB8", "W" = "#552583", "Whole Seawater" = "#552583", "1.2" = "#4DAF4A", "1.2 µm Filtrate" = "#4DAF4A", "NV" = "#FF7F00", "1.2 µm Filtrate: TFF Filtrate (3:7)" = "#FF7F00", "Carbon" = "#E41A1C", "Nitrogen" = "#377EB8", "+5 µmol C/L Exudate" = "#FF7F00", "+10 µmol C/L Exudate" = "#FF7F00", "+20 µmol C/L Exudate" = "#FF7F00", "Filter 1" = "#E41A1C", "Filter 2" = "#377EB8", "10 m" = "#E41A1C", "200 m" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A" , "Cruise Specific BGE" = "#377EB8", "Global BGE" = "#4DAF4A") 

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )


levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn",  "Summer", "Late Autumn", "Control", "Parallel", "SynLys", "SynExd", "TWExd", "MixSD", "MixDS", "TW12", "TW13", "TW5", "TW10", "TW20",  "Surface Comm., Deep DOM", "Deep Comm., Surface DOM", "Synechococcus Exudate", "Synechococcus Lysate", "T. Weissflogii Exudate", "T. Weissflogii 12C Exudate", "T. Weissflogii 13C Exudate", "+5 µmol C/L Exudate", "+10 µmol C/L Exudate","+20 µmol C/L Exudate", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "W", "Whole Seawater","1.2", "1.2 µm Filtrate","NV", "1.2 µm Filtrate: TFF Filtrate (3:7)")
```




## Biovolume

Cell biovolume was determined from 10 images captured with a digital camera (Retiga Exi-QImaging, Surrey, BC, Canada). Images were processed using ImageJ software according to established image analyses protocols (Baldwin and Bankston 1988; Sieracki et al. 1989, Ducklow et al., 1995). In addition to calculating cell carbon using GF75 POC-derived CCFs, we'll also caclulate cell carbon based on the biovolume measurements we have. Biovolume-based cell carbon could be be calculated as: **Bacterial Abundance * Cell Biovolume * CCF of 148 fg C µm^-3^** However, this CCF, which comes from Gunderson et al, is likely only really applicable to the Sargasso Sea. We will need to determine the best way to estimate biovolume-based cell carbon for this dataset. 

```{r message = F}

biovol <- read_csv("~/naames_bioav_ms/Input/Biovolume_Summary.csv") %>% 
  select(Cruise:Timepoint, Biovol_Mean_All) %>% 
  rename(biovol = Biovol_Mean_All) %>% 
  mutate_at(vars(biovol), round, 3) %>% 
  mutate(phase = ifelse(Timepoint == 0, "initial", "later"),
         Station = gsub("2RD", "S2RD", Station),
         Station = gsub("2RF", "S2RF", Station)) %>% 
  group_by(Cruise, phase) %>% 
  mutate(mean_biovol = round(mean(biovol, na.rm = T),3),
         sd_biovol = round(sd(biovol, na.rm = T),3)) %>% 
  add_tally() %>% 
  rename(n_biovol = n) %>% 
  ungroup() 

biovol_table <- biovol %>% select(-c(Station:biovol)) %>% distinct()

```

```{r echo = FALSE, results = 'asis'}
kable(biovol_table, caption = "Mean Biovolume AT38, AT39; 'later' represents any timepoint after 0")
```

It would be good to see if there is a log-linear relationship between the cell carbon calculated from the GF75 POC data (fg C L^-1^) and the estimated biovolumes (µm^3^). Unfortunately we don't yet have concurrent measurements of GF75 POC data and biovolume at "stationary" so that will have to wait. We do have concurrent measurements at initial though, so we can plot those. 

```{r message = F, warning = F}

biovol_merge <- biovol %>% 
  filter(Timepoint == 0) %>% 
  select(Cruise:Bottle, biovol) %>% 
  rename(i.biovol = biovol) %>% 
  left_join(fg_cell.qc, .)
  
```

#### Biovolume v. Cell Carbon (this study and literature)

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 9, fig.align = "center", warning = FALSE}

biovol_x <-  seq(from = 0.01, to = 0.1, length.out = 11)
exports_y <-  87.4*(biovol_x^0.616)
simon_azam_y <-  92.0*(biovol_x^0.5985) #1989
gunderson_y <-  108.8*(biovol_x^0.898) #2002
malfatti_y <-  103.02*(biovol_x^0.59) #2002

lit_df <- data_frame(biovol_x, exports_y, simon_azam_y, gunderson_y, malfatti_y) 

ccf_biovol_plot.data <- biovol_merge  %>% 
  drop_na(i.biovol)  %>% 
  bind_cols(., lit_df) %>% 
  select(Season:Bottle, i.ccf.c1:i.ccf.c3, i.biovol:malfatti_y)

ccf_biovol_plot.data %>%  
ggplot(aes(x = i.biovol)) +
  geom_point(aes(y = i.ccf.c1, fill = Season), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  geom_point(aes(y = i.ccf.c3, fill = Season), shape = 23, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("Biovolume, µm"^-3)), y = expression(paste("Cellular C, fg C cell"^-1))) +
  scale_x_continuous(trans = 'log10', breaks = pretty_breaks(), limits = c(0.005, 0.09)) +
  scale_y_continuous(trans = 'log10', breaks = pretty_breaks(), limits = c(1, 90)) +
  scale_fill_manual(values = custom.colors) +
  custom_theme_linedraw()  +
  geom_line(aes(x = biovol_x, y = exports_y)) + 
   geom_line(aes(x = biovol_x, y = simon_azam_y), linetype = 2, color = "#4DAF4A") +
    geom_line(aes(x = biovol_x, y = gunderson_y), linetype = 3, color = "#FF7F00") +
   geom_line(aes(x = biovol_x, y = malfatti_y), color = "#552583") +
  geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = exports_y, label = "EXPORTS")) +
  geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = simon_azam_y + 1, label = "Simon & Azam (1989)"), fill = "#4DAF4A") + 
   geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = gunderson_y, label = "Gunderson et al (2002)"), fill = "#FF7F00")  +
geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = malfatti_y + 2, label = "Malfatti (2009)"), fill = "#552583", color = "white")  
 
```

For the samples in which we have concurrent biovolume and cellular C measurements, we see that their relationship to one another is pretty widespread relative to published literature relationshops. Circles are samples corrected using filter 2 of either all POC blanks or only TFF blanks. Diamonds are samples corrected using the sum of the filters for TFF blanks. 


# Merge Data

```{r message = F, warning = F}

ba.merge <- gcstat.df %>% 
  mutate(key = paste(Cruise, Station, Depth, Treatment, Bottle, Timepoint, sep = "."),
         Depth = as.numeric(Depth)) %>% 
  filter(!Treatment %in% c("GF75", "Niskin", "TFF-Ret", "Volume", "Parallel"))

oc.merge <- oc_p %>% 
  select(-Days) %>% 
  filter(!Treatment == "Parallel")


merge <- full_join(ba.merge, oc.merge) %>% 
  left_join(., fg_cell.qc %>% select(-c(contains(".ug"), contains("gf75.cells")))) %>% 
  arrange(Cruise, Station, Depth, Treatment, Bottle, Hours) %>%
  mutate(Days = round(Hours/24, 2)) %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle) %>%
  select(Season:Depth, facet_depth,  Treatment, facet_treatment, Bottle, facet_bottle, Timepoint, Hours, stationary, s.timepoint, Days, cells:sd_p_cells, doc, sd_doc, ptoc, sd_ptoc, doc_from_t0, ptoc_from_t0, gf75.flag, i.poc.cf1:i.ccf.c3, s.poc.cf1:s.ccf.c3, ccf.white:ccf.lee) %>% 
  fill(stationary, facet_treatment, facet_depth, facet_bottle, .direction = "downup") %>% 
  ungroup() %>% 
  drop_na(Hours) 

  
   
```


# Bottle v. Vial Incubation Comparisons

## PTOC v. PDOC

### Absolute

```{r message = F}
ptoc_pdoc.data <- oc_p %>% 
  filter(Cruise == "AT39", !Treatment == "Parallel") 
ptoc_pdoc.reg <- lmodel2(pdoc ~ ptoc, data = ptoc_pdoc.data , nperm = 99)
```

```{r echo = FALSE}
ptoc_pdoc.reg 
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
ptoc_pdoc.data %>% 
  ggplot(aes(x = ptoc, y = pdoc, group = Bottle)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = ptoc_pdoc.reg$regression.results[3,2],
              slope = ptoc_pdoc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( fill = "white", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("TOC, µmol C L"^-1)), y = expression(paste("DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 4 Parallel Samples") 

```

### Delta


```{r message = F}
delta_ptoc_pdoc.reg <- lmodel2(pdoc_from_t0 ~ ptoc_from_t0, data = ptoc_pdoc.data , nperm = 99)
```

```{r echo = FALSE}
delta_ptoc_pdoc.reg 
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
ptoc_pdoc.data %>% 
  ggplot(aes(x = ptoc_from_t0, y = pdoc_from_t0, group = Bottle)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = delta_ptoc_pdoc.reg$regression.results[3,2],
              slope = delta_ptoc_pdoc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( fill = "white", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("∆TOC, µmol C L"^-1)), y = expression(paste("∆DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 4 Parallel Samples") 

```


## Bottle TOC v. Vial TOC

Because the same samples are measured for TOC and PTOC for T0, these data are omitted from the regression analysis.

### Absolute

```{r message = F}
toc_ptoc.data <- oc_p %>% 
  filter(!Cruise == "AT34", !Timepoint == 0, !Treatment == "Parallel") 
toc_ptoc.reg <- lmodel2(ptoc ~ toc, data = toc_ptoc.data, nperm = 99)
```
```{r echo = FALSE}
toc_ptoc.reg
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
toc_ptoc.data %>% 
  ggplot(aes(x = toc, y = ptoc)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = toc_ptoc.reg$regression.results[3,2],
              slope = toc_ptoc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( fill = "white", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("Bottle TOC, µmol C L"^-1)), y = expression(paste("Vial TOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 3 & 4 TOC") 

```

### Delta

```{r message = F}
delta_toc_ptoc.reg <- lmodel2(ptoc_from_t0 ~ toc_from_t0, data = toc_ptoc.data, nperm = 99)
```
```{r echo = FALSE}
delta_toc_ptoc.reg
```
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
toc_ptoc.data %>% 
  ggplot(aes(x = toc_from_t0, y = ptoc_from_t0)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = delta_toc_ptoc.reg$regression.results[3,2],
              slope = delta_toc_ptoc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( fill = "white", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("Bottle ∆TOC, µmol C L"^-1)), y = expression(paste("Vial ∆TOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 3 & 4 TOC") 

```



## Bottle v. Vial Cell Abundance


```{r message = F}
btl_vial_cell.data <- merge %>% 
 drop_na(p_cells)
btl_vial_cell.reg <- lmodel2(p_cells ~ cells, data = btl_vial_cell.data, nperm = 99)
```

```{r echo = FALSE}
btl_vial_cell.reg
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
btl_vial_cell.data %>% 
  ggplot(aes(x = cells, y = p_cells)) + 
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_abline(intercept = btl_vial_cell.reg$regression.results[3,2],
              slope = btl_vial_cell.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( fill = "white", shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(paste("Bottle Cells L"^-1)), y = expression(paste("Vial Cells L"^-1))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  custom_theme() 

```

# Tidy and Wrangle Merged Data

## Condense DOC Data

Because DOC and TOC samples are essentially the same in this dataset, we will treat them as such. We'll use the DOC samples from AT34 and the parallel TOC samples from AT38 and AT39.

```{r}
tidy_merge <- merge %>% 
  mutate(ptoc = ifelse(Cruise == "AT34", doc, ptoc),
         sd_ptoc = ifelse(Cruise == "AT34", sd_doc, sd_ptoc),
         ptoc_from_t0 = ifelse(Cruise == "AT34", doc_from_t0, ptoc_from_t0)) %>% 
  select(-c(p_cells, sd_p_cells, doc, sd_doc, doc_from_t0)) %>% 
  rename(doc = ptoc,
         sd_doc = sd_ptoc,
         doc_from_t0 = ptoc_from_t0) %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle) %>% 
  mutate(s.timepoint = ifelse(s.timepoint == Timepoint, Hours, NA)) %>% 
  fill(s.timepoint, .direction = "downup") %>% 
  rename(s.gf75 = s.timepoint) %>% 
  select(-Timepoint) %>% 
  # merge duplicate stationary timepoints
  group_by(Cruise, Station, Depth, Treatment, Bottle, Hours) %>%
  fill(cells:doc_from_t0, i.poc.cf1:ccf.lee, .direction = "downup") %>% 
  distinct() %>% 
  ungroup() %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle) 


tidy_merge_keys <- tidy_merge %>% 
  group_keys() %>%
  mutate(key = paste(Cruise, ", S", Station, ", Z =", Depth, ",", Treatment, ",", Bottle))
tidy_merge_header <- tidy_merge_keys$key

tidy_merge_list <- tidy_merge %>%
  group_split()
names(tidy_merge_list) <- tidy_merge_header

```


```{r}

two_newrow.func <- function(morty){
   morty[nrow(morty) + 1,] <- NA
   morty$Days[is.na(morty$Days)] <- 7
  rick <- morty %>% 
    fill(., Season:facet_bottle, stationary:s.gf75, .direction = c("updown")) 
  
   rick[nrow(rick) + 1,] <- NA
  rick$Days[is.na(rick$Days)] <- 30
  summer <- rick %>% 
    fill(., Season:facet_bottle, stationary:s.gf75, .direction = c("updown")) 
}

add_tidy_merge <- lapply(tidy_merge_list, two_newrow.func) %>% 
  plyr::ldply(., as.data.frame) %>% 
  select(-.id) %>% 
  arrange(Cruise, Station, Depth, Treatment, Bottle, Days) %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle, Days) %>%
  fill(Hours, gf75.flag, cells:doc_from_t0, i.poc.cf1:ccf.lee, .direction = "downup") %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(Hours = ifelse(Days == 30, 720, Hours ),
         Hours = ifelse(Days == 7, 168, Hours )) %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle)  

add_tidy_merge_keys <- add_tidy_merge %>% 
  group_keys() %>%
  mutate(key = paste(Cruise, ", S", Station, ", Z =", Depth, ",", Treatment, ",", Bottle))
add_tidy_merge_header <- add_tidy_merge_keys$key

add_tidy_merge_list <- add_tidy_merge %>%
  group_split()
names(add_tidy_merge_list) <- add_tidy_merge_header

```



## Interpolate Stationary Timepoint

```{r warning = FALSE}
interp.func <- function(x) {
  y <- zoo(x, order.by = x$Hours)
  interp_cells <- round(as.numeric(na.approx(y$cells, na.rm = F)))
  interp_doc <- round(as.numeric(na.approx(y$doc, na.rm = F)), 1)
  z <- cbind(y, interp_cells,  interp_doc)
  as_tibble(z)
}

interp_st <- lapply(add_tidy_merge_list, interp.func) %>% 
  plyr::ldply(., as.data.frame) %>% 
  select(-.id) %>% 
  mutate_at(vars(Depth, Hours:doc_from_t0, i.poc.cf1:interp_doc), as.numeric) %>% 
  select(Season:doc_from_t0, interp_cells, interp_doc, everything())
```

# Calculate Derived Variables

We need to readjust our initial bacterial carbon numbers before calculating other parameters. Since the initial condition was 1.2-µm filtrate, the carbon content of that filtrate would be higher than the 30:70 incubation mix at the beginning of the experiment. As a result we'll correct the initial carbon number to account for this: POC~initial~ = 0.3(POC~1.2 µm filtrate~)


We'll calculate and define:

- Division rates (**r**) between each timepoint (Monod 1949). We assume all cells are viable. 
- Duration of lag, log, stationary phases based on calculated division rates and timing of stationary determined via GrowthCurver
  + lag phase ends when r > 0.01 (Yates and Smotzer 2007)
  + we've already filtered out the death phases so stationary runs from GrowthCurver determined timepoint until cell counts cease
  + we do not determine growth phases where there is no observable growth
- Carrying Capacity (**k**), mean of cell abundance during stationary
- Exponential growth rate day^-1^
- Dynamic CCFs: we use a weighted function to determine the CCF from the initial condition to the beginning of stationary, end members which we have measured (this really only affects BGEs calculated using AUC:
  + CCF~t~ = CCF~initial~ + w(CCF~stationary~ - CCF~initial~), where w = cells~t~ / cells~st~
  + for this to work, we normalize the cell counts to those at stationary
- Cell carbon in µmol C L^-1^, using the dynamic CCFS 
- Bacterial growth efficiencies (BGE) using multiple approaches, only where ∆DOC is resolvable:
  + point-to-point (**BGE_p**), ∆BC and ∆DOC from T0 to stationary
  + phase-to-phase (**BGE_ph**), ∆BC and ∆DOC using means of lag phase and stationary phase values
  
```{r}
interp_st %>% 
  select(Cruise, Station, Depth, Treatment, Bottle, stationary, s.gf75) %>% 
  unique() %>% 
  filter(s.gf75 < stationary) 
```
There are a few cases where the onset of stationary predicted by the GrowthCurver model occurs later than the time of sampling (n = 9 of 78).

```{r message = F}
calcs <- interp_st %>%
  mutate_at(vars( i.poc.cf1:i.pon.c.um), funs(.*0.3)) %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle) %>% 
  #division rates 
  mutate(r = round((log(interp_cells) - lag(log(interp_cells)))/(Hours - lag(Hours)), 2),
         r = ifelse(Hours == 0, 0, r)) %>% 
  #cell growth phase
  mutate(cell_div = ifelse(Hours >= stationary & !is.na(interp_cells), "stationary", NA),
         cell_div = ifelse(Hours > stationary & is.na(cell_div), "out of bounds", cell_div),
         cell_div = ifelse(Hours < stationary & r > 0.01, "exponential", cell_div)) %>% 
  fill(cell_div, .direction = "down") %>% 
  mutate(cell_div = ifelse(Hours < stationary & r == 0 & is.na(cell_div), "lag", cell_div)) %>% 
  fill(cell_div, .direction = "down") %>% 
  mutate(growth = ifelse(cell_div == "stationary" | cell_div == "exponential", cell_div, NA)) %>%
  fill(growth, .direction = "downup") %>% 
  mutate(growth = ifelse(growth == "stationary" | growth == "exponential", T, F),
         growth = ifelse(is.na(growth), F, growth),
         cell_div = ifelse(growth == F, "no growth", cell_div)) %>% 
  fill(growth, .direction = "downup") %>% 
  fill(interp_cells, .direction = "down") %>% 
  mutate(interp_cells = ifelse(Days > 24, NA, interp_cells)) %>% 
  # carrying capacity
  mutate(k = ifelse(cell_div == "stationary", interp_cells, NA),
         k = ifelse(!is.na(k), mean(k, na.rm = T), NA)) %>% 
  #exponential growth rate
  mutate(end_lag_t = ifelse(cell_div == "lag", Hours, NA),
         end_lag_t = ifelse(!is.na(end_lag_t), max(end_lag_t, na.rm = T), NA),
         end_lag_cells = ifelse(Hours == end_lag_t, interp_cells, NA),
         beg_stat_cells = ifelse(Hours == stationary, interp_cells, NA)) %>% 
  fill(k:beg_stat_cells, .direction = "downup") %>% 
  mutate(mew = ifelse(!is.na(end_lag_cells), ((log(beg_stat_cells) - log(end_lag_cells))/(stationary - end_lag_t)) * 24, NA )) %>% 
  #weighted CCFs, raw POC BC, and BC based on CCFs
  mutate(i.cells = ifelse(Hours == 0, cells, NA)) %>% 
  fill(i.cells, .direction = "updown") %>% 
  mutate(delta_cells = interp_cells - i.cells,
         s.delta_cells = ifelse(Hours == stationary & stationary != 0 & growth == T, delta_cells, NA)) %>% 
  fill(s.delta_cells, .direction = "updown") %>% 
  mutate(norm_cells = ifelse(!is.na(s.delta_cells), round(delta_cells/s.delta_cells,2), NA)) %>% 
  rename(weight = norm_cells) %>% 
  mutate(dyn.ccf.c1 = round(i.ccf.c1 + (weight * (s.ccf.c1 - i.ccf.c1)),1),
         dyn.ccf.c2 = round(i.ccf.c2 + (weight * (s.ccf.c2 - i.ccf.c2)),1),
         dyn.ccf.c3 = round(i.ccf.c3 + (weight * (s.ccf.c3 - i.ccf.c3)),1),
         dyn.ccf.white_fukuda = round(ccf.white + (weight * (ccf.fukuda - ccf.white)),1),
         dyn.ccf.white_lee = round(ccf.white + (weight * (ccf.lee - ccf.white)),1),
         i.bc.ccf.c1 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * i.ccf.c1) / (12*10^9), 1), NA), 
         i.bc.ccf.c2 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * i.ccf.c2) / (12*10^9), 1), NA), 
         i.bc.ccf.c3 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * i.ccf.c3) / (12*10^9), 1), NA), 
         s.bc.ccf.c1 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * s.ccf.c1) / (12*10^9), 1), NA), 
         s.bc.ccf.c2 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * s.ccf.c2) / (12*10^9), 1), NA), 
         s.bc.ccf.c3 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * s.ccf.c3) / (12*10^9), 1), NA), 
         bc.dyn.ccf.c1 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * dyn.ccf.c1) / (12*10^9), 1), NA),
         bc.dyn.ccf.c2 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * dyn.ccf.c2) / (12*10^9), 1), NA), 
         bc.dyn.ccf.c3 =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * dyn.ccf.c3) / (12*10^9), 1), NA), 
         bc.ccf.white =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * ccf.white) / (12*10^9), 1), NA), 
         bc.ccf.fukuda =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * ccf.fukuda) / (12*10^9), 1), NA), 
         bc.ccf.lee =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * ccf.lee) / (12*10^9), 1), NA), 
         bc.dyn.ccf.white_fukuda =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * dyn.ccf.white_fukuda) / (12*10^9), 1), NA), 
         bc.dyn.ccf.white_lee =  ifelse(cell_div %in% c("lag", "exponential", "stationary"), round((interp_cells * dyn.ccf.white_lee) / (12*10^9), 1), NA)) %>% 
  ungroup() %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle, cell_div) %>% 
  mutate(ph.i.bc.ccf.c1 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(i.bc.ccf.c1, na.rm = T), 1), NA),
         ph.i.bc.ccf.c2 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(i.bc.ccf.c2, na.rm = T), 1), NA),
         ph.i.bc.ccf.c3 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(i.bc.ccf.c3, na.rm = T), 1), NA),
         ph.s.bc.ccf.c1 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(s.bc.ccf.c1, na.rm = T), 1), NA),
         ph.s.bc.ccf.c2 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(s.bc.ccf.c2, na.rm = T), 1), NA),
         ph.s.bc.ccf.c3 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(s.bc.ccf.c3, na.rm = T), 1), NA),
         ph.bc.dyn.ccf.c1 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.dyn.ccf.c1, na.rm = T), 1), NA),
         ph.bc.dyn.ccf.c2 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.dyn.ccf.c2, na.rm = T), 1), NA),
         ph.bc.dyn.ccf.c3 = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.dyn.ccf.c3, na.rm = T), 1), NA),
         ph.bc.ccf.white = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.ccf.white, na.rm = T), 1), NA),
         ph.bc.ccf.fukuda = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean( bc.ccf.fukuda, na.rm = T), 1), NA),
         ph.bc.ccf.lee = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.ccf.lee, na.rm = T), 1), NA),
         ph.bc.dyn.ccf.white_fukuda =  ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.dyn.ccf.white_fukuda, na.rm = T), 1), NA),
         ph.bc.dyn.ccf.white_lee = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(bc.dyn.ccf.white_lee, na.rm = T), 1), NA),
         ph.doc = ifelse(!cell_div %in% c("no growth", "out of bounds"), round(mean(interp_doc, na.rm = T), 1), NA)
         ) %>% 
  ungroup() %>% 
  group_by(Cruise, Station, Depth, Treatment, Bottle) %>% 
  fill(ph.i.bc.ccf.c1:ph.doc, .direction = "down") %>%
  mutate(del.bc.poc = s.poc.um - i.poc.um,
         del.bc.poc.c1 = s.poc.c1.um - i.poc.c1.um,
         del.bc.poc.c2 = s.poc.c2.um - i.poc.c2.um,
         del.bc.poc.c3 = s.poc.c3.um - i.poc.c3.um,
         del.bc.p.ccf.c1 = ifelse(Hours == stationary, s.bc.ccf.c1, NA) - first(i.bc.ccf.c1),
         del.bc.p.ccf.c2 = ifelse(Hours == stationary, s.bc.ccf.c2, NA) - first(i.bc.ccf.c2),
         del.bc.p.ccf.c3 = ifelse(Hours == stationary, s.bc.ccf.c3, NA) - first(i.bc.ccf.c3),
         del.bc.p.dyn.ccf.c1 = ifelse(Hours == stationary, bc.dyn.ccf.c1, NA) - first(bc.dyn.ccf.c1),
         del.bc.p.dyn.ccf.c2 = ifelse(Hours == stationary, bc.dyn.ccf.c2, NA) - first(bc.dyn.ccf.c2),
         del.bc.p.dyn.ccf.c3 = ifelse(Hours == stationary, bc.dyn.ccf.c3, NA) - first(bc.dyn.ccf.c3),
         del.bc.p.ccf.white = ifelse(Hours == stationary, bc.ccf.white, NA) - first(bc.ccf.white),
         del.bc.p.ccf.fukuda = ifelse(Hours == stationary, bc.ccf.fukuda, NA) - first(bc.ccf.fukuda),
         del.bc.p.ccf.lee = ifelse(Hours == stationary, bc.ccf.lee, NA) - first(bc.ccf.lee),
         del.bc.p.dyn.ccf.white_fukuda = ifelse(Hours == stationary, bc.dyn.ccf.white_fukuda, NA) - first(bc.dyn.ccf.white_fukuda),
         del.bc.p.dyn.ccf.white_lee = ifelse(Hours == stationary, bc.dyn.ccf.white_lee, NA) - first(bc.dyn.ccf.white_lee),
         
         
         del.bc.ph.ccf.c1 = ifelse(Hours == stationary, ph.s.bc.ccf.c1, NA) - first(ph.i.bc.ccf.c1),
         del.bc.ph.ccf.c2 = ifelse(Hours == stationary, ph.s.bc.ccf.c2, NA) - first(ph.i.bc.ccf.c2),
         del.bc.ph.ccf.c3 = ifelse(Hours == stationary, ph.s.bc.ccf.c3, NA) - first(ph.i.bc.ccf.c3),
         del.bc.ph.dyn.ccf.c1 = ifelse(Hours == stationary, ph.bc.dyn.ccf.c1, NA) - first(ph.bc.dyn.ccf.c1),
         del.bc.ph.dyn.ccf.c2 = ifelse(Hours == stationary, ph.bc.dyn.ccf.c2, NA) - first(ph.bc.dyn.ccf.c2),
         del.bc.ph.dyn.ccf.c3 = ifelse(Hours == stationary, ph.bc.dyn.ccf.c3, NA) - first(ph.bc.dyn.ccf.c3),
         del.bc.ph.ccf.white = ifelse(Hours == stationary, ph.bc.ccf.white, NA) - first(ph.bc.ccf.white),
         del.bc.ph.ccf.fukuda = ifelse(Hours == stationary, ph.bc.ccf.fukuda, NA) - first(ph.bc.ccf.fukuda),
         del.bc.ph.ccf.lee = ifelse(Hours == stationary, ph.bc.ccf.lee, NA) - first(ph.bc.ccf.lee),
         del.bc.ph.dyn.ccf.white_fukuda = ifelse(Hours == stationary, ph.bc.dyn.ccf.white_fukuda, NA) - first(ph.bc.dyn.ccf.white_fukuda),
         del.bc.ph.dyn.ccf.white_lee = ifelse(Hours == stationary, ph.bc.dyn.ccf.white_lee, NA) - first(ph.bc.dyn.ccf.white_lee),
         del.ph.doc = first(ph.doc) - last(ph.doc),
         del.doc = first(doc) - ifelse(Hours == stationary, interp_doc, NA),
         ) %>% 
  fill(del.bc.p.ccf.c1:del.doc, .direction = "downup") %>% 
  mutate(del.ph.doc.flag = ifelse(del.ph.doc >= 1.5, "Acceptable", "NR"),
         del.doc.flag = ifelse(del.doc >= 1.5, "Acceptable", "NR"),
         bge.bc.poc = ifelse(del.doc.flag != "NR", del.bc.poc/(del.doc + del.bc.poc), NA),
         bge.bc.poc.c1 = ifelse(del.doc.flag != "NR", del.bc.poc.c1/(del.doc + del.bc.poc.c1), NA),
         bge.bc.poc.c2 = ifelse(del.doc.flag != "NR", del.bc.poc.c2/(del.doc + del.bc.poc.c2), NA),
         bge.bc.poc.c3 = ifelse(del.doc.flag != "NR", del.bc.poc.c3/(del.doc + del.bc.poc.c3), NA),
         bge.p.bc.ccf.c1 = ifelse(del.doc.flag != "NR", del.bc.p.ccf.c1/(del.doc + del.bc.p.ccf.c1), NA),
         bge.p.bc.ccf.c2 = ifelse(del.doc.flag != "NR", del.bc.p.ccf.c2/(del.doc + del.bc.p.ccf.c2), NA),
         bge.p.bc.ccf.c3 = ifelse(del.doc.flag != "NR", del.bc.p.ccf.c3/(del.doc + del.bc.p.ccf.c3), NA),
         bge.p.bc.dyn.ccf.c1 = ifelse(del.doc.flag != "NR", del.bc.p.dyn.ccf.c1/(del.doc + del.bc.p.dyn.ccf.c1), NA),
         bge.p.bc.dyn.ccf.c2 = ifelse(del.doc.flag != "NR", del.bc.p.dyn.ccf.c2/(del.doc + del.bc.p.dyn.ccf.c2), NA),
         bge.p.bc.dyn.ccf.c3 = ifelse(del.doc.flag != "NR", del.bc.p.dyn.ccf.c3/(del.doc + del.bc.p.dyn.ccf.c3), NA),
         bge.p.bc.ccf.white = ifelse(del.doc.flag != "NR", del.bc.p.ccf.white/(del.doc + del.bc.p.ccf.white), NA),
         bge.p.bc.ccf.fukuda = ifelse(del.doc.flag != "NR", del.bc.p.ccf.fukuda/(del.doc +  del.bc.p.ccf.fukuda), NA),
         bge.p.bc.ccf.lee = ifelse(del.doc.flag != "NR", del.bc.p.ccf.lee/(del.doc + del.bc.p.ccf.lee), NA),
         bge.p.bc.dyn.ccf.white_fukuda = ifelse(del.doc.flag != "NR", del.bc.p.dyn.ccf.white_fukuda/(del.doc + del.bc.p.dyn.ccf.white_fukuda), NA),
         bge.p.bc.dyn.ccf.white_lee = ifelse(del.doc.flag != "NR", del.bc.p.dyn.ccf.white_lee/(del.doc + del.bc.p.dyn.ccf.white_lee), NA),
         
         bge.ph.bc.ccf.c1 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.c1/(del.ph.doc + del.bc.ph.ccf.c1), NA),
         bge.ph.bc.ccf.c2 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.c2/(del.ph.doc + del.bc.ph.ccf.c2), NA),
         bge.ph.bc.ccf.c3 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.c3/(del.ph.doc + del.bc.ph.ccf.c3), NA),
         bge.ph.bc.dyn.ccf.c1 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.dyn.ccf.c1/(del.ph.doc + del.bc.ph.dyn.ccf.c1), NA),
         bge.ph.bc.dyn.ccf.c2 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.dyn.ccf.c2/(del.ph.doc + del.bc.ph.dyn.ccf.c2), NA),
         bge.ph.bc.dyn.ccf.c3 = ifelse(del.ph.doc.flag != "NR", del.bc.ph.dyn.ccf.c3/(del.ph.doc + del.bc.ph.dyn.ccf.c3), NA),
         bge.ph.bc.ccf.white = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.white/(del.ph.doc + del.bc.ph.ccf.white), NA),
         bge.ph.bc.ccf.fukuda = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.fukuda/(del.ph.doc + del.bc.ph.ccf.fukuda), NA),
         bge.ph.bc.ccf.lee = ifelse(del.ph.doc.flag != "NR", del.bc.ph.ccf.lee/(del.ph.doc + del.bc.ph.ccf.lee), NA),
         bge.ph.bc.dyn.ccf.white_fukuda = ifelse(del.ph.doc.flag != "NR", del.bc.ph.dyn.ccf.white_fukuda/(del.ph.doc + del.bc.ph.dyn.ccf.white_fukuda), NA),
         bge.ph.bc.dyn.ccf.white_lee = ifelse(del.ph.doc.flag != "NR", del.bc.ph.dyn.ccf.white_lee/(del.ph.doc + del.bc.ph.dyn.ccf.white_lee), NA)
         ) %>% 
  ungroup() %>% 
  mutate_at(vars(bge.bc.poc:bge.ph.bc.dyn.ccf.white_lee), round, 2) %>% 
  left_join(., readRDS("~/naames_export_ms/Output/processed_export_n2_n3_n4.rds") %>% 
              mutate(Cruise = gsub("AT39-6", "AT39", Cruise)) %>%
              mutate_at(vars(Station), as.character) %>% 
              select(Cruise:Subregion) %>% 
              distinct()
  )
 
# bge <- calcs %>%
#   group_by(Cruise, Station, Depth, Treatment, Bottle) %>%
#   filter(full_curve == T) %>% 
#   drop_na(interp_doc_from_t0, ccf_bc_from_t0) %>% 
#   mutate(auc_bc = round(integrateTrapezoid(Hours, ccf_bc_from_t0, type = "A"), 1),
#          auc_doc = round(integrateTrapezoid(Hours, interp_doc_from_t0, type = "A"), 1),
#          bge_ac = round(auc_bc/auc_doc, 2),
#          bge_ac = ifelse(ddoc_resolve_p == F, NA, bge_ac)) %>% 
#   select(Cruise, Station, Depth, Treatment, Bottle, auc_bc:bge_ac) %>%  
#   distinct() %>% 
#   drop_na() %>% 
#   left_join(calcs, .) %>% 
#   ungroup() 
  
```

```{r}
bge_summary <- calcs %>% 
  select(Season:Station, ave_lat:Subregion, Depth:facet_bottle, stationary:s.gf75, gf75.flag, del.doc, del.doc.flag, del.ph.doc, del.ph.doc.flag, del.bc.poc:del.bc.ph.dyn.ccf.white_lee, bge.bc.poc:bge.ph.bc.dyn.ccf.white_lee, i.cn:i.cn.c3, s.cn:s.cn.c3) %>% 
  distinct() %>% 
  mutate(type = ifelse(Treatment == "Control", "Control", "Non-Control"),
         degree_bin = ifelse(Station %in% c("S2RD", "S2RF"), 39, degree_bin),
         Subregion = ifelse(Station %in% c("S2RD", "S2RF"), "GS/Sargasso", Subregion)) %>% 
  select(Season:Treatment, type, everything()) %>% 
  arrange(Cruise, Station, Depth, Treatment, Bottle) %>% 
  #remove outliers
  filter(!Cruise == "AT38" | !Station == 1 | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == 1 | !Depth == 10 | !Treatment == "Control") %>% 
   filter(!Station == "U", Depth == 10)
```


```{r}
bge_summary %>% 
  select(Season:Bottle, contains("bge")) %>% 
  group_by(Season, type) %>% 
  gather(appr, bge, contains("bge")) %>% 
  drop_na(bge) %>% 
  group_by(Cruise, type, appr) %>% 
  mutate(ave_bge = mean(bge),
         sd_bge = sd(bge),
         min_bge = min(bge),
         max_bge = max(bge),
         med_bge = median(bge)) %>% 
  add_tally() %>% 
  ungroup() %>% 
  select(Season, type,  appr, ave_bge:med_bge, n) %>% 
  distinct() %>% 
  arrange(type, Season) %>% 
  mutate_at(vars(ave_bge:med_bge), round, 2) %>% 
  filter(!appr %in% c("bge.p.bc.dyn.ccf.c1", "bge.p.bc.dyn.ccf.c2", "bge.p.bc.dyn.ccf.c3", "bge.ph.bc.dyn.ccf.c1", "bge.ph.bc.dyn.ccf.c2", "bge.ph.bc.dyn.ccf.c3")) 
  
```


```{r include = FALSE}
bge_lvls <- c("p2p, POC", 
              "p2p, POC c1", 
              "p2p, POC c2", 
              "p2p, POC c3", 
              "p2p, CCF c1", 
              "ph2ph, CCF c1", 
              "p2p, CCF c2", 
              "ph2ph, CCF c2", 
              "p2p, CCF c3", 
              "ph2ph, CCF c3", 
              "p2p, Dyn. CCF c1", 
              "ph2ph, Dyn. CCF c1", 
              "p2p, Dyn. CCF c2", 
              "ph2ph, Dyn. CCF c2", 
              "p2p, Dyn. CCF c3", 
              "ph2ph, Dyn. CCF c3", 
              "p2p, White CCF", 
              "ph2ph, White CCF", 
              "p2p, Fukuda CCF", 
              "ph2ph, Fukuda CCF", 
              "p2p, Lee CCF", 
              "ph2ph, Lee CCF", 
              "p2p, Dyn. White_Fukuda CCF", 
              "ph2ph, Dyn. White_Fukuda CCF", 
              "p2p, Dyn. White_Lee CCF", 
              "ph2ph, Dyn. White_Lee CCF" )

bge_lvls2 <- c("POC", 
              "POC c1", 
              "POC c2", 
              "POC c3", 
              "CCF c1", 
              "CCF c2", 
              "CCF c3",
              "Fukuda CCF", 
              "Lee CCF")

```



## ∆POC


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 16, fig.align = "center", warning = FALSE}
bge_summary %>% 
  select(Season:gf75.flag, contains("del.bc"))  %>% 
  distinct() %>% 
  gather(key, del.bc, contains("bc")) %>% 
  #filter(del.doc.flag == "Acceptable") %>% 
  mutate(appr = key,
         appr = ifelse(appr == "del.bc.poc", "p2p, POC", appr),
         appr = ifelse(appr == "del.bc.poc.c1", "p2p, POC c1", appr),
         appr = ifelse(appr == "del.bc.poc.c2", "p2p, POC c2", appr),
         appr = ifelse(appr == "del.bc.poc.c3", "p2p, POC c3", appr),
         appr = ifelse(appr == "del.bc.p.ccf.c1", "p2p, CCF c1", appr),
         appr = ifelse(appr == "del.bc.p.ccf.c2", "p2p, CCF c2", appr),
         appr = ifelse(appr == "del.bc.p.ccf.c3", "p2p, CCF c3", appr),
         appr = ifelse(appr == "del.bc.p.dyn.ccf.c1", "p2p, Dyn. CCF c1", appr),
         appr = ifelse(appr == "del.bc.p.dyn.ccf.c2", "p2p, Dyn. CCF c2", appr),
         appr = ifelse(appr == "del.bc.p.dyn.ccf.c3", "p2p, Dyn. CCF c3", appr),
         appr = ifelse(appr == "del.bc.p.ccf.white", "p2p, White CCF", appr),
         appr = ifelse(appr == "del.bc.p.ccf.fukuda", "p2p, Fukuda CCF", appr),
         appr = ifelse(appr == "del.bc.p.ccf.lee", "p2p, Lee CCF", appr),
         appr = ifelse(appr == "del.bc.p.dyn.ccf.white_fukuda", "p2p, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "del.bc.p.dyn.ccf.white_lee", "p2p, Dyn. White_Lee CCF", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.c1", "ph2ph, CCF c1", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.c2", "ph2ph, CCF c2", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.c3", "ph2ph, CCF c3", appr),
         appr = ifelse(appr == "del.bc.ph.dyn.ccf.c1", "ph2ph, Dyn. CCF c1", appr),
         appr = ifelse(appr == "del.bc.ph.dyn.ccf.c2", "ph2ph, Dyn. CCF c2", appr),
         appr = ifelse(appr == "del.bc.ph.dyn.ccf.c3", "ph2ph, Dyn. CCF c3", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.white", "ph2ph, White CCF", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.fukuda", "ph2ph, Fukuda CCF", appr),
         appr = ifelse(appr == "del.bc.ph.ccf.lee", "ph2ph, Lee CCF", appr),
         appr = ifelse(appr == "del.bc.ph.dyn.ccf.white_fukuda", "ph2ph, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "del.bc.ph.dyn.ccf.white_lee", "ph2ph, Dyn. White_Lee CCF", appr),
         p = appr) %>% 
  separate(., p, into = c("points", "ccf"), sep = "," ) %>% 
  group_by(Cruise, type, appr) %>% 
  add_tally() %>% 
  ungroup() %>% 
  #remove outliers
  filter(!Cruise == "AT38" | !Station == 1 | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == 1 | !Depth == 10 | !Treatment == "Control") %>% 
  filter(!Station == "U", Depth == 10, points == "p2p", !key %in% c("del.bc.p.dyn.ccf.c1", "del.bc.p.dyn.ccf.c2", "del.bc.p.dyn.ccf.c3", "del.bc.ph.dyn.ccf.c1", "del.bc.ph.dyn.ccf.c2", "del.bc.ph.dyn.ccf.c3")) %>%
  drop_na(del.bc) %>% 
  distinct() %>% 
  ##PLOT
  ggplot(aes(x = factor(appr, levels = bge_lvls), y = del.bc)) +
  geom_boxplot(width = 0.3) +
  geom_jitter(aes(fill = factor(appr, levels = bge_lvls)), width = 0.1, shape = 21, size = 3, alpha = 0.7) +
  labs(x = "", y = expression(italic("∆POC, µmol C L"^-1)), colour = expression(italic(""))) + 
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(type~factor(Season, levels = levels) , scales = "free") +
  #ggtitle("Delta POC") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  
```

## ∆TOC

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
bge_summary %>% 
  select(Season:gf75.flag, del.doc)  %>% 
  distinct() %>% 
  #remove outliers
  filter(!Cruise == "AT38" | !Station == 1 | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == 1 | !Depth == 10 | !Treatment == "Control") %>% 
  filter(!Station == "U", Depth == 10) %>%
  drop_na(del.doc) %>% 
  distinct() %>% 
  ##PLOT
  ggplot(aes(x = Season, y = del.doc)) +
  geom_boxplot(width = 0.2) +
  geom_jitter(width = 0.1, shape = 21, size = 3, alpha = 0.7) +
  labs(x = "", y = expression(italic("∆TOC, µmol C L"^-1)), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(type~factor(Season, levels = levels) , scales = "free") +
  #ggtitle("Delta POC") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  
```


## BGEs 


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 16, fig.align = "center", warning = FALSE}
bge_summary %>%
  select(Season:Bottle, i.cn:i.cn.c3, s.cn:s.cn.c3, gf75.flag, del.doc.flag, del.ph.doc.flag, contains("bge")) %>% 
  distinct() %>% 
  gather(key, bge, contains("bge")) %>% 
  drop_na(bge) %>% 
  mutate(appr = key,
         appr = ifelse(appr == "bge.bc.poc", "p2p, POC", appr),
         appr = ifelse(appr == "bge.bc.poc.c1", "p2p, POC c1", appr),
         appr = ifelse(appr == "bge.bc.poc.c2", "p2p, POC c2", appr),
         appr = ifelse(appr == "bge.bc.poc.c3", "p2p, POC c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c1", "p2p, CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c2", "p2p, CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c3", "p2p, CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c1", "p2p, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c2", "p2p, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c3", "p2p, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.white", "p2p, White CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.fukuda", "p2p, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.lee", "p2p, Lee CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_fukuda", "p2p, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_lee", "p2p, Dyn. White_Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c1", "ph2ph, CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c2", "ph2ph, CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c3", "ph2ph, CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c1", "ph2ph, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c2", "ph2ph, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c3", "ph2ph, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.white", "ph2ph, White CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.fukuda", "ph2ph, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.lee", "ph2ph, Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_fukuda", "ph2ph, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_lee", "ph2ph, Dyn. White_Lee CCF", appr),
         p = appr) %>% 
  separate(., p, into = c("points", "ccf"), sep = "," ) %>% 
  group_by(Cruise, type, appr) %>% 
  add_tally() %>% 
  ungroup() %>% 
   #remove outliers
  filter(!Cruise == "AT38" | !Station == 1 | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == 1 | !Depth == 10 | !Treatment == "Control") %>% 
  filter(!Station == "U", Depth == 10, points == "p2p", !key %in% c("bge.p.bc.dyn.ccf.c1", "bge.p.bc.dyn.ccf.c2", "bge.p.bc.dyn.ccf.c3", "bge.ph.bc.dyn.ccf.c1", "bge.ph.bc.dyn.ccf.c2", "bge.ph.bc.dyn.ccf.c3")) %>%
 ##PLOT
  ggplot(aes(x = factor(appr, levels = bge_lvls), y = bge)) +
  geom_boxplot(width = 0.3) +
  geom_jitter(aes(fill = factor(appr, levels = bge_lvls)), width = 0.1, shape = 21, size = 3, alpha = 0.7) +
  labs(x = "", y = expression(italic("BGE")), colour = expression(italic(""))) + 
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(type~factor(Season, levels = levels) , scales = "free") +
  #ggtitle("Bacterial Growth Efficiences") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

## Overall BGEs

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 18, fig.align = "center", warning = FALSE}
bge_summary %>%
  select(Season:Bottle, i.cn:i.cn.c3, s.cn:s.cn.c3, gf75.flag, del.doc.flag, del.ph.doc.flag, contains("bge")) %>% 
  distinct() %>% 
  gather(key, bge, contains("bge")) %>% 
  drop_na(bge) %>% 
   mutate(appr = key,
         appr = ifelse(appr == "bge.bc.poc", "p2p, POC", appr),
         appr = ifelse(appr == "bge.bc.poc.c1", "p2p, POC c1", appr),
         appr = ifelse(appr == "bge.bc.poc.c2", "p2p, POC c2", appr),
         appr = ifelse(appr == "bge.bc.poc.c3", "p2p, POC c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c1", "p2p, CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c2", "p2p, CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c3", "p2p, CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c1", "p2p, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c2", "p2p, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c3", "p2p, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.white", "p2p, White CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.fukuda", "p2p, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.lee", "p2p, Lee CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_fukuda", "p2p, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_lee", "p2p, Dyn. White_Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c1", "ph2ph, CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c2", "ph2ph, CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c3", "ph2ph, CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c1", "ph2ph, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c2", "ph2ph, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c3", "ph2ph, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.white", "ph2ph, White CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.fukuda", "ph2ph, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.lee", "ph2ph, Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_fukuda", "ph2ph, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_lee", "ph2ph, Dyn. White_Lee CCF", appr),
         p = appr) %>% 
  separate(., p, into = c("points", "ccf"), sep = ", " ) %>% 
  group_by(Cruise, type, appr) %>% 
  ungroup() %>% 
   #remove outliers
  filter(!Cruise == "AT38" | !Station == "1" | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == "1" | !Depth == 10 | !Treatment == "Control") %>% 
  filter(type == "Control", !Station == "U", Depth == 10, points == "p2p", !key %in% c("bge.bc.poc", "bge.p.bc.dyn.ccf.c1", "bge.p.bc.dyn.ccf.c2", "bge.p.bc.dyn.ccf.c3", "bge.ph.bc.dyn.ccf.c1", "bge.ph.bc.dyn.ccf.c2", "bge.ph.bc.dyn.ccf.c3", "bge.p.bc.ccf.white",  "bge.p.bc.dyn.ccf.white_fukuda", "bge.p.bc.dyn.ccf.white_lee" )) %>%
  filter(!appr %in% c("p2p, POC c2", "p2p, POC c3", "p2p, CCF c2", "p2p, CCF c3")) %>% 
  filter(!Cruise == "AT34" | !Station == "3" | !ccf %in% c("CCF c1", "CCF c2", "CCF c3") ) %>% 
  mutate(group = "Empirical ∆POC", 
         group = ifelse(ccf %in% c("CCF c1", "CCF c2", "CCF c3"), "Empirical CCF", group),
         group = ifelse(ccf %in% c("Fukuda CCF", "Lee CCF"), ccf, group) ) %>% 
  select(Season:Bottle, ccf, group, bge) %>% 
  distinct() %>%
  group_by(Cruise, group) %>% 
  mutate(group_bge = mean(bge, na.rm = T),
         sd_group_bge = sd(bge, na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Cruise, ccf) %>% 
  add_tally() %>% 
  mutate(n = paste("n = ", n)) %>% 
 ##PLOT
  ggplot(aes(x = factor(group, levels = c("Empirical ∆POC", "Empirical CCF", "Fukuda CCF", "Lee CCF" )), y = group_bge)) +
    geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#999999", width = 0.4) +
    geom_errorbar(aes(ymin = group_bge - sd_group_bge, ymax = group_bge + sd_group_bge), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
    #geom_label(aes(label = n), fontface = 3) +
   scale_y_continuous(breaks = pretty_breaks()) +
    scale_fill_manual(values = custom.colors) +
    labs(x = expression(italic("Estimation Approach")), y = expression(italic(paste("BGE"))), colour = expression(italic(""))) +
    custom_theme() +
    facet_grid(~factor(Season, levels = levels), scales = "free") 
```

```{r}
bge_summary %>%
  select(Season:Bottle, i.cn:i.cn.c3, s.cn:s.cn.c3, gf75.flag, del.doc.flag, del.ph.doc.flag, contains("bge")) %>% 
  distinct() %>% 
  gather(key, bge, contains("bge")) %>% 
  drop_na(bge) %>% 
   mutate(appr = key,
         appr = ifelse(appr == "bge.bc.poc", "p2p, POC", appr),
         appr = ifelse(appr == "bge.bc.poc.c1", "p2p, POC c1", appr),
         appr = ifelse(appr == "bge.bc.poc.c2", "p2p, POC c2", appr),
         appr = ifelse(appr == "bge.bc.poc.c3", "p2p, POC c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c1", "p2p, CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c2", "p2p, CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.c3", "p2p, CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c1", "p2p, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c2", "p2p, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.c3", "p2p, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.white", "p2p, White CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.fukuda", "p2p, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.ccf.lee", "p2p, Lee CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_fukuda", "p2p, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.p.bc.dyn.ccf.white_lee", "p2p, Dyn. White_Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c1", "ph2ph, CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c2", "ph2ph, CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.c3", "ph2ph, CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c1", "ph2ph, Dyn. CCF c1", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c2", "ph2ph, Dyn. CCF c2", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.c3", "ph2ph, Dyn. CCF c3", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.white", "ph2ph, White CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.fukuda", "ph2ph, Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.ccf.lee", "ph2ph, Lee CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_fukuda", "ph2ph, Dyn. White_Fukuda CCF", appr),
         appr = ifelse(appr == "bge.ph.bc.dyn.ccf.white_lee", "ph2ph, Dyn. White_Lee CCF", appr),
         p = appr) %>% 
  separate(., p, into = c("points", "ccf"), sep = ", " ) %>% 
  group_by(Cruise, type, appr) %>% 
  ungroup() %>% 
   #remove outliers
  filter(!Cruise == "AT38" | !Station == "1" | !Depth == 10 | !Treatment == "Control",
         !Cruise == "AT39" | !Station == "1" | !Depth == 10 | !Treatment == "Control") %>% 
  filter(type == "Control", !Station == "U", Depth == 10, points == "p2p", !key %in% c("bge.bc.poc", "bge.p.bc.dyn.ccf.c1", "bge.p.bc.dyn.ccf.c2", "bge.p.bc.dyn.ccf.c3", "bge.ph.bc.dyn.ccf.c1", "bge.ph.bc.dyn.ccf.c2", "bge.ph.bc.dyn.ccf.c3", "bge.p.bc.ccf.white",  "bge.p.bc.dyn.ccf.white_fukuda", "bge.p.bc.dyn.ccf.white_lee" )) %>%
  filter(!appr %in% c("p2p, POC c2", "p2p, POC c3", "p2p, CCF c2", "p2p, CCF c3")) %>% 
  filter(!Cruise == "AT34" | !Station == "3" | !ccf %in% c("CCF c1", "CCF c2", "CCF c3") ) %>% 
  mutate(group = "GF75 POC", 
         group = ifelse(ccf %in% c("CCF c1", "CCF c2", "CCF c3"), "NAAMES CCF", group),
         group = ifelse(ccf %in% c("Fukuda CCF", "Lee CCF"), ccf, group) ) %>% 
  select(Season:Bottle, ccf, group, bge) %>% 
  distinct() %>%
  group_by(Cruise, group) %>% 
  mutate(group_bge = mean(bge, na.rm = T),
         sd_group_bge = sd(bge, na.rm = T),
         min_group_bge = min(bge),
         max_group_bge = max(bge),
         med_group_bge = median(bge)) %>% 
  ungroup() %>% 
  group_by(Cruise, ccf) %>% 
  add_tally() %>% 
  mutate(n = paste("n = ", n),
         group2 = ifelse(group %in% c("GF75 POC", "NAAMES CCF"), "NAAMES", group)) %>%
  ungroup() %>% 
  group_by(group2) %>% 
  mutate(group2_global_bge = mean(bge, na.rm = T)) %>% 
  ungroup() %>% 
  group_by(Cruise, group2) %>% 
  mutate(group2_bge = mean(bge, na.rm = T),
         sd_group2_bge = sd(bge, na.rm = T),
         min_group2_bge = min(bge),
         max_group2_bge = max(bge),
         med_group2_bge = median(bge)) %>% 
  ungroup() %>% 
  select(Season, group, group2, group_bge:med_group_bge, n, group2_bge:med_group2_bge, group2_global_bge) %>% 
  distinct() %>% 
  mutate_at(vars(group_bge:med_group_bge, group2_bge:med_group2_bge, group2_global_bge), round, 2) %>%
  arrange(group, factor(Season, levels = levels))


```


## Other Parameters

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
calcs %>%
  filter(Depth == 10, Treatment == "Control", !Station == "U") %>% 
  select(Season, mew) %>% 
  distinct() %>% 
  gather(key, value, mew) %>% 
  drop_na(value) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = value)) +
  geom_boxplot(width = 0.3) +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("µ d"^-1)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  ggtitle("Bacterioplankton Growth Rates")
  
  
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
calcs %>%
  filter(Depth == 10, Treatment == "Control", !Station == "U") %>% 
  select(Season, k) %>% 
  distinct() %>% 
  gather(key, value, k) %>% 
  drop_na(value) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = value)) +
  geom_boxplot(width = 0.3) +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Cells L"^-1)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  ggtitle("Bacterioplankton Carrying Capacity")
  
  
```

##CCFs per season

```{r}
calcs %>% 
  filter(Depth == 10, Treatment == "Control", Hours == 0, !Station == "U") %>% 
  select(Cruise, Season, Subregion, Station,  i.ccf.c1, s.ccf.c1 ) %>% 
  distinct() %>% 
  mutate(global_initial_ccf = mean(i.ccf.c1, na.rm = T),
         global_stationary_ccf = mean(s.ccf.c1, na.rm = T)) %>% 
  group_by(Season) %>% 
  mutate(ave_initial_ccf = mean(i.ccf.c1, na.rm = T),
            ave_stationary_ccf = mean(s.ccf.c1, na.rm = T)) %>% 
  ungroup() %>% 
  select(Season, global_initial_ccf:ave_stationary_ccf) %>% 
  distinct()
```





## BA, BP, BCD, µ, and NPP

We'll estimate BCD for each station of all the cruises using bacterial production and the global average BGE of 24%. Parameters are integrated to euphotic zone determined by Fox et al 2020. Not that we'll be averaging casts taken throughout the day/night. 

```{r}
#import and wrangle NPP data
#we'll convert NPP from mg C/ m2 / d to umol C/ m2 / d 
npp <- read_xlsx("Input/NPP for Nick.xlsx", sheet = 2) %>% 
  filter(!station %in% c("NA","N4S2RF")) %>% 
  separate(station, into = c("Cruise", "Station"), sep = "S") %>% 
  select(-Cruise) %>% 
  mutate(Cruise = ifelse(Bloom_phase == "Accumulation phase", "AT39", NA),
         Cruise = ifelse(Bloom_phase == "Climax transition", "AT34", Cruise),
         Cruise = ifelse(Bloom_phase == "Equilibrium phase", "AT38", Cruise),
         Cruise = ifelse(Bloom_phase == "Winter transition", "AT32", Cruise)) %>% 
  select(Cruise, Station, Ez, Ez_NPP) %>% 
  mutate(Station = ifelse(Station %in% c("4a", "4b", "4c", "4d"), 4, Station),
         Station = ifelse(Station %in% c("6a", "6b", "6c", "6d", "6e"), 6, Station),
         Station = as.numeric(Station)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave_Ez = mean(Ez),
         sd_Ez = sd(Ez),
         Ez_NPP = Ez_NPP * (10^3/12),
         ave_NPP = mean(Ez_NPP),
         sd_NPP = sd(Ez_NPP)) %>%
  ungroup() %>% 
  select(-c(Ez, Ez_NPP)) %>% 
  distinct() %>% 
  mutate_at(vars(ave_Ez:sd_NPP), round)
```



```{r warning = F, message = F}
#import bact data and join with npp data
bact <- read_rds("Input/processed_bf.2.2020.rds") %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 50, 75, 100, 150, 200, 300, 400, 500, 750, 1000, 1250, 1500 )) %>% 
  select(Cruise:Station, degree_bin, CampCN, Target_Z, BactProd_C, BactProd_C_sd, BactAbund, BactAbund_sd, contains("Influx"), interp_phytodetritus) %>%  
  group_by(Cruise, Station, CampCN, Target_Z) %>% 
  mutate(phyto = interp_Pro_Influx + interp_Syn_Influx + interp_Nano_Influx + interp_Pico_Influx) %>% 
  ungroup() %>% 
  select(-contains("Influx")) %>% 
  mutate(Cruise = gsub("AT39-6", "AT39", Cruise)) %>% 
  mutate(degree_bin = ifelse(Cruise == "AT34" & Station == 4, 48, degree_bin)) %>% 
  mutate_at(vars(BactProd_C:BactProd_C_sd), round, 2) %>% 
  filter(!is.na(BactProd_C) | Target_Z == 0) %>% 
  group_by(Cruise, Station, CampCN) %>% 
  fill(BactProd_C:BactAbund_sd, .direction = "up") %>% 
  drop_na(BactProd_C) %>% 
  rename(Depth = Target_Z,
         bp = BactProd_C, 
         sd_bp = BactProd_C_sd,
         ba = BactAbund,
         sd_ba = BactAbund_sd,
         phytodet = interp_phytodetritus) %>% 
  mutate(max_depth = max(Depth, na.rm = T)) %>% 
  ungroup() %>% 
  select(Cruise:CampCN, max_depth, Depth,  everything()) %>% 
  left_join(., npp) %>% 
  select(Cruise:max_depth, ave_Ez:sd_NPP, everything()) 

#interpolate data for Ez depth
#split the df by CampCN  
add_ez.list <- split(bact, bact$CampCN)

#create a function to add an empty row to each cast, then add the Ez to the Target Z column 
add.func <- function(morty){
  morty[nrow(morty) + 1,] <- NA
  morty$Depth[is.na(morty$Depth)] <- morty$ave_Ez
  rick <- morty %>% 
    fill(., Cruise:sd_NPP, .direction = c("updown")) %>% 
    arrange(CampCN, Depth)
 }

#apply function to list 
added_ez.list <- lapply(add_ez.list, add.func)


#save the list as a data frame 
added_ez.df <- plyr::ldply(added_ez.list, data.frame) %>% 
  drop_na(Depth) %>% 
  select(-.id)  %>% 
  group_by(Cruise, Station, CampCN, Depth) %>% 
  fill(bp:phyto, .direction = "downup") %>% 
  ungroup() %>% 
  distinct()

#split the data frame into lists based on the campaign cast number
to_interpolate.list <- split(added_ez.df, added_ez.df$CampCN)

#create a function that will linearly interpolate each VOI according to the depth intervals of the casts 
interpolate.func <- function(copper) {
to_interpolate.df <- copper %>% 
  select(Depth:ncol(.)) %>% 
  zoo(., order.by = .$Depth) 

interp_bp <- as.numeric(na.approx(to_interpolate.df$bp, na.rm = F))
interp_ba <- as.numeric(na.approx(to_interpolate.df$ba, na.rm = F))
interp_phytodet <- as.numeric(na.approx(to_interpolate.df$phytodet, na.rm = F))
interp_phyto <- as.numeric(na.approx(to_interpolate.df$phyto, na.rm = F))
Depth <- to_interpolate.df$Depth
interpolations.df <- data.frame(Depth, interp_bp, interp_ba, interp_phytodet, interp_phyto)
}

#apply function to list 
interpolations.list <- lapply(to_interpolate.list, interpolate.func)

#save the list as a data frame 
interpolations.df <- plyr::ldply(interpolations.list, data.frame) %>% 
  rename(., CampCN = .id) 

#combine the interpolated and non-interpolated data frames
interpolations.df$CampCN <- as.numeric(interpolations.df$CampCN)
interpolated.df <- right_join(bact, interpolations.df) %>% 
  fill(Cruise:max_depth, .direction = "downup") %>% 
  group_by(Cruise, Station, CampCN) %>% 
  fill(ave_Ez:sd_NPP, .direction = "updown") %>% 
  ungroup() %>% 
  mutate_at(vars(interp_bp), round, 2)

#calculate bcd and specific growth rates
bcd <- interpolated.df %>% 
  mutate(cr_bge = ifelse(Cruise == "AT32", 0.22, NA),
         cr_bge = ifelse(Cruise == "AT34", 0.26, cr_bge),
         cr_bge = ifelse(Cruise == "AT38", 0.22, cr_bge),
         cr_bge = ifelse(Cruise == "AT39", 0.26, cr_bge),
         cr_i.ccf = ifelse(Cruise == "AT32", 50, NA),
         cr_i.ccf = ifelse(Cruise == "AT34", 13, cr_i.ccf),
         cr_i.ccf = ifelse(Cruise == "AT38", 50, cr_i.ccf),
         cr_i.ccf = ifelse(Cruise == "AT39", 20, cr_i.ccf),
         cr_s.ccf = ifelse(Cruise == "AT32", 31, NA),
         cr_s.ccf = ifelse(Cruise == "AT34", 15, cr_s.ccf),
         cr_s.ccf = ifelse(Cruise == "AT38", 31, cr_s.ccf),
         cr_s.ccf = ifelse(Cruise == "AT39", 22, cr_s.ccf),
         bge = 0.24,
         #bp in nmol C / L / d is equivalent to  µmol C / m3 / d 
         bcd.cr_bge = interp_bp/cr_bge,
         bcd = interp_bp/bge,
         # bact carbon in µmol C/m3
         bc.i = interp_ba * (10^3) * cr_i.ccf * (1/10^15) * (1/12) * 10^6,
         bc.s = interp_ba * (10^3) * cr_s.ccf * (1/10^15) * (1/12) * 10^6)  %>%
  mutate_at(vars(bcd, bcd.cr_bge), round) %>% 
  group_by(Cruise, Station, Depth) %>% 
  mutate(bcd.stat.cr_bge = mean(bcd.cr_bge, na.rm = T),
         bcd.stat = mean(bcd, na.rm = T),
         #convert to cells / m3
         ba.stat = mean(interp_ba, na.rm = T) * 1000,
         sd_ba.stat = sd(interp_ba, na.rm = T) * 1000,
         bp.stat = mean(interp_bp, na.rm = T),
         sd_bp.stat = sd(interp_bp, na.rm = T),
         bc.i.stat = mean(bc.i, na.rm = T),
         sd_bc.i.stat = sd(bc.i, na.rm = T),
         bc.s.stat = mean(bc.s, na.rm = T),
         sd_bc.s.stat = sd(bc.s, na.rm = T),
         phytodet.stat = mean(interp_phytodet, na.rm = T),
         phyto.stat = mean(interp_phyto, na.rm = T)) %>% 
  mutate_at(vars(bcd.stat.cr_bge, bcd.stat), round) %>% 
 # mutate_at(vars(sp_gr.i.ccf.stat:sd_sp_gr.s.ccf.stat), round, 4) %>% 
  ungroup() %>% 
  group_by(Cruise, Subregion, Depth) %>% 
  mutate(ba.cr.sr = mean(interp_ba, na.rm = T) * 1000,
         sd_ba.cr.sr = sd(interp_ba, na.rm = T) * 1000,
         bp.cr.sr = mean(interp_bp, na.rm = T),
         sd_bp.cr.sr = sd(interp_bp, na.rm = T)) %>% 
  ungroup() %>% 
  select(Cruise:degree_bin, ave_Ez:sd_NPP, bge, cr_bge, Depth, contains("stat"), contains("sr")) %>% 
  distinct() 


int_bcd_100 <- bcd %>% 
  group_by(Cruise, Station) %>% 
  filter(Depth <= 100) %>% 
  mutate(int.bcd.cr_bge.100 = integrateTrapezoid(Depth, bcd.stat.cr_bge, type = "A"),
         int.bcd.100 = integrateTrapezoid(Depth, bcd.stat, type = "A"))  %>% 
  mutate_at(vars(contains("int.bcd")), round) %>% 
  # depth normalize 
  mutate_at(vars(int.bcd.cr_bge.100:int.bcd.100), funs(./100)) %>% 
  select(Cruise:degree_bin, int.bcd.cr_bge.100, int.bcd.100) %>% 
  distinct()


int_bcd <- bcd %>% 
  group_by(Cruise, Station) %>% 
  filter(Depth <= ave_Ez) %>% 
  mutate(int.bcd.cr_bge.ez = integrateTrapezoid(Depth, bcd.stat.cr_bge, type = "A"),
         int.bcd.ez = integrateTrapezoid(Depth, bcd.stat, type = "A"),
         int.bp.ez = integrateTrapezoid(Depth, bp.stat, type = "A"),
         sd_int.bp.ez = integrateTrapezoid(Depth, sd_bp.stat, type = "A"),
         int.ba.ez = integrateTrapezoid(Depth, ba.stat, type = "A"),
         sd_int.ba.ez = integrateTrapezoid(Depth, sd_ba.stat, type = "A"),
         int.bc.i.ez = integrateTrapezoid(Depth, bc.i.stat, type = "A"),
         int.bc.s.ez = integrateTrapezoid(Depth, bc.s.stat, type = "A"),
         int.phyodet.ez = integrateTrapezoid(Depth, phytodet.stat, type = "A"),
         int.phyto.ez = integrateTrapezoid(Depth, phyto.stat, type = "A"))  %>% 
  mutate_at(vars(contains("int.bcd"), contains("bcd.ez_npp")), round) %>% 
  # depth normalize 
  mutate_at(vars(int.bcd.cr_bge.ez:int.phyto.ez), funs(./ave_Ez)) %>% 
  mutate(int.NPP = ave_NPP/ave_Ez,
         sd_int.NPP = sd_NPP/ave_Ez, 
         mew.i = int.bp.ez/int.bc.i.ez,
         mew.s = int.bp.ez/int.bc.s.ez,
         bcd.ez_npp.cr_bge = int.bcd.cr_bge.ez/int.NPP * 100,
         bcd.ez_npp = int.bcd.ez/int.NPP * 100) %>% 
  select(Cruise:cr_bge, int.bcd.cr_bge.ez:bcd.ez_npp, Depth, contains("stat"), contains("cr.sr")) %>% 
  distinct() %>% 
  ungroup() %>% 
  left_join(., int_bcd_100)
    



```



```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}
int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.bcd.ez, int.bcd.cr_bge.ez) %>% 
  distinct() %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
  mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.ez, int.bcd.ez), names_to = "bcd", values_to = "value") %>%  
  mutate(bcd = ifelse(bcd == "int.bcd.cr_bge.ez", "Cruise-Specific BGE", "Campaign BGE"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(value)/10^3,
         sd = sd(value)/10^3) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  geom_text(aes(label = bge_stat, y = ave + 0.1), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}
int_bcd %>% 
  select(Cruise:Station, degree_bin, bcd.ez_npp.cr_bge, bcd.ez_npp ) %>% 
  distinct() %>% 
  mutate(degree_bin = as.character(degree_bin)) %>% 
   mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(bcd.ez_npp.cr_bge, bcd.ez_npp), names_to = "bcd_npp", values_to = "value") %>%  
  mutate(bcd_npp = ifelse(bcd_npp == "bcd.ez_npp.cr_bge", "Cruise-Specific BGE", "Campaign BGE"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(value),
         sd = sd(value)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y = ave, group = interaction(Season, Station, degree_bin)))  +
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1, fill = "#377EB8") +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
   geom_text(aes(label = bge_stat, y = ave + 10), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("BCD:NPP"))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank())
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.bcd.cr_bge.ez, int.bcd.ez) %>% 
  distinct() %>% 
   mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, "!", NA),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), "!", bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), "!", bge_stat)) %>% 
  pivot_longer(cols = c(int.NPP, int.bcd.cr_bge.ez, int.bcd.ez), names_to = "rate", values_to = "value") %>%  
  mutate(rate = ifelse(rate %in% c("int.bcd.cr_bge.ez", "int.bcd.ez"), "BCD", "NPP"),
         degree_bin = as.character(degree_bin),
         bge_stat = ifelse(rate == "BCD", NA, bge_stat)) %>% 
  group_by(Cruise, Station, rate) %>% 
  mutate(ave = mean(value)/10^3,
         sd = sd(value)/10^3,
         sd = ifelse(rate == "NPP", sd_int.NPP/10^3, sd )) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, fill = factor(rate, levels = c("NPP", "BCD")), y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
    geom_text(aes(label = bge_stat, y = ave + 1), position = position_dodge(width = 0.9), stat = "identity", size = 6, color = "#E41A1C") +
  labs(x = expression(italic("")), y = expression(italic(paste("mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.NPP, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.NPP - sd_int.NPP, ymax = int.NPP + sd_int.NPP), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.bp.ez, sd_int.bp.ez) %>% 
  distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.bp.ez, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.bp.ez - sd_int.bp.ez, ymax = int.bp.ez + sd_int.bp.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BP, µmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.ba.ez, sd_int.ba.ez) %>% 
  distinct() %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int.ba.ez, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = int.ba.ez - sd_int.ba.ez, ymax = int.ba.ez + sd_int.ba.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("")), y = expression(italic(paste("BA, cells m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

int_bcd %>% 
  select(Cruise:Station, degree_bin, mew.i, mew.s) %>% 
  distinct() %>% 
  pivot_longer(cols = c(mew.i, mew.s), names_to = "ccf", values_to = "mew") %>%  
  mutate(ccf = ifelse(ccf == "mew.i", "Initial CCF", "Stationary CCF"),
         degree_bin = as.character(degree_bin)) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(mew),
         sd = sd(mew)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  ave, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("µ, d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```
 
#### organized by NPP 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

bp <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.bp.ez, sd_int.bp.ez) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int.bp.ez, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), color = "black",  position = position_dodge(), stat = "identity",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = int.bp.ez - sd_int.bp.ez, ymax = int.bp.ez + sd_int.bp.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = "", y = expression(italic(paste("BP, µmol C m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() 
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
 # guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

ba <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, int.ba.ez, sd_int.ba.ez) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(contains("ba")), funs(round(./10^12, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int.ba.ez, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = int.ba.ez - sd_int.ba.ez, ymax = int.ba.ez + sd_int.ba.ez), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = "", y = expression(italic(paste("BA, * 10"^12, " cells  m"^-3))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() +
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F, linetype = F)
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 18, fig.align = "center", warning = FALSE}

mew <- int_bcd %>% 
  select(Cruise:Station, degree_bin, ave_Ez, int.NPP, sd_int.NPP, mew.s, mew.i) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3, 2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  pivot_longer(cols = c(mew.s, mew.i), names_to = "CCF", values_to = "mew") %>%  
  mutate(CCF = ifelse(CCF == "mew.i", "Initial", "Stationary")) %>% 
  group_by(Cruise, Station) %>% 
  mutate(ave = mean(mew),
         sd = sd(mew)) %>% 
  ungroup() %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  ave, group = interaction(Season, Station, int.NPP)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels), linetype = factor(Subregion, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1, size = 0.75, stroke = 1.5) +
  geom_errorbar(aes(ymin = ave - sd, ymax = ave + sd), position = position_dodge(width = 0.9), stat = "identity", width = 0.1, size = 0.5) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("µ, fmol C cell"^-1, "m"^-3, "d"^-1))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_x_discrete(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
   scale_linetype_manual(values = c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )) +
  custom_theme() +
  #facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F, linetype = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 10, fig.width = 14, fig.align = "center", warning = FALSE}
bp + ba + mew + plot_layout(ncol = 1, nrow = 3)
```


```{r}
bcd_table <- int_bcd %>% 
  select(Cruise:Station, degree_bin,  int.bcd.cr_bge.ez, int.bcd.ez) %>% 
  distinct() %>% 
  mutate_at(vars(int.bcd.cr_bge.ez, int.bcd.ez), funs(./1000)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.ez, int.bcd.ez), names_to = "var", values_to = "bcd") %>% 
  select(-var) %>% 
  distinct() %>% 
  group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
  summarise(ave_BCD = round(mean(bcd), 2),
            sd_BCD = round(sd(bcd), 2)) %>% 
  ungroup() %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin,  ave_Ez, sd_Ez, int.NPP, sd_int.NPP) %>% 
              distinct() %>% 
              mutate_at(vars(contains("NPP")), funs(round(./10^3, 2)))) %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin,   bcd.ez_npp.cr_bge, bcd.ez_npp) %>% 
              distinct() %>% 
              pivot_longer(cols = c( bcd.ez_npp.cr_bge, bcd.ez_npp), names_to = "var", values_to = "bcd_npp") %>% 
              select(-var) %>% 
              distinct() %>% 
              group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
              summarise(ave_BCD_NPP = mean(bcd_npp),
                        sd_BCD_NPP = sd(bcd_npp)) %>% 
              ungroup()
            
            ) %>% 
  left_join(., int_bcd %>% 
              select(Cruise:Station, degree_bin, int.bcd.cr_bge.100, int.bcd.100) %>% 
              distinct() %>% 
              pivot_longer(cols = c( int.bcd.cr_bge.100, int.bcd.100), names_to = "var", values_to = "bcd_100") %>% 
              select(-var) %>% 
              distinct() %>% 
              group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
              summarise(ave_BCD_100 = mean(bcd_100),
                        sd_BCD_100 = sd(bcd_100)) %>% 
              ungroup()
            
            ) %>% 
  arrange(factor(Season, levels = levels)) %>% 
  group_by(Cruise) %>% 
  mutate(Cruise_ave_Ez = mean(ave_Ez),
         Cruise_sd_Ez = sd(ave_Ez),
         Cruise_ave_NPP = mean(int.NPP),
         Cruise_sd_NPP = sd(int.NPP),
         Cruise_ave_BCD = mean(ave_BCD),
         Cruise_sd_BCD = sd(ave_BCD),
         Cruise_ave_BCD_NPP = mean(ave_BCD_NPP),
         Cruise_sd_BCD_NPP = sd(ave_BCD_NPP)
         ) %>% 
  ungroup() %>% 
  group_by(Cruise, Subregion) %>% 
  mutate(Cruise_SR_ave_NPP = mean(int.NPP),
         Cruise_SR_sd_NPP = mean(int.NPP),
         Cruise_SR_ave_BCD = mean(ave_BCD),
         Cruise_SR_sd_BCD = sd(ave_BCD),
         Cruise_SR_ave_BCD_NPP = mean(ave_BCD_NPP),
         Cruise_SR_sd_BCD_NPP = sd(ave_BCD_NPP)
         ) %>% 
  ungroup() %>% 
  mutate_at(vars(contains("BCD_NPP")), round) %>% 
  mutate_at(vars(ave_BCD_100:Cruise_sd_BCD, Cruise_SR_ave_NPP:Cruise_SR_sd_BCD ), round, 2) %>% 
  arrange(factor(Season, levels = levels), factor(Subregion, levels = levels))
```
```{r echo = FALSE, results = 'asis'}
kable(bcd_table, caption = "BCD & NPP")
```



```{r echo = FALSE}
bcd_npp.reg <- lmodel2(ave_BCD ~ int.NPP, data = bcd_table , nperm = 99)
```

```{r echo = FALSE}
bcd_npp.reg
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_table %>% 
  ggplot(aes(x = int.NPP, y = ave_BCD)) + 
  geom_abline(intercept = bcd_npp.reg$regression.results[3,2],
              slope = bcd_npp.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_BCD - sd_BCD, ymax = ave_BCD + sd_BCD), width = 0.1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = int.NPP - sd_int.NPP, xmax = int.NPP + sd_int.NPP), width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.17x + 0.07", paste("r"^2,"= 0.71, ", italic("p "), "<< 0.01"))), x = 3, y = 0.1, size = 7) 

```

#### Profiles


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(bp.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ave_Ez, bp.cr.sr, sd_bp.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = bp.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = bp.cr.sr - sd_bp.cr.sr, ymax = bp.cr.sr + sd_bp.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Production, µmol C m"^3, "d"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(ba.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ba.cr.sr, sd_ba.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = ba.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = ba.cr.sr - sd_ba.cr.sr, ymax = ba.cr.sr + sd_ba.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Abundance, Cells m"^3))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

# Merge Data with Export MS Data

Here, we put our experimental data in the context of the results from the export MS to explore remineralization of the seasonally accumulated DOC pool:

- We first calculate treatment averages for each experiment
- For the surface values at each station, we then subtract the DOC concentration of the winter/early springtime deeply mixed condition (from the export MS) from the DOC concentrations in the experiments conducted at the respective station (**norm_doc**).
- We estimate the concentration of the seasonally accumulated DOC pool as the difference between the initial DOC concentration in each experiment and the DOC concentration of the mixed condition (**accm_doc**)
- We then estimate the total DOC drawdown for the experiments (**bioav_doc**), the total remaining DOC after drawdown(**persis_doc**), the percent DOC bioavalability and persistence (**per_bioav** and **per_persis**, respectively)
- Lastly we calculate the rate of DOC drawdown (nmol C L^-1^ d^-1^, **ddoc**)


```{r message = F, warning = F}

export <- readRDS("~/naames_export_ms/Output/processed_export_for_bioavMS.5.14.20.rds") %>% 
  mutate(Cruise = gsub("AT39-6", "AT39", Cruise)) %>% 
  select(Cruise, Season, degree_bin, Subregion, Station, Target_Z, Ez, ave_N, sd_N, ave_PO4, sd_PO4, ave_Pro:sd_Nano, redis_DOC_vol, NCP_mol_100, doc_ncp_100, int_delta_DOC_100, doc_don_100, int_delta_N_100, int_N_100_vol, int_N_ez, int_PO4_100_vol, int_PO4_ez) %>% 
  distinct() %>% 
  mutate_at(vars(redis_DOC_vol, int_N_100_vol, int_PO4_100_vol), round, 1) %>% 
  mutate_at(vars(NCP_mol_100:doc_ncp_100, int_delta_DOC_100, int_delta_N_100, int_N_ez, int_PO4_ez), round, 2) %>%
  mutate_at(vars(doc_don_100), round) %>% 
  mutate_at(vars(Station), as.character) %>% 
  #error associated with the approach in calculating seasonally accumulated DON led to 17%  of total samples (5 of 29) being negative.  As a result these data were removed from further analyses.
  mutate(doc_don_100 = ifelse(doc_don_100 < 0, NA, doc_don_100), 
         total_phyto = ave_Pro + ave_Syn + ave_Pico + ave_Nano)


export_bioav <- left_join(calcs %>% filter(!Station == "U"), export %>% select(-c( Target_Z, ave_N, sd_N, ave_Pro:sd_Nano)) %>%  distinct()) %>% 
  mutate(redis_DOC_vol = ifelse(Station %in% c("S2RD", "S2RF"), 55.0, redis_DOC_vol),
         degree_bin = ifelse(is.na(degree_bin), 39, degree_bin)) %>%  
  group_by(Cruise, Station, Depth, Treatment, Hours) %>% 
  mutate(trt_ave_doc = ifelse(!is.na(interp_doc), round(mean(interp_doc, na.rm = T),1), NA),
         trt_sd_doc = ifelse(!is.na(doc), round(sd(doc, na.rm = T),1), NA)) %>% 
  ungroup() %>% 
  group_by(Cruise, Station, Depth, Treatment) %>% 
  mutate(norm_doc = ifelse(Depth != 200 | Treatment == "MixDS", trt_ave_doc - redis_DOC_vol, NA),
         norm_doc_from_t0 = ifelse(!is.na(norm_doc), first(norm_doc) - norm_doc, NA),
         accm_doc = ifelse(Depth == 10 & Treatment == "Control", first(trt_ave_doc) - redis_DOC_vol, NA),
         total.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, last(trt_ave_doc) - redis_DOC_vol, NA),
         st.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & Days == 7, trt_ave_doc - redis_DOC_vol, NA),
         lt.bioav_accm_doc = total.bioav_accm_doc - st.bioav_accm_doc,
         time.total.bioav_accm_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, last(Days), NA),
         time.lt.bioav_accm_doc = time.total.bioav_accm_doc - 7,
         total.bioav_doc = ifelse(Depth == 10 & Treatment == "Control" & last(Days) > 30, first(norm_doc) - last(norm_doc), NA),
         st.bioav_doc = ifelse(Depth == 10 & Treatment == "Control" & Days == 7, first(norm_doc) - norm_doc, NA),
         lt.bioav_doc = total.bioav_doc - st.bioav_doc,
         total.per_bioav = round((total.bioav_doc/accm_doc * 100)),
         st.per_bioav = round((st.bioav_doc/accm_doc * 100)),
         lt.per_bioav = round((lt.bioav_doc/accm_doc * 100)),
         persis_doc = accm_doc - total.bioav_doc,
         per_persis = round((persis_doc/accm_doc * 100)),
         st.ddoc = round((st.bioav_doc/7) * 1000),
         lt.ddoc = round((lt.bioav_doc/time.lt.bioav_accm_doc) * 1000),
         total.ddoc = round((total.bioav_doc/time.total.bioav_accm_doc) * 1000)) %>%   
  ungroup() %>% 
  group_by(Cruise, Station, Depth) %>% 
  fill(accm_doc:lt.ddoc, .direction = "downup") %>% 
  ungroup() %>% 
  select(Season:Station, ave_lat:Subregion, Depth:interp_doc, redis_DOC_vol:lt.ddoc, everything() ) %>% 
  left_join(., int_bcd %>% mutate_at(vars(Station), as.character)) %>% 
  mutate(Subregion = ifelse(Station %in% c("S2RF", "S2RD"), "GS/Sargasso", Subregion ))

    
```



## Nitrate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_N_100_vol) %>% 
  distinct() %>% 
  drop_na(int_N_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
n_ez <-  export %>%
  select(Season, Ez, int_N_ez) %>% 
  mutate(int_N_ez = ((int_N_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_N_ez) 

n_anova <- welch_anova_test(int_N_ez ~ Season, data = n_ez) 
n_anova 
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
n_gh <- games_howell_test(int_N_ez ~ Season, data = n_ez)
n_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

n_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.04")), x = "Early Spring", y = 1.5, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_N) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_N, sd_N) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_N = mean(ave_N),
         group_sd_N = sd(ave_N)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_N, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_N - group_N, ymax = group_N + group_N, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Nitrate, µmol N L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## Phosphate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_PO4_100_vol) %>% 
  distinct() %>% 
  drop_na(int_PO4_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
p_ez <-  export %>%
  select(Season, Ez, int_PO4_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

p_anova <- welch_anova_test(int_PO4_ez ~ Season, data = p_ez) 
p_anova 
```

#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
p_gh <- games_howell_test(int_PO4_ez ~ Season, data = p_ez)
p_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

p_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.21")), x = "Early Spring", y = 0.13, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   p_gh, label = "p.adj.signif",
  #   y.position = c(0.1, 0.12, 0.13, 0.14, 0.15, 0.16)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_PO4) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_PO4, sd_PO4) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_P = mean(ave_PO4),
         group_sd_P = sd(ave_PO4)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_P, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_P - group_P, ymax = group_P + group_P, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Phosphate, µmol P L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## N:P

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
np_ez <-  export %>%
  select(Season, Ez, int_PO4_ez, int_N_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10,
         int_N_ez = ((int_N_ez)/Ez)/10,
         int_NP_ez = int_N_ez/int_PO4_ez) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

np_anova <- welch_anova_test(int_NP_ez ~ Season, data = np_ez) 
np_anova 
```

```{r}
np_ez %>% 
  filter(Season == "Early Spring") %>% 
  summary()
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
np_gh <- games_howell_test(int_NP_ez ~ Season, data = np_ez)
np_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

np_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_NP_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("N:P")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.02")), x = "Early Spring", y = 32, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    np_gh, label = "p.adj.signif",
    y.position = c(25,24,23,29,21,27))
  
```



# ∆DOC

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 12, fig.align = "center", warning = FALSE}

export_bioav %>% 
  select(Season:Station, degree_bin, Subregion, ave_Ez, int.NPP, sd_int.NPP, int_delta_DOC_100) %>% 
  drop_na(int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(./10^3)) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(position = position_dodge(), stat = "identity", color = "black", fill = "#999999", alpha = 1) +
  # expression(italic("NPP, mmol C m"^-3, "d"^-1))
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_brewer(palette = "Set1") +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  #theme(strip.background = element_blank(), strip.text = element_blank()) +
  guides(fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 14, fig.align = "center", warning = FALSE}

export_bioav %>% 
  select(Season:Station, degree_bin, Subregion, ave_Ez, int.NPP, sd_int.NPP, int_delta_DOC_100) %>% 
  drop_na(int.NPP) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3,2))) %>% 
  mutate_at(vars(degree_bin, int.NPP), as.character) %>% 
  ##PLOT
  ggplot(aes(x = int.NPP, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(aes(fill = factor(Season, levels = levels)), position = position_dodge(), stat = "identity", color = "black",  alpha = 1) +
  labs(x = expression(italic("NPP, mmol C m"^-3, "d"^-1)), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) 
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 14, fig.align = "center", warning = FALSE}

export %>% 
  select(Season:Station, degree_bin, Subregion,  int_delta_DOC_100) %>% 
  drop_na(int_delta_DOC_100) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3,2))) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(fill = "#999999", position = position_dodge(), stat = "identity", color = "black",  alpha = 1) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) 
```




```{r}
aov.delta_doc <- export_bioav %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
ddoc_anova <- welch_anova_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc) 
ddoc_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
ddoc_gh <- games_howell_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc)
ddoc_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
library(ggpubr)

export %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_delta_DOC_100)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC, mol C m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    ddoc_gh, label = "p.adj.signif", 
    y.position = c(1.5, 1.4, 1.3, 1.8, 0.45, 1.7)
    )
  
  
```


# DOC:DON

```{r}
aov.cn <- export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  filter(!doc_don_100 > 90) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}

cn_anova <- welch_anova_test(doc_don_100 ~ Season, data = aov.cn) 
cn_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
cn_gh <- games_howell_test(doc_don_100 ~ Season, data = aov.cn)
cn_gh
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = doc_don_100)) +
  geom_boxplot(width = 0.3, outlier.color = "white", outlier.fill = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC:DON")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.15")), x = "Early Spring", y = 95, size = 4, hjust = 0) 
  
  
```

```{r}
export %>%
  select(Season, int_delta_DOC_100, doc_don_100) %>% 
  rename(accm_doc = int_delta_DOC_100) %>% 
  group_by(Season) %>% 
  summarise(ave_accm_doc = round(mean(accm_doc, na.rm = T), 2),
            sd_accm_doc = round(sd(accm_doc, na.rm = T), 2),
            med_accm_doc = round(median(accm_doc, na.rm = T), 2),
            min_accm_doc = round(min(accm_doc, na.rm = T), 2),
            max_accm_doc = round(max(accm_doc, na.rm = T), 2),
            
            ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```

```{r}
export %>%
  select(Season, doc_don_100) %>% 
  group_by(Season) %>% 
  filter(!doc_don_100 > 90) %>% 
  summarise(ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```



# Remineralization of Seasonally Accumulated DOC

### NAAMES 2

#### No Addition

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~degree_bin, scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  filter(Cruise == "AT34", Treatment == "Control", Depth == 10) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~Station, scales = "free") +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Station == 2) %>% 
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT34", Station == 2) %>% 
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  ggtitle("NAAMES 2 DOC") + 
  guides(color = F, fill = F)
```


## NAAMES 3

#### No Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Treatment == "Control") %>%  
   drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 DOC") + 
  guides(color = F, fill = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Treatment == "Control") %>%  
  drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 DOC") + 
  guides(color = F, fill = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Station == 1, Treatment %in% c("Control", "SynExd", "SynLys", "TWExd")) %>%
 drop_na(trt_sd_doc) %>% 
  drop_na(norm_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free_y") +
  ggtitle("NAAMES 3 Station 1 Addition Experiment") + 
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Station == 1, Treatment %in% c("Control", "SynExd", "SynLys", "TWExd")) %>%
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free_y") +
  ggtitle("NAAMES 3 Station 1 Addition Experiment") + 
  guides(color = F)


```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Depth == 10, Station %in% c(1, 3, 6), Treatment %in% c("Control", "SynLys")) %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 Addition Experiments") +
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT38", Depth == 10, Station %in% c(1, 3, 6), Treatment %in% c("Control", "SynLys")) %>% 
  drop_na(norm_doc) %>%
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = facet_treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = facet_treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 3 Addition Experiments") +
  guides(color = F)

```


### NAAMES 4

#### No Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Treatment == "Control") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Station)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Station), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Station), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 4 DOC") +
  guides(color = F)

```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Treatment == "Control") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Station)) + 
  geom_point(aes(fill = Station), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Station), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~degree_bin, scales = "free") +
  ggtitle("NAAMES 4 DOC") +
  guides(color = F)

```


#### Additions

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Station == 2, !Treatment == "Parallel") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  facet_grid(~facet_treatment, scales = "free") +
  guides(fill = F, color = F)

```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 10, fig.align = "center", warning = FALSE}
export_bioav %>% 
  filter(Cruise == "AT39", Station == 2, !Treatment == "Parallel") %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Cruise, Station, degree_bin, Depth, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  distinct() %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = -norm_doc_from_t0, group = Treatment)) + 
  geom_point(aes(fill = Treatment), size = 4, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Treatment), alpha = 0.7) +
  #scale_color_manual(values = custom.colors) +
  #scale_fill_manual(values = custom.colors) +
  labs(y = expression(paste("Delta Seasonally Accumulated DOC, µmol C L"^-1))) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~facet_treatment, scales = "free_y") +
  guides(fill = F, color = F)

```

## Seasonal Comparison

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 16, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  select(Season, Cruise, Station, stationary, Subregion, degree_bin, Depth, Treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc) %>% 
  mutate(bge_stat = ifelse(Cruise == "AT39" & Station == 4, T, F),
         bge_stat = ifelse(Cruise == "AT34" & Station %in% c(1, 2, 3), T, bge_stat),
         bge_stat = ifelse(Cruise == "AT38" & Station %in% c(3, 6), T, bge_stat)) %>% 
  distinct() %>% 
  filter(Treatment == "Control", Depth == 10) %>% 
  mutate(degree_bin = paste(degree_bin, "˚N")) %>% 
  group_by(Cruise, Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = interaction(Cruise, Station, degree_bin))) + 
  geom_hline(aes(yintercept = 0)) +
  geom_vline(aes(xintercept = 7), linetype = 2) +
  geom_vline(aes(xintercept = 30), linetype = 3) +
  geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 3, shape = 21, alpha = 0.7 ) +
  geom_line(aes(color = Season, linetype = bge_stat), size = 0.75, alpha = 0.7) +
  geom_label(aes(x = 7, y = -1, label = "Short-Term"), size = 3) +
  geom_label(aes(x = 30, y = -1, label = "Long-Term"), size = 3) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  guides(color = F, linetype = F)
```

```{r}
bioav.table <- export_bioav %>% 
  filter(Depth == 10, Treatment == "Control") %>% 
  select(Season:Subregion, contains("bioav_doc"), contains("per_bioav"), contains("persis"), contains("ddoc")) %>% 
  distinct() %>% 
  group_by(Season, Subregion) %>% 
  summarise(ave_total.per_bioav = round(mean(total.per_bioav, na.rm = T), 2),
            sd_total.per_bioav = round(sd(total.per_bioav, na.rm = T), 2),
            ave_st.per_bioav = round(mean(st.per_bioav, na.rm = T), 2),
            sd_st.per_bioav = round(sd(st.per_bioav, na.rm = T), 2),
            ave_lt.per_bioav = round(mean(lt.per_bioav, na.rm = T), 2),
            sd_lt.per_bioav = round(sd(lt.per_bioav, na.rm = T), 2),
            
            ave_per_persis = round(mean(per_persis, na.rm = T), 2),
            sd_per_persis = round(sd(per_persis, na.rm = T), 2),
            
            ave_st.ddoc = round(mean(st.ddoc, na.rm = T), 2),
            sd_st.ddoc = round(sd(st.ddoc, na.rm = T), 2),
            ave_lt.ddoc = round(mean(lt.ddoc, na.rm = T), 2),
            sd_lt.ddoc = round(sd(lt.ddoc, na.rm = T), 2),
            ave_total.ddoc = round(mean(total.ddoc, na.rm = T), 2),
            sd_total.ddoc = round(sd(total.ddoc, na.rm = T), 2),
            
            ) %>%
   arrange(factor(Season, levels = levels)) %>% 
  ungroup()
```


```{r echo = FALSE, results = 'asis'}
kable(bioav.table, caption = "Seasonal Accumulated DOC Bioavailability and Persistance")
```


```{r}

bcd_bioav_table <- int_bcd %>% 
  select(Cruise:Station, degree_bin,  int.bcd.cr_bge.100, int.bcd.100, int.bcd.ez) %>% 
  distinct() %>% 
  #convert from µmol C m-3 d-1 to µmol C m-2 d-1
  mutate_at(vars(int.bcd.cr_bge.100:int.bcd.100), funs(./1000)) %>% 
  pivot_longer(cols = c(int.bcd.cr_bge.100, int.bcd.100), names_to = "var", values_to = "bcd") %>%
  select(-var) %>%
  distinct() %>% 
  group_by(Cruise, Season, Subregion, degree_bin, Station) %>% 
  summarise(ave_BCD = mean(bcd),
            sd_BCD = sd(bcd)) %>% 
  ungroup() %>% 
  mutate(Station = as.character(Station)) %>% 
  left_join(. , export) %>% 
   arrange(factor(Season, levels = levels))  %>% 
  filter(!doc_don_100 > 50) 

  
```

```{r}
bcd_bioav.reg_data <- bcd_bioav_table %>% 
  group_by(Cruise, Subregion) %>% 
  mutate(group_bcd = mean(ave_BCD),
         sd_group_bcd = sd(ave_BCD)) %>% 
  select(Cruise:Subregion, group_bcd, sd_group_bcd) %>% 
  distinct() %>% 
  left_join(., bioav.table)

bcd_total_bioav.reg <-  bcd_bioav.reg_data %>% 
  drop_na(ave_total.per_bioav)

bcd_st_bioav.reg_data <-  bcd_bioav.reg_data %>% 
  drop_na(ave_st.per_bioav)
  

```

```{r}
lmodel2(group_bcd ~ ave_total.per_bioav, data = bcd_total_bioav.reg , nperm = 99)
```
```{r}
bcd_st_bioav.reg <- lmodel2(group_bcd ~ ave_st.per_bioav, data = bcd_st_bioav.reg_data, nperm = 99)

bcd_st_bioav.reg 
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_st_bioav.reg_data %>% 
  ggplot(aes(x = ave_st.per_bioav, y = group_bcd)) + 
  geom_abline(intercept = bcd_st_bioav.reg$regression.results[3,2],
              slope = bcd_st_bioav.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = group_bcd - sd_group_bcd, ymax = group_bcd + sd_group_bcd), width = 1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_st.per_bioav - sd_st.per_bioav, xmax = ave_st.per_bioav + sd_st.per_bioav), width = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC % Bioavailability (< 7 d)"))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.006x + 0.08", paste("r"^2,"= 0.64, ", italic("p "), "= 0.03"))), x = 70, y = 0.13, size = 7) 

```


```{r}
bioav.table2 <- export_bioav %>% 
  filter(Depth == 10, Treatment == "Control") %>% 
  select(Season:Subregion, contains("bioav_doc"), contains("per_bioav"), contains("persis"), contains("ddoc")) %>% 
  distinct() %>% 
  group_by(Season, degree_bin, Station) %>% 
  summarise(ave_total.per_bioav = round(mean(total.per_bioav, na.rm = T), 2),
            sd_total.per_bioav = round(sd(total.per_bioav, na.rm = T), 2),
            ave_st.per_bioav = round(mean(st.per_bioav, na.rm = T), 2),
            sd_st.per_bioav = round(sd(st.per_bioav, na.rm = T), 2),
            ave_lt.per_bioav = round(mean(lt.per_bioav, na.rm = T), 2),
            sd_lt.per_bioav = round(sd(lt.per_bioav, na.rm = T), 2),
            
            ave_per_persis = round(mean(per_persis, na.rm = T), 2),
            sd_per_persis = round(sd(per_persis, na.rm = T), 2),
            
            ave_st.ddoc = round(mean(st.ddoc, na.rm = T), 2),
            sd_st.ddoc = round(sd(st.ddoc, na.rm = T), 2),
            ave_lt.ddoc = round(mean(lt.ddoc, na.rm = T), 2),
            sd_lt.ddoc = round(sd(lt.ddoc, na.rm = T), 2),
            ave_total.ddoc = round(mean(total.ddoc, na.rm = T), 2),
            sd_total.ddoc = round(sd(total.ddoc, na.rm = T), 2),
            
            ) %>%
   arrange(factor(Season, levels = levels)) %>% 
  ungroup() %>% 
  left_join(., bcd_bioav_table %>% 
              group_by(Cruise, degree_bin, Station) %>% 
              mutate(group_bcd = mean(ave_BCD),
                     sd_group_bcd = sd(ave_BCD)) %>% 
              select(Cruise:Subregion,degree_bin, group_bcd, sd_group_bcd) %>%
              distinct() )

bcd_total_bioav.reg_data <-  bioav.table2 %>% 
  drop_na(ave_total.per_bioav)

bcd_st_bioav.reg_data <-  bioav.table2 %>% 
  drop_na(ave_st.per_bioav)
```

```{r}
bcd_st_bioav.reg <- lmodel2(group_bcd ~ ave_st.per_bioav, data = bcd_st_bioav.reg_data, nperm = 99)

bcd_st_bioav.reg 
```
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_st_bioav.reg_data %>% 
  ggplot(aes(x = ave_st.per_bioav, y = group_bcd)) + 
  geom_abline(intercept = bcd_st_bioav.reg$regression.results[3,2],
              slope = bcd_st_bioav.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = group_bcd - sd_group_bcd, ymax = group_bcd + sd_group_bcd), size = 0.2, width = 0.1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = ave_st.per_bioav - sd_st.per_bioav, xmax = ave_st.per_bioav + sd_st.per_bioav), size = 0.2, width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Accumulated DOC % Bioavailability (< 7 d)"))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() #+
  #annotate( geom = "text", label = expression(atop("y = 0.006x + 0.08", paste("r"^2,"= 0.64, ", italic("p "), "= 0.03"))), x = 3, y = 0.1, size = 7) 

```

##


```{r echo = FALSE}
bcd_doc.reg <- lmodel2(ave_BCD ~ int_delta_DOC_100, data = bcd_bioav_table , nperm = 99)
```

```{r echo = FALSE}
bcd_doc.reg 
```
```{r echo = FALSE}
bcd_cn.reg <- lmodel2(ave_BCD ~ doc_don_100, data = bcd_bioav_table , nperm = 99)
```

```{r echo = FALSE}
bcd_cn.reg
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_bioav_table %>% 
  select(Season, int_delta_DOC_100, ave_BCD) %>% 
  distinct() %>% 
  ggplot(aes(x = int_delta_DOC_100, y = ave_BCD)) + 
  geom_abline(intercept = bcd_doc.reg$regression.results[3,2],
             slope = bcd_doc.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC, mol C m"^-2))), y = expression(italic(paste("BCD, µmol C m"^-2, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  custom_theme() +
    annotate( geom = "text", label = expression(atop("y = -0.31x + 0.33", paste("r"^2,"= 0.14, ", italic("p "), "= 0.14"))), x = 0.8, y = 0.3, size = 7) 

```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_bioav_table %>% 
  select(Season, doc_don_100, ave_BCD, sd_BCD) %>% 
  distinct() %>%  
  ggplot(aes(x = doc_don_100, y = ave_BCD)) + 
  geom_abline(intercept = bcd_cn.reg$regression.results[3,2],
             slope = bcd_cn.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar( aes(color = factor(Season, levels = levels), ymax = ave_BCD + sd_BCD, ymin = ave_BCD - sd_BCD), width = 0.4) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("Seasonally Accumulated DOC:DON"))), y = expression(italic(paste("BCD, mmol C m"^-2, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
    annotate( geom = "text", label = expression(atop("y = -0.01x + 0.32", paste("r"^2,"= 0.09, ", italic("p "), "<< 0.01"))), x = 30, y = 0.4, size = 7) 

```

This seasonal comparison is best exemplifies at 44˚N where we have experiments from all cruises. It shows:

- an increase in the accumulated DOC pool from the early spring to the early autumn
- an increase in the persistent fraction of the bulk DOC as the seasons progress
  + DOC in the early spring does not accumulate (also apparent at 39˚N)
  + 64% of DOC pool in the late spring was persistent while 69% of the DOC pool in the early autumn was persistent. This would imply an increase of the persistent DOC fraction by 5%. I think this suggests that most of the net production of persistent DOC occurs in the late spring, closer to the timing of the bloom peak. 

Overall, there are elevated persistent fractions in the late spring and early autumn, with greater proportion of the early autumn pool beeing more consistently persistant. 

Our addition experiments are consistent with our definition of DOC persistence. In every cruise, the addition of SPE-DOM substrates (different quality and substrates) stimulated drawdown of accumulated DOC and bacterioplankton growth, but did not result in drawdown into the persistent pool. 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 16, fig.align = "center", warning = FALSE}
export_bioav %>% 
  drop_na(norm_doc) %>% 
  drop_na(trt_sd_doc) %>% 
  mutate(Addition = ifelse(Treatment == "Control", F, T)) %>% 
  select(Season, Cruise, Station, degree_bin, Depth, Addition, Treatment, facet_treatment, Days, norm_doc, norm_doc_from_t0, trt_sd_doc, accm_doc, total.bioav_accm_doc) %>% 
  distinct() %>% 
  filter(Depth == 10, !Treatment %in% c("MixDS", "MixSD"), !Cruise == "AT34", Addition == T) %>% 
  mutate(degree_bin = paste(degree_bin, "˚N"), 
         plot_treatment = ifelse(Cruise != "AT39", facet_treatment, "T. Weissflogii Exudate")) %>% 
  group_by(Cruise, Station, Depth, Treatment) %>%
  ggplot(aes(x = Days, y = norm_doc, group = Treatment)) + 
  geom_hline(aes(yintercept = 0)) +
  geom_hline(aes(yintercept = accm_doc), linetype = 2) +
  geom_label(aes(x = 50, y = accm_doc + 1.75, label = "Seasonally Accm. DOC"), size = 3) +
  geom_hline(aes(yintercept = total.bioav_accm_doc), linetype = 3) +
  geom_label(aes(x = 45, y = total.bioav_accm_doc - 1.5, label = "Non-addition Bioavailable DOC"), size = 3) +
  geom_line(aes(color = plot_treatment), alpha = 0.7) +
   geom_errorbar(aes(ymin = norm_doc - trt_sd_doc, ymax = norm_doc + trt_sd_doc), width = 0.5) +
   geom_point(aes(fill = plot_treatment, shape = factor(Season, levels = levels)), size = 4, alpha = 0.7 ) +
  scale_color_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  scale_shape_manual(values = custom.shapes) +
  facet_grid(~degree_bin, scales = "free") +
  labs(y = expression(paste("Seasonally Accumulated DOC, µmol C L"^-1))) +
  custom_theme() +
  guides(fill = F)
```






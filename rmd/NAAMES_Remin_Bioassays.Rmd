---
title: "NAAMES DOC Remineralization Bioassays - Bottles"
author: "Nicholas Baetge"
date: "2/29/2020"
output: github_document
---



 




```{r echo = FALSE}
bcd_npp.reg <- lmodel2(ave_BCD ~ int.NPP, data = bcd_table , nperm = 99)
```

```{r echo = FALSE}
bcd_npp.reg
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8, fig.align = "center", warning = FALSE}
bcd_table %>% 
  ggplot(aes(x = int.NPP, y = ave_BCD)) + 
  geom_abline(intercept = bcd_npp.reg$regression.results[3,2],
              slope = bcd_npp.reg$regression.results[3,3],colour = "black", linetype = 2, size = 1) +
  geom_errorbar(aes(color = factor(Season, levels = levels), ymin = ave_BCD - sd_BCD, ymax = ave_BCD + sd_BCD), width = 0.1) +
  geom_errorbarh(aes(color = factor(Season, levels = levels), xmin = int.NPP - sd_int.NPP, xmax = int.NPP + sd_int.NPP), width = 0.1) +
  geom_point( aes(fill = factor(Season, levels = levels)), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  labs(x = expression(italic(paste("NPP, mmol C m"^-3, "d"^-1))), y = expression(italic(paste("BCD, mmol C m"^-3, "d"^-1)))) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme() +
  guides(color = F) +
  annotate( geom = "text", label = expression(atop("y = 0.17x + 0.07", paste("r"^2,"= 0.71, ", italic("p "), "<< 0.01"))), x = 3, y = 0.1, size = 7) 

```

#### Profiles


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(bp.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ave_Ez, bp.cr.sr, sd_bp.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = bp.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = bp.cr.sr - sd_bp.cr.sr, ymax = bp.cr.sr + sd_bp.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Production, µmol C m"^3, "d"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
bcd %>% 
  drop_na(ba.cr.sr) %>% 
  filter(Depth %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Depth, ba.cr.sr, sd_ba.cr.sr) %>% 
  distinct() %>% 
  ggplot(aes(x = Depth, y = ba.cr.sr, group = interaction(Cruise, Subregion))) +
  geom_errorbar(aes(x = Depth, ymin = ba.cr.sr - sd_ba.cr.sr, ymax = ba.cr.sr + sd_ba.cr.sr, color = Season), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Season, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Season, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Bacterial Abundance, Cells m"^3))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Subregion, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```




## Nitrate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_N_100_vol) %>% 
  distinct() %>% 
  drop_na(int_N_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
n_ez <-  export %>%
  select(Season, Ez, int_N_ez) %>% 
  mutate(int_N_ez = ((int_N_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_N_ez) 

n_anova <- welch_anova_test(int_N_ez ~ Season, data = n_ez) 
n_anova 
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
n_gh <- games_howell_test(int_N_ez ~ Season, data = n_ez)
n_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

n_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_N_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Nitrate, mol N m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.04")), x = "Early Spring", y = 1.5, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_N) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_N, sd_N) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_N = mean(ave_N),
         group_sd_N = sd(ave_N)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_N, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_N - group_N, ymax = group_N + group_N, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Nitrate, µmol N L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## Phosphate

### Surface 100 m

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, int_PO4_100_vol) %>% 
  distinct() %>% 
  drop_na(int_PO4_100_vol) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_100_vol/10)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() 
  # annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  # stat_pvalue_manual(
  #   ddoc_gh, label = "p.adj.signif", 
  #   y.position = c(1.7, 1.3, 1.4, 1.8, 0.45, 1.5)
  #   )
  
```

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
p_ez <-  export %>%
  select(Season, Ez, int_PO4_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

p_anova <- welch_anova_test(int_PO4_ez ~ Season, data = p_ez) 
p_anova 
```

#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
p_gh <- games_howell_test(int_PO4_ez ~ Season, data = p_ez)
p_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

p_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_PO4_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Phosphate, mol P m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.21")), x = "Early Spring", y = 0.13, size = 4, hjust = 0)  
  # stat_pvalue_manual(
  #   p_gh, label = "p.adj.signif",
  #   y.position = c(0.1, 0.12, 0.13, 0.14, 0.15, 0.16)
  #   )
  
```




```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 20, fig.align = "center", warning = FALSE}
export %>% 
  drop_na(ave_PO4) %>% 
  filter(Target_Z %in% c(0, 5, 10, 25, 75, 100, 150, 200, 300)) %>% 
  select(Season, Cruise, Subregion, Station, Target_Z, Ez, ave_PO4, sd_PO4) %>% 
  distinct() %>% 
  group_by(Cruise, Subregion, Target_Z) %>% 
  mutate(group_P = mean(ave_PO4),
         group_sd_P = sd(ave_PO4)) %>% 
  ungroup() %>% 
  group_by(Cruise) %>% 
  mutate(group_Ez = mean(Ez),
         group_sd_Ez = sd(Ez)) %>% 
  ungroup() %>% 
  select(Season:Target_Z, contains("group")) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = Target_Z, y = group_P, group = interaction(Cruise, Subregion))) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = group_Ez - group_sd_Ez, xmax = group_Ez + group_sd_Ez), fill = "#FDF6E2", alpha = 0.8) + 
  geom_vline(aes(xintercept = group_Ez + group_sd_Ez), linetype = 1) +
  geom_vline(aes(xintercept = group_Ez - group_sd_Ez), linetype = 1) +
  
  geom_errorbar(aes(x = Target_Z, ymin = group_P - group_P, ymax = group_P + group_P, color = Subregion), width = 2, size = 0.5) +
  geom_line(aes(colour = factor(Subregion, levels = levels)), size = 0.7) +
  geom_point(aes(fill = factor(Subregion, levels = levels)), size = 4, shape = 21, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = expression(italic(paste("Depth, m"))), y = expression(italic(paste("Phosphate, µmol P L"^-1))), colour = "") +
  scale_x_reverse(breaks = pretty_breaks(), expand = c(0,0)) +
  coord_flip() +
  #scale_y_continuous(expand = c(0,0)) +
  scale_colour_manual(values = custom.colors) +
  scale_fill_manual(values = custom.colors) +
  guides(colour = F) +
  #guides(fill = F) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") +
  theme(panel.spacing.x = unit(1, "cm"))
```

## N:P

### Euphotic Zone


#### Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption is violated

```{r}
np_ez <-  export %>%
  select(Season, Ez, int_PO4_ez, int_N_ez) %>% 
  mutate(int_PO4_ez = ((int_PO4_ez)/Ez)/10,
         int_N_ez = ((int_N_ez)/Ez)/10,
         int_NP_ez = int_N_ez/int_PO4_ez) %>% 
  distinct() %>% 
  drop_na(int_PO4_ez) 

np_anova <- welch_anova_test(int_NP_ez ~ Season, data = np_ez) 
np_anova 
```

```{r}
np_ez %>% 
  filter(Season == "Early Spring") %>% 
  summary()
```


#### Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
np_gh <- games_howell_test(int_NP_ez ~ Season, data = np_ez)
np_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 6, fig.align = "center", warning = FALSE}

np_ez %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_NP_ez)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("N:P")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
   annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.02")), x = "Early Spring", y = 32, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    np_gh, label = "p.adj.signif",
    y.position = c(25,24,23,29,21,27))
  
```



# ∆DOC

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 3.5, fig.width = 14, fig.align = "center", warning = FALSE}

export %>% 
  select(Season:Station, degree_bin, Subregion,  int_delta_DOC_100) %>% 
  drop_na(int_delta_DOC_100) %>% 
  distinct() %>% 
  mutate_at(vars(contains("NPP")), funs(round(./10^3,2))) %>% 
  mutate_at(vars(degree_bin), as.character) %>% 
  ##PLOT
  ggplot(aes(x = degree_bin, y =  int_delta_DOC_100, group = interaction(Season, Station, degree_bin)))  + 
  geom_bar(fill = "#999999", position = position_dodge(), stat = "identity", color = "black",  alpha = 1) +
  labs(x = expression(italic("Latitude, ˚N")), y = expression(italic(paste("∆DOC, mol C m"^-2))), colour = expression(italic(""))) +
  scale_y_continuous(breaks = pretty_breaks()) +
  #scale_fill_manual(values = custom.colors) +
  custom_theme() +
  facet_grid(~factor(Season, levels = levels), scales = "free") 
  #theme(strip.background = element_blank(), strip.text = element_blank()) 
```




```{r}
aov.delta_doc <- export_bioav %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}
ddoc_anova <- welch_anova_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc) 
ddoc_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
ddoc_gh <- games_howell_test(int_delta_DOC_100 ~ Season, data = aov.delta_doc)
ddoc_gh
```


```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
library(ggpubr)

export %>%
  select(Season, int_delta_DOC_100) %>% 
  distinct() %>% 
  drop_na(int_delta_DOC_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = int_delta_DOC_100)) +
  geom_boxplot(width = 0.3, outlier.fill = "white", outlier.color = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC, mol C m"^-2)), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "<< 0.01")), x = "Early Spring", y = 2.1, size = 4, hjust = 0)  +
  stat_pvalue_manual(
    ddoc_gh, label = "p.adj.signif", 
    y.position = c(1.5, 1.4, 1.3, 1.8, 0.45, 1.7)
    )
  
  
```


# DOC:DON

```{r}
aov.cn <- export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  filter(!doc_don_100 > 90) 

```
## Welch's one-Way ANOVA test 

Alternative to standard one-way ANOVA in the situation where the homogeneity of variance assumption iss violated

```{r}

cn_anova <- welch_anova_test(doc_don_100 ~ Season, data = aov.cn) 
cn_anova 
```


## Post-hoc analysis

Games-Howell test used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated

```{r}
cn_gh <- games_howell_test(doc_don_100 ~ Season, data = aov.cn)
cn_gh
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 6, fig.align = "center", warning = FALSE}
export %>%
  select(Season, doc_don_100) %>% 
  distinct() %>% 
  drop_na(doc_don_100) %>% 
  ggplot(aes(x = factor(Season, levels = levels), y = doc_don_100)) +
  geom_boxplot(width = 0.3, outlier.color = "white", outlier.fill = "white") +
  geom_jitter(fill = "white", width = 0.1, shape = 21, size = 3, alpha = 0.7) + 
  labs(x = "", y = expression(italic("Seasonally Accumulated DOC:DON")), colour = expression(italic(""))) + 
  scale_fill_brewer(palette = "Set1") +
  custom_theme() +
  annotate( geom = "text", label = expression(paste("Welch's one-Way ANOVA, ", italic("p "), "= 0.15")), x = "Early Spring", y = 95, size = 4, hjust = 0) 
  
  
```

```{r}
export %>%
  select(Season, int_delta_DOC_100, doc_don_100) %>% 
  rename(accm_doc = int_delta_DOC_100) %>% 
  group_by(Season) %>% 
  summarise(ave_accm_doc = round(mean(accm_doc, na.rm = T), 2),
            sd_accm_doc = round(sd(accm_doc, na.rm = T), 2),
            med_accm_doc = round(median(accm_doc, na.rm = T), 2),
            min_accm_doc = round(min(accm_doc, na.rm = T), 2),
            max_accm_doc = round(max(accm_doc, na.rm = T), 2),
            
            ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```

```{r}
export %>%
  select(Season, doc_don_100) %>% 
  group_by(Season) %>% 
  filter(!doc_don_100 > 90) %>% 
  summarise(ave_doc_don = round(mean(doc_don_100, na.rm = T)),
            sd_doc_don = round(sd(doc_don_100, na.rm = T)),
            med_doc_don = round(median(doc_don_100, na.rm = T)),
            min_doc_don = round(min(doc_don_100, na.rm = T)),
            max_doc_don = round(max(doc_don_100, na.rm = T))
            ) %>% 
   arrange(factor(Season, levels = levels))
  
```






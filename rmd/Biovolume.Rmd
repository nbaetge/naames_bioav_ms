---
title: "Biovolume"
author: "Nicholas Baetge"
date: "5/20/2020"
output: html_document
---

This document shows how **individual bottle** bacterial biovolume data from NAAMES remineralization bioassays were processed, QC'd, and analyzed. To date, there are limited biovolume data (2-4 timepoints for a single bottle for each station on the early spring and early autumn cruises). The data are somewhat suspect as bacterial abundance estimates from image analysis are non-systematically different from previous manual counts. 

```{r message = F, warning = F}
library(tidyverse) 
library(rmarkdown)
library(knitr)
library(readxl)
library(data.table) 
library(scales)
library(zoo)
library(oce)
library(patchwork)
#rmarkdown tables
library(stargazer)
library(pander)
library(growthcurver)
#stat tests
library(lmtest)
library(lmodel2)
library(rstatix)
library(ggpubr)
```


```{r include = FALSE}
custom_theme <- function() {
  theme_test(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom_theme_linedraw <- function() {
  theme_linedraw(base_size = 16) %+replace%
    theme(legend.position = "top",
          legend.title = element_blank(),
          legend.spacing.x = unit(0.5,"cm"),
          legend.background = element_rect(fill = "transparent",colour = NA),
          legend.key = element_rect(fill = "transparent",colour = NA),
          panel.background = element_rect(fill = "transparent",colour = NA),
          plot.background = element_rect(fill = "transparent",colour = NA),
          strip.text.x = element_text(size = 14, color = "white", face = "bold.italic"),
          strip.text.y = element_text(size = 14, color = "white", face = "bold.italic", angle = 270),
          strip.background = element_rect(color = "black", fill = "#005a9c", size = 0.5, linetype = "solid")) 
}

custom.colors <- c("AT39" = "#377EB8", "AT34" = "#4DAF4A", "AT38" = "#E41A1C", "AT32" = "#FF7F00", "Temperate" = "#A6CEE3", "Subpolar" = "#377EB8", "Subtropical" = "#FB9A99", "GS/Sargasso" = "#E41A1C", "Early Spring" = "#377EB8", "Late Spring" = "#4DAF4A","Early Autumn" = "#E41A1C", "Summer" = "#E41A1C", "Late Autumn" = "#FF7F00", "A" = "#E41A1C", "B" = "#377EB8", "C" = "#4DAF4A", "D" = "#FF7F00", "E" = "#FDB927", "F" = "#552583", "G" = "#FDB927", "H" = "#552583",   "Control" = "#E41A1C", "TW12" = "#377EB8", "T. Weissflogii 12C Exudate" = "#377EB8", "TW13" = "#4DAF4A", "T. Weissflogii 13C Exudate" = "#4DAF4A", "MixDS" = "#377EB8", "Deep Comm., Surface DOM" = "#377EB8","MixSD" = "#4DAF4A", "Surface Comm., Deep DOM" = "#4DAF4A", "SynLys" = "#377EB8", "Synechococcus Lysate" = "#377EB8", "SynExd" = "#4DAF4A", "Synechococcus Exudate" = "#4DAF4A", "TWExd" = "#FF7F00", "T. Weissflogii Exudate" = "#FF7F00", "TW5" = "#377EB8", "TW10" = "#4DAF4A", "TW20" = "#FF7F00", "Parallel" = "#377EB8", "W" = "#552583", "Whole Seawater" = "#552583", "1.2" = "#4DAF4A", "1.2 µm Filtrate" = "#4DAF4A", "NV" = "#FF7F00", "1.2 µm Filtrate: TFF Filtrate (3:7)" = "#FF7F00", "Carbon" = "#E41A1C", "Nitrogen" = "#377EB8", "+5 µmol C/L Exudate" = "#FF7F00", "+10 µmol C/L Exudate" = "#FF7F00", "+20 µmol C/L Exudate" = "#FF7F00", "Filter 1" = "#E41A1C", "Filter 2" = "#377EB8", "10 m" = "#E41A1C", "200 m" = "#377EB8", "BCD" = "#377EB8" , "NPP" = "#4DAF4A" , "Cruise Specific BGE" = "#377EB8", "Global BGE" = "#4DAF4A") 

custom.shapes <- c("Early Spring" = 21, "Late Spring" = 22,"Early Autumn" = 23)

custom.lines <- c("GS/Sargasso" = "blank", "Subtropical" = "solid", "Temperate" = "longdash", "Subpolar" = "dotted" )


levels = c("GS/Sargasso", "Subtropical", "Temperate", "Subpolar",  "AT39-6", "AT34", "AT38", "AT32","South", "North", "Early Spring", "Late Spring","Early Autumn",  "Summer", "Late Autumn", "Control", "Parallel", "SynLys", "SynExd", "TWExd", "MixSD", "MixDS", "TW12", "TW13", "TW5", "TW10", "TW20",  "Surface Comm., Deep DOM", "Deep Comm., Surface DOM", "Synechococcus Exudate", "Synechococcus Lysate", "T. Weissflogii Exudate", "T. Weissflogii 12C Exudate", "T. Weissflogii 13C Exudate", "+5 µmol C/L Exudate", "+10 µmol C/L Exudate","+20 µmol C/L Exudate", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "W", "Whole Seawater","1.2", "1.2 µm Filtrate","NV", "1.2 µm Filtrate: TFF Filtrate (3:7)")
```

Cell biovolume was determined from 10 images captured with a digital camera (Retiga Exi-QImaging, Surrey, BC, Canada). Images were processed using ImageJ software according to established image analyses protocols (Baldwin and Bankston 1988; Sieracki et al. 1989, Ducklow et al., 1995).

```{r message = F}

biovol <- read_csv("~/naames_bioav_ms/Input/Biovolume_Summary.csv") %>% 
  select(Cruise:Timepoint, Biovol_Mean_All) %>% 
  rename(biovol = Biovol_Mean_All) %>% 
  mutate_at(vars(biovol), round, 3) %>% 
  mutate(phase = ifelse(Timepoint == 0, "initial", "later"),
         Station = gsub("2RD", "S2RD", Station),
         Station = gsub("2RF", "S2RF", Station)) %>% 
  group_by(Cruise, phase) %>% 
  mutate(mean_biovol = round(mean(biovol, na.rm = T),3),
         sd_biovol = round(sd(biovol, na.rm = T),3)) %>% 
  add_tally() %>% 
  rename(n_biovol = n) %>% 
  ungroup() 

biovol_table <- biovol %>% select(-c(Station:biovol)) %>% distinct()

```

```{r echo = FALSE, results = 'asis'}
kable(biovol_table, caption = "Mean Biovolume AT38, AT39; 'later' represents any timepoint after 0")
```

It would be good to see if there is a log-linear relationship between the cell carbon calculated from the GF75 POC data (fg C L^-1^) and the estimated biovolumes (µm^3^). Unfortunately we don't yet have concurrent measurements of GF75 POC data and biovolume at "stationary" so that will have to wait. We do have concurrent measurements at initial though, so we can plot those. 

```{r message = F, warning = F}
biovol_merge <- biovol %>% 
  filter(Timepoint == 0) %>% 
  select(Cruise:Bottle, biovol) %>% 
  rename(i.biovol = biovol) %>% 
  left_join(readRDS("~/naames_bioav_ms/Output/processed_bacterial_carbon.rds") %>% 
              select(Season:type, i.ccf.c1:i.ccf.c3) %>% 
              pivot_longer(cols = c(i.ccf.c1:i.ccf.c3), names_to = "correction", values_to = "ccf") %>% 
              group_by(Season, Station, Depth, Treatment, Bottle) %>% 
              mutate_at(vars(ccf), mean, na.rm = T) %>% 
              select(-correction) %>% 
              distinct(), .) %>% 
  left_join(., readRDS("~/naames_bioav_ms/Output/processed_bacterial_carbon.rds") %>% 
              select(Season:type, i.ccf.c1:i.ccf.c3) %>% 
              pivot_longer(cols = c(i.ccf.c1:i.ccf.c3), names_to = "correction", values_to = "sd_ccf") %>% 
              group_by(Season, Station, Depth, Treatment, Bottle) %>% 
              mutate_at(vars(sd_ccf), sd, na.rm = T) %>% 
              select(-correction) %>% 
              distinct()) 
  

biovol_x <-  seq(from = 0.01, to = 0.1, length.out = 11)
exports_y <-  87.4*(biovol_x^0.616)
simon_azam_y <-  92.0*(biovol_x^0.5985) #1989
gunderson_y <-  108.8*(biovol_x^0.898) #2002
malfatti_y <-  103.02*(biovol_x^0.59) #2002

lit_df <- data_frame(biovol_x, exports_y, simon_azam_y, gunderson_y, malfatti_y) 

ccf_biovol_plot.data <- biovol_merge  %>% 
  drop_na(i.biovol)  %>% 
  bind_cols(., lit_df) %>% 
  select(Season:Bottle, ccf, sd_ccf, i.biovol:malfatti_y)
```

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 9, fig.align = "center", warning = FALSE}
ccf_biovol_plot.data %>%  
ggplot(aes(x = i.biovol)) +
  geom_point(aes(y = ccf, fill = Season), shape = 21, color = "black", size = 4, alpha = 0.7 ) +
  geom_errorbar(aes(ymin = ccf - sd_ccf, ymax = ccf + sd_ccf, color = Season), width = 0.05, size = 0.2) +
  labs(x = expression(paste("Biovolume, µm"^-3)), y = expression(paste("Cellular C, fg C cell"^-1))) +
  scale_x_continuous(trans = 'log10', breaks = pretty_breaks(), limits = c(0.005, 0.09)) +
  scale_y_continuous(trans = 'log10', breaks = pretty_breaks(), limits = c(1, 90)) +
  scale_fill_manual(values = custom.colors) +
  scale_color_manual(values = custom.colors) +
  custom_theme_linedraw()  +
  geom_line(aes(x = biovol_x, y = exports_y)) + 
   geom_line(aes(x = biovol_x, y = simon_azam_y), linetype = 2, color = "#4DAF4A") +
    geom_line(aes(x = biovol_x, y = gunderson_y), linetype = 3, color = "#FF7F00") +
   geom_line(aes(x = biovol_x, y = malfatti_y), color = "#552583") +
  geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = exports_y, label = "EXPORTS")) +
  geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = simon_azam_y + 1, label = "Simon & Azam (1989)"), fill = "#4DAF4A") + 
   geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = gunderson_y, label = "Gunderson et al (2002)"), fill = "#FF7F00")  +
geom_label(data = filter(ccf_biovol_plot.data, biovol_x == 0.010), aes(x = biovol_x, y = malfatti_y + 2, label = "Malfatti (2009)"), fill = "#552583", color = "white")  
 
```

For the samples in which we have concurrent biovolume and cellular C measurements, we see that their relationship to one another is pretty widespread relative to published literature relationships. Using biovolumes for this dataset may not be the route to take. Error bars represent the standard deviations from the means of cell carbon estimated with different blank corrections.  





